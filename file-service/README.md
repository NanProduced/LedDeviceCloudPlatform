# File Service - æ–‡ä»¶æœåŠ¡æ¨¡å—

## ğŸ“‹ æ¦‚è¿°

File Service æ˜¯ LedDeviceCloudPlatform çš„æ ¸å¿ƒæ–‡ä»¶å¤„ç†æœåŠ¡ï¼Œä¸“ä¸ºLEDè®¾å¤‡å†…å®¹ç®¡ç†å¹³å°è®¾è®¡ã€‚åŸºäºDDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰åˆ†å±‚æ¶æ„ï¼Œæä¾›ä¼ä¸šçº§çš„æ–‡ä»¶ä¸Šä¼ ã€è§†é¢‘è½¬ç ã€å­˜å‚¨ç®¡ç†ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œæ”¯æ’‘LEDæ˜¾ç¤ºå†…å®¹çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

- **ğŸ¬ å¤šåª’ä½“å¤„ç†**: æ”¯æŒè§†é¢‘ã€å›¾ç‰‡ã€éŸ³é¢‘ç­‰å¤šç§æ ¼å¼çš„ä¸Šä¼ å’Œè½¬ç 
- **ğŸ“± LEDå†…å®¹ä¼˜åŒ–**: é’ˆå¯¹LEDæ˜¾ç¤ºå±ç‰¹ç‚¹è¿›è¡Œå†…å®¹æ ¼å¼ä¼˜åŒ–
- **ğŸš€ é«˜æ€§èƒ½å¤„ç†**: æ”¯æŒå¤§æ–‡ä»¶ä¸Šä¼ ã€GPUåŠ é€Ÿè½¬ç ã€å¹¶å‘å¤„ç†
- **â˜ï¸ äº‘å­˜å‚¨é›†æˆ**: æ— ç¼é›†æˆæœ¬åœ°å­˜å‚¨å’Œé˜¿é‡Œäº‘OSS
- **âš¡ å®æ—¶ç›‘æ§**: WebSocketå®æ—¶æ¨é€è½¬ç è¿›åº¦å’Œå¤„ç†çŠ¶æ€
- **ğŸ”’ å®‰å…¨å¯é **: å®Œæ•´çš„æƒé™æ§åˆ¶ã€æ–‡ä»¶éªŒè¯å’Œå®¡è®¡æ—¥å¿—

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### ğŸ“¤ æ–‡ä»¶ä¸Šä¼ æœåŠ¡
- **å•æ–‡ä»¶ä¸Šä¼ **: æ”¯æŒå¸¸è§æ–‡ä»¶æ ¼å¼çš„å¿«é€Ÿä¸Šä¼ 
- **æ‰¹é‡ä¸Šä¼ **: å¹¶å‘å¤„ç†å¤šä¸ªæ–‡ä»¶ï¼Œæé«˜ä¸Šä¼ æ•ˆç‡
- **åˆ†å—ä¸Šä¼ **: æ”¯æŒå¤§æ–‡ä»¶(5GB+)çš„æ–­ç‚¹ç»­ä¼ åŠŸèƒ½
- **ç§’ä¼ åŠŸèƒ½**: åŸºäºMD5å“ˆå¸Œçš„æ–‡ä»¶å»é‡ï¼Œé¿å…é‡å¤ä¸Šä¼ 
- **è¿›åº¦è·Ÿè¸ª**: å®æ—¶ç›‘æ§ä¸Šä¼ è¿›åº¦ï¼Œæ”¯æŒæš‚åœå’Œæ¢å¤
- **æ ¼å¼éªŒè¯**: è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶æ ¼å¼å’ŒMIMEç±»å‹
- **ç¼©ç•¥å›¾ç”Ÿæˆ**: è‡ªåŠ¨ä¸ºå›¾ç‰‡å’Œè§†é¢‘ç”Ÿæˆå¤šå°ºå¯¸é¢„è§ˆå›¾

### ğŸ¬ è§†é¢‘è½¬ç æœåŠ¡
- **FFmpegå¼•æ“**: é›†æˆä¸šç•Œæ ‡å‡†çš„FFmpegè½¬ç å¼•æ“
- **GPUåŠ é€Ÿ**: æ”¯æŒNVIDIA GPUç¡¬ä»¶åŠ é€Ÿè½¬ç 
- **å¤šæ ¼å¼è¾“å‡º**: æ”¯æŒH.264/H.265/VP9ç­‰ä¸»æµç¼–ç æ ¼å¼
- **é¢„è®¾é…ç½®**: å†…ç½®LEDæ˜¾ç¤ºä¼˜åŒ–çš„è½¬ç é¢„è®¾
- **å®æ—¶è¿›åº¦**: WebSocketæ¨é€è½¬ç è¿›åº¦å’Œæ€§èƒ½æŒ‡æ ‡
- **æ‰¹é‡è½¬ç **: æ”¯æŒé˜Ÿåˆ—åŒ–çš„æ‰¹é‡è§†é¢‘å¤„ç†
- **è´¨é‡ä¼˜åŒ–**: æ™ºèƒ½ç ç‡æ§åˆ¶å’Œç”»è´¨ä¼˜åŒ–
- **å¤±è´¥é‡è¯•**: è‡ªåŠ¨é‡è¯•æœºåˆ¶å’Œé”™è¯¯æ¢å¤

### ğŸ’¾ å­˜å‚¨ç®¡ç†æœåŠ¡
- **å¤šå­˜å‚¨æ”¯æŒ**: æœ¬åœ°å­˜å‚¨ + é˜¿é‡Œäº‘OSSåŒé‡æ”¯æŒ
- **æ™ºèƒ½é€‰æ‹©**: æ ¹æ®æ–‡ä»¶å¤§å°å’Œç±»å‹è‡ªåŠ¨é€‰æ‹©å­˜å‚¨ç­–ç•¥
- **ç‰ˆæœ¬ç®¡ç†**: å®Œæ•´çš„æ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶å’Œå†å²å›æ»š
- **ç”Ÿå‘½å‘¨æœŸ**: è‡ªåŠ¨åŒ–çš„æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **ç©ºé—´ç›‘æ§**: å®æ—¶ç›‘æ§å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
- **æ•°æ®åŒæ­¥**: æœ¬åœ°å’Œäº‘ç«¯å­˜å‚¨çš„æ™ºèƒ½åŒæ­¥

### ğŸ“Š æ–‡ä»¶ç®¡ç†API
- **æŸ¥è¯¢æ£€ç´¢**: æ”¯æŒå…³é”®è¯ã€æ ‡ç­¾ã€ç±»å‹ç­‰å¤šç»´åº¦æœç´¢
- **æ‰¹é‡æ“ä½œ**: æ‰¹é‡åˆ é™¤ã€ç§»åŠ¨ã€å¤åˆ¶ã€é‡å‘½åæ–‡ä»¶
- **æƒé™æ§åˆ¶**: åŸºäºç»„ç»‡å’Œç”¨æˆ·çš„ç»†ç²’åº¦è®¿é—®æ§åˆ¶
- **ç»Ÿè®¡æŠ¥å‘Š**: å­˜å‚¨ä½¿ç”¨é‡ã€è½¬ç ç»Ÿè®¡ç­‰æ•°æ®åˆ†æ
- **æ–‡ä»¶é¢„è§ˆ**: æ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€æ–‡æ¡£çš„åœ¨çº¿é¢„è§ˆ
- **ä¸‹è½½ç®¡ç†**: å®‰å…¨çš„æ–‡ä»¶ä¸‹è½½å’Œè®¿é—®æ§åˆ¶

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### DDDåˆ†å±‚æ¶æ„

```
file-service/
â”œâ”€â”€ file-api/          # APIå®šä¹‰å±‚ - æ¥å£å¥‘çº¦å’Œæ•°æ®ä¼ è¾“å¯¹è±¡
â”œâ”€â”€ file-application/  # åº”ç”¨æœåŠ¡å±‚ - ä¸šåŠ¡é€»è¾‘å’Œæµç¨‹ç¼–æ’  
â”œâ”€â”€ file-infrastructure/ # åŸºç¡€è®¾æ–½å±‚ - å¤–éƒ¨ç³»ç»Ÿé›†æˆå’ŒæŠ€æœ¯å®ç°
â””â”€â”€ file-boot/         # å¯åŠ¨é…ç½®å±‚ - Webç«¯ç‚¹å’Œåº”ç”¨é…ç½®
```

### æŠ€æœ¯æ ˆ

- **Spring Boot 3.3.11** - åŸºç¡€æ¡†æ¶
- **Spring Cloud 2023.0.5** - å¾®æœåŠ¡æ¡†æ¶
- **FFmpeg 4.4+** - è§†é¢‘è½¬ç å¼•æ“
- **Alibaba Cloud OSS** - äº‘å­˜å‚¨æœåŠ¡
- **Spring WebSocket** - å®æ—¶è¿›åº¦æ¨é€
- **MyBatis Plus 3.5.9** - æ•°æ®è®¿é—®æ¡†æ¶
- **Redis 6.0+** - ç¼“å­˜å’Œè¿›åº¦å­˜å‚¨
- **MongoDB** - æ–‡ä»¶å…ƒæ•°æ®å­˜å‚¨
- **RabbitMQ** - å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—

## ğŸ“‚ æ¨¡å—ç»“æ„è¯¦è§£

### 1. file-api - APIå®šä¹‰æ¨¡å— âœ…

```
file-api/
â”œâ”€â”€ FileUploadApi.java         # æ–‡ä»¶ä¸Šä¼ APIæ¥å£
â”œâ”€â”€ TranscodingApi.java        # è§†é¢‘è½¬ç APIæ¥å£  
â”œâ”€â”€ FileManagementApi.java     # æ–‡ä»¶ç®¡ç†APIæ¥å£
â””â”€â”€ dto/                       # æ•°æ®ä¼ è¾“å¯¹è±¡(47ä¸ªDTOç±»)
    â”œâ”€â”€ FileUploadRequest.java     # æ–‡ä»¶ä¸Šä¼ è¯·æ±‚
    â”œâ”€â”€ FileUploadResponse.java    # æ–‡ä»¶ä¸Šä¼ å“åº”
    â”œâ”€â”€ TranscodingTaskRequest.java # è½¬ç ä»»åŠ¡è¯·æ±‚
    â”œâ”€â”€ TranscodingProgressResponse.java # è½¬ç è¿›åº¦å“åº”
    â”œâ”€â”€ ChunkUpload*.java          # åˆ†å—ä¸Šä¼ ç›¸å…³DTO
    â”œâ”€â”€ BatchOperation*.java       # æ‰¹é‡æ“ä½œç›¸å…³DTO
    â”œâ”€â”€ FileStatistics*.java       # ç»Ÿè®¡åˆ†æç›¸å…³DTO
    â””â”€â”€ ...                        # å…¶ä»–DTOç±»
```

**å½“å‰çŠ¶æ€**: âœ… **å·²å®Œæˆ** - 3ä¸ªä¸»è¦APIæ¥å£å’Œ47ä¸ªDTOç±»å…¨éƒ¨å®ç°

**èŒè´£**: 
- å®šä¹‰å¯¹å¤–REST APIæ¥å£å¥‘çº¦
- æ•°æ®ä¼ è¾“å¯¹è±¡å’Œå‚æ•°éªŒè¯
- Swagger APIæ–‡æ¡£æ³¨è§£
- ç»Ÿä¸€å“åº”æ ¼å¼å°è£…

### 2. file-application - åº”ç”¨æœåŠ¡å±‚ âš ï¸

```
file-application/
â”œâ”€â”€ service/                   # ä¸šåŠ¡æœåŠ¡æ¥å£
â”‚   â”œâ”€â”€ FileUploadService.java      # æ–‡ä»¶ä¸Šä¼ æœåŠ¡æ¥å£
â”‚   â”œâ”€â”€ TranscodingService.java     # è½¬ç æœåŠ¡æ¥å£
â”‚   â”œâ”€â”€ StorageService.java         # å­˜å‚¨æœåŠ¡æ¥å£ [å¾…å®ç°]
â”‚   â”œâ”€â”€ FileValidationService.java  # æ–‡ä»¶éªŒè¯æœåŠ¡æ¥å£ [å¾…å®ç°]
â”‚   â”œâ”€â”€ ProgressTrackingService.java # è¿›åº¦è·Ÿè¸ªæœåŠ¡æ¥å£ [å¾…å®ç°]
â”‚   â”œâ”€â”€ ThumbnailService.java       # ç¼©ç•¥å›¾æœåŠ¡æ¥å£ [å¾…å®ç°]
â”‚   â””â”€â”€ impl/                       # æœåŠ¡å®ç°ç±»
â”‚       â”œâ”€â”€ FileUploadServiceImpl.java # æ–‡ä»¶ä¸Šä¼ æœåŠ¡å®ç° [æ¡†æ¶å®Œæˆ]
â”‚       â””â”€â”€ TranscodingServiceImpl.java # è½¬ç æœåŠ¡å®ç° [å¾…å®ç°]
â”œâ”€â”€ domain/                    # é¢†åŸŸæ¨¡å‹ [å¾…å®ç°]
â”‚   â”œâ”€â”€ FileInfo.java              # æ–‡ä»¶ä¿¡æ¯èšåˆæ ¹
â”‚   â”œâ”€â”€ TranscodingTask.java       # è½¬ç ä»»åŠ¡å®ä½“
â”‚   â””â”€â”€ StorageLocation.java       # å­˜å‚¨ä½ç½®å€¼å¯¹è±¡
â””â”€â”€ repository/                # ä»“å‚¨æ¥å£ [å¾…å®ç°]
    â”œâ”€â”€ FileInfoRepository.java    # æ–‡ä»¶ä¿¡æ¯ä»“å‚¨
    â””â”€â”€ TranscodingTaskRepository.java # è½¬ç ä»»åŠ¡ä»“å‚¨
```

**å½“å‰çŠ¶æ€**: âš ï¸ **æ¡†æ¶å®Œæˆ** - æœåŠ¡æ¥å£å®šä¹‰ï¼Œå®ç°ç±»éœ€å®Œå–„

**å¾…å®Œæˆä»»åŠ¡**:
- [ ] å®ç°4ä¸ªæ ¸å¿ƒä¾èµ–æœåŠ¡æ¥å£
- [ ] åˆ›å»ºFileInfoç­‰é¢†åŸŸå¯¹è±¡
- [ ] åˆ›å»ºRepositoryæ¥å£å®šä¹‰
- [ ] å®ŒæˆTranscodingServiceImplå®ç°

### 3. file-infrastructure - åŸºç¡€è®¾æ–½å±‚ âš¡

```
file-infrastructure/
â”œâ”€â”€ transcoding/               # è½¬ç å¼•æ“ âœ…
â”‚   â””â”€â”€ FFmpegTranscoder.java       # FFmpegè½¬ç å™¨å®ç°
â”œâ”€â”€ progress/                  # è¿›åº¦ç®¡ç† âœ…  
â”‚   â”œâ”€â”€ TranscodingProgressWebSocketHandler.java # WebSocketè¿›åº¦å¤„ç†å™¨
â”‚   â””â”€â”€ StompProgressNotifier.java # STOMPè¿›åº¦é€šçŸ¥å™¨
â”œâ”€â”€ storage/                   # å­˜å‚¨å®ç° [å¾…å®ç°]
â”‚   â”œâ”€â”€ LocalStorageProvider.java   # æœ¬åœ°å­˜å‚¨æä¾›è€…
â”‚   â”œâ”€â”€ OssStorageProvider.java     # OSSå­˜å‚¨æä¾›è€…
â”‚   â””â”€â”€ StorageStrategy.java        # å­˜å‚¨ç­–ç•¥
â”œâ”€â”€ repository/                # æ•°æ®è®¿é—® [å¾…å®ç°]
â”‚   â”œâ”€â”€ FileInfoRepositoryImpl.java # æ–‡ä»¶ä¿¡æ¯ä»“å‚¨å®ç°
â”‚   â””â”€â”€ mybatis/                    # MyBatisæ˜ å°„é…ç½®
â””â”€â”€ config/                    # åŸºç¡€è®¾æ–½é…ç½® [å¾…å®ç°]
    â”œâ”€â”€ StorageConfig.java          # å­˜å‚¨é…ç½®
    â”œâ”€â”€ TranscodingConfig.java      # è½¬ç é…ç½®
    â””â”€â”€ CacheConfig.java            # ç¼“å­˜é…ç½®
```

**å½“å‰çŠ¶æ€**: âš¡ **éƒ¨åˆ†å®Œæˆ** - è½¬ç å¼•æ“å’Œè¿›åº¦æ¨é€å·²å®ç°

**å·²å®Œæˆç»„ä»¶**:
- âœ… FFmpegè½¬ç å¼•æ“ - å®Œæ•´çš„è§†é¢‘è½¬ç åŠŸèƒ½
- âœ… WebSocketè¿›åº¦æ¨é€ - å®æ—¶è½¬ç è¿›åº¦ç›‘æ§
- âœ… STOMPè¿›åº¦é€šçŸ¥ - é›†æˆæ¶ˆæ¯æœåŠ¡æ¨é€

**å¾…å®Œæˆä»»åŠ¡**:
- [ ] å­˜å‚¨æœåŠ¡æä¾›è€…å®ç°
- [ ] æ•°æ®è®¿é—®å±‚Repositoryå®ç°
- [ ] ç¼“å­˜å’Œé…ç½®ç®¡ç†ç»„ä»¶

### 4. file-boot - å¯åŠ¨é…ç½®å±‚ ğŸ”§

```
file-boot/
â”œâ”€â”€ FileServiceApplication.java # åº”ç”¨å¯åŠ¨ç±» âœ…
â”œâ”€â”€ config/                     # é…ç½®ç±» [éƒ¨åˆ†å®Œæˆ]
â”‚   â”œâ”€â”€ WebSocketConfig.java         # WebSocketé…ç½® âœ…
â”‚   â”œâ”€â”€ StorageConfig.java           # å­˜å‚¨é…ç½® [å¾…å®ç°]
â”‚   â”œâ”€â”€ TranscodingConfig.java       # è½¬ç é…ç½® [å¾…å®ç°]
â”‚   â””â”€â”€ AsyncConfig.java             # å¼‚æ­¥ä»»åŠ¡é…ç½® [å¾…å®ç°]
â”œâ”€â”€ controller/                 # RESTæ§åˆ¶å™¨ [å¾…å®ç°]
â”‚   â”œâ”€â”€ FileUploadController.java    # æ–‡ä»¶ä¸Šä¼ æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ TranscodingController.java   # è½¬ç æ§åˆ¶å™¨
â”‚   â””â”€â”€ FileManagementController.java # æ–‡ä»¶ç®¡ç†æ§åˆ¶å™¨
â””â”€â”€ resources/                  # é…ç½®èµ„æº
    â”œâ”€â”€ application.yml              # ä¸»é…ç½®æ–‡ä»¶ âœ…
    â”œâ”€â”€ application-dev.yml          # å¼€å‘ç¯å¢ƒé…ç½® âœ…
    â””â”€â”€ static/                      # é™æ€èµ„æº
        â””â”€â”€ transcoding-progress.html # è½¬ç è¿›åº¦ç›‘æ§é¡µé¢ âœ…
```

**å½“å‰çŠ¶æ€**: ğŸ”§ **åŸºç¡€å®Œæˆ** - å¯åŠ¨ç±»å’ŒåŸºæœ¬é…ç½®å·²å®ç°

**å¾…å®Œæˆä»»åŠ¡**:
- [ ] åˆ›å»º3ä¸ªä¸»è¦RESTæ§åˆ¶å™¨
- [ ] å®Œå–„é…ç½®ç±»å’Œæ•°æ®åº“é…ç½®
- [ ] æ·»åŠ å¼‚æ­¥ä»»åŠ¡å’Œç¼“å­˜é…ç½®

## ğŸ¬ è½¬ç å¼•æ“ç‰¹æ€§

### FFmpegé›†æˆç‰¹æ€§

```java
// GPUåŠ é€Ÿè½¬ç é…ç½®
TranscodingConfig config = TranscodingConfig.builder()
    .enableGpuAcceleration(true)
    .videoCodec("h264_nvenc")  // NVIDIA GPUç¼–ç 
    .resolution("1920x1080")
    .bitrate(2000)
    .frameRate(30)
    .build();

// å®æ—¶è¿›åº¦å›è°ƒ
FFmpegTranscoder transcoder = new FFmpegTranscoder();
TranscodingResult result = transcoder.transcode(
    inputPath, outputPath, config,
    progress -> {
        // å®æ—¶è¿›åº¦å›è°ƒï¼Œé€šè¿‡WebSocketæ¨é€
        progressHandler.broadcastProgress(taskId, progress);
    }
);
```

### æ”¯æŒçš„è½¬ç æ ¼å¼

| è¾“å…¥æ ¼å¼ | è¾“å‡ºæ ¼å¼ | ç¼–ç å™¨ | ç‰¹ç‚¹ |
|---------|---------|-------|------|
| MP4, AVI, MOV | MP4 | H.264/H.265 | é«˜å…¼å®¹æ€§ï¼Œé€‚åˆLEDæ’­æ”¾ |
| MKV, WEBM | WEBM | VP8/VP9 | å¼€æºæ ¼å¼ï¼Œè´¨é‡ä¼˜ç§€ |
| å„ç§æ ¼å¼ | HLS | H.264 | æµåª’ä½“æ ¼å¼ï¼Œæ”¯æŒè‡ªé€‚åº”ç ç‡ |

### è½¬ç é¢„è®¾é…ç½®

| é¢„è®¾å | åˆ†è¾¨ç‡ | ç ç‡ | å¸§ç‡ | é€‚ç”¨åœºæ™¯ |
|--------|--------|------|------|---------|
| LED_HD | 1920x1080 | 2000kbps | 30fps | é«˜æ¸…LEDå¤§å± |
| LED_FHD | 1920x1080 | 4000kbps | 60fps | è¶…é«˜æ¸…LEDæ˜¾ç¤º |
| LED_4K | 3840x2160 | 8000kbps | 30fps | 4K LEDæ˜¾ç¤ºå± |
| WEB_PREVIEW | 1280x720 | 1000kbps | 25fps | Webé¢„è§ˆæ’­æ”¾ |

## ğŸ”Œ å®æ—¶è¿›åº¦ç›‘æ§

### WebSocketè¿›åº¦æ¨é€

```javascript
// è¿æ¥è½¬ç è¿›åº¦WebSocket
const socket = new WebSocket('ws://localhost:8085/file/progress');

// è®¢é˜…è½¬ç ä»»åŠ¡è¿›åº¦
const subscribeMessage = {
    action: 'SUBSCRIBE',
    taskId: 'transcode_12345'
};
socket.send(JSON.stringify(subscribeMessage));

// æ¥æ”¶å®æ—¶è¿›åº¦æ›´æ–°
socket.onmessage = function(event) {
    const progressData = JSON.parse(event.data);
    if (progressData.type === 'PROGRESS') {
        updateProgressBar(progressData.data.progress);
        updateProcessingInfo(progressData.data);
    }
};
```

### è¿›åº¦æ•°æ®æ ¼å¼

```json
{
    "type": "PROGRESS",
    "taskId": "transcode_12345",
    "data": {
        "progress": 75,
        "status": "PROCESSING",
        "fps": 30.5,
        "processedDuration": 180,
        "totalDuration": 240,
        "estimatedTimeRemaining": 60,
        "currentTime": "00:03:00",
        "frameCount": 5400,
        "outputFileSize": 25165824,
        "bitrate": 2048,
        "qualityScore": 0.95
    },
    "timestamp": 1703568000000
}
```

## ğŸ“Š APIæ¥å£æ¦‚è§ˆ

### æ–‡ä»¶ä¸Šä¼ API

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | ç¤ºä¾‹ |
|------|------|------|------|
| `/file/upload/single` | POST | å•æ–‡ä»¶ä¸Šä¼  | ä¸Šä¼ å•ä¸ªè§†é¢‘æ–‡ä»¶ |
| `/file/upload/batch` | POST | æ‰¹é‡æ–‡ä»¶ä¸Šä¼  | åŒæ—¶ä¸Šä¼ å¤šä¸ªå›¾ç‰‡ |
| `/file/upload/chunk/init` | POST | åˆå§‹åŒ–åˆ†å—ä¸Šä¼  | å¤§æ–‡ä»¶åˆ†å—ä¸Šä¼ å‡†å¤‡ |
| `/file/upload/chunk/{chunkNumber}` | POST | ä¸Šä¼ æ–‡ä»¶åˆ†å— | ä¸Šä¼ ç¬¬Nä¸ªæ–‡ä»¶å— |
| `/file/upload/chunk/complete` | POST | å®Œæˆåˆ†å—ä¸Šä¼  | åˆå¹¶æ‰€æœ‰åˆ†å— |
| `/file/upload/progress/{uploadId}` | GET | æŸ¥è¯¢ä¸Šä¼ è¿›åº¦ | è·å–ä¸Šä¼ çŠ¶æ€ |

### è§†é¢‘è½¬ç API

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | ç¤ºä¾‹ |
|------|------|------|------|
| `/file/transcoding/submit` | POST | æäº¤è½¬ç ä»»åŠ¡ | è½¬ç è§†é¢‘ä¸ºLEDæ ¼å¼ |
| `/file/transcoding/batch` | POST | æ‰¹é‡è½¬ç ä»»åŠ¡ | æ‰¹é‡å¤„ç†å¤šä¸ªè§†é¢‘ |
| `/file/transcoding/progress/{taskId}` | GET | æŸ¥è¯¢è½¬ç è¿›åº¦ | è·å–è½¬ç çŠ¶æ€ |
| `/file/transcoding/cancel/{taskId}` | DELETE | å–æ¶ˆè½¬ç ä»»åŠ¡ | åœæ­¢è½¬ç å¤„ç† |
| `/file/transcoding/presets` | GET | è·å–è½¬ç é¢„è®¾ | æŸ¥çœ‹å¯ç”¨é¢„è®¾é…ç½® |
| `/file/transcoding/queue/status` | GET | æŸ¥è¯¢é˜Ÿåˆ—çŠ¶æ€ | æŸ¥çœ‹è½¬ç é˜Ÿåˆ—æƒ…å†µ |

### æ–‡ä»¶ç®¡ç†API

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | ç¤ºä¾‹ |
|------|------|------|------|
| `/file/management/info/{fileId}` | GET | è·å–æ–‡ä»¶ä¿¡æ¯ | æŸ¥çœ‹æ–‡ä»¶è¯¦æƒ… |
| `/file/management/list` | GET | æ–‡ä»¶åˆ—è¡¨æŸ¥è¯¢ | åˆ†é¡µæŸ¥è¯¢æ–‡ä»¶ |
| `/file/management/search` | POST | æ–‡ä»¶æœç´¢ | å…³é”®è¯æœç´¢æ–‡ä»¶ |
| `/file/management/download/{fileId}` | GET | ä¸‹è½½æ–‡ä»¶ | ä¸‹è½½åŸå§‹æ–‡ä»¶ |
| `/file/management/preview/{fileId}` | GET | æ–‡ä»¶é¢„è§ˆ | è·å–é¢„è§ˆURL |
| `/file/management/batch` | POST | æ‰¹é‡æ“ä½œ | æ‰¹é‡åˆ é™¤/ç§»åŠ¨æ–‡ä»¶ |

## ğŸ”§ é…ç½®è¯´æ˜

### åº”ç”¨é…ç½®

- **æœåŠ¡ç«¯å£**: 8085
- **æœåŠ¡å**: file-service
- **WebSocketç«¯ç‚¹**: `/file/progress`
- **ç®¡ç†ç«¯ç‚¹**: `/actuator`

### å­˜å‚¨é…ç½®

```yaml
# å­˜å‚¨ç­–ç•¥é…ç½®
file:
  storage:
    strategy: AUTO  # AUTO, LOCAL, OSS
    local:
      base-path: /data/files
      temp-path: /data/temp
    oss:
      endpoint: https://oss-cn-hangzhou.aliyuncs.com
      bucket: led-platform-files
      access-key: ${OSS_ACCESS_KEY}
      secret-key: ${OSS_SECRET_KEY}
```

### è½¬ç é…ç½®

```yaml
# è½¬ç å¼•æ“é…ç½®  
file:
  transcoding:
    ffmpeg-path: /usr/local/bin/ffmpeg
    temp-directory: /data/temp/transcoding
    max-concurrent-tasks: 3
    enable-gpu: true
    gpu-device: 0
    default-preset: LED_HD
```

### ä¸Šä¼ é™åˆ¶é…ç½®

```yaml
# æ–‡ä»¶ä¸Šä¼ é…ç½®
spring:
  servlet:
    multipart:
      max-file-size: 5GB
      max-request-size: 5GB
      
file:
  upload:
    chunk-size: 5MB
    max-chunks: 1000
    allowed-types:
      - video/mp4
      - video/avi
      - image/jpeg
      - image/png
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒå‡†å¤‡

```bash
# 1. å®‰è£…FFmpeg (å¸¦GPUæ”¯æŒ)
sudo apt update
sudo apt install ffmpeg nvidia-cuda-toolkit

# 2. é…ç½®é˜¿é‡Œäº‘OSS (å¯é€‰)
export OSS_ACCESS_KEY="your-access-key"
export OSS_SECRET_KEY="your-secret-key"

# 3. å¯åŠ¨ä¾èµ–æœåŠ¡
# - Nacos (192.168.1.185:8848)
# - Redis (192.168.1.185:6379)
# - MySQL (192.168.1.185:3306)
```

### å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘ç¯å¢ƒå¯åŠ¨
mvn spring-boot:run -pl file-service/file-boot

# ç”Ÿäº§ç¯å¢ƒå¯åŠ¨
mvn clean package -pl file-service
java -jar file-service/file-boot/target/file-boot-1.0-SNAPSHOT.jar

# Dockerå¯åŠ¨
docker run -d \
  --name file-service \
  -p 8085:8085 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -v /data/files:/data/files \
  file-service:latest
```

### éªŒè¯æœåŠ¡

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8085/actuator/health

# è®¿é—®è½¬ç è¿›åº¦ç›‘æ§é¡µé¢
open http://localhost:8085/transcoding-progress.html

# æµ‹è¯•æ–‡ä»¶ä¸Šä¼ API (éœ€è¦å…ˆå®ç°æ§åˆ¶å™¨)
curl -X POST http://localhost:8085/file/upload/single \
  -H "Content-Type: multipart/form-data" \
  -F "file=@test-video.mp4" \
  -F "organizationId=org123"
```

## ğŸ“Š ç›‘æ§å’Œè¿ç»´

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

- **åº”ç”¨å¥åº·**: `/actuator/health`
- **è½¬ç é˜Ÿåˆ—çŠ¶æ€**: `/actuator/metrics`
- **å­˜å‚¨ç©ºé—´ç›‘æ§**: `/file/management/storage/status`
- **ç³»ç»Ÿæ€§èƒ½**: `/actuator/prometheus`

### å…³é”®æ€§èƒ½æŒ‡æ ‡

```yaml
# ç›‘æ§æŒ‡æ ‡
file.upload.active.count      # æ´»è·ƒä¸Šä¼ ä»»åŠ¡æ•°
file.upload.success.rate      # ä¸Šä¼ æˆåŠŸç‡
transcoding.queue.size        # è½¬ç é˜Ÿåˆ—é•¿åº¦
transcoding.processing.count  # æ­£åœ¨å¤„ç†çš„è½¬ç ä»»åŠ¡
storage.usage.local          # æœ¬åœ°å­˜å‚¨ä½¿ç”¨é‡
storage.usage.oss            # OSSå­˜å‚¨ä½¿ç”¨é‡
ffmpeg.gpu.utilization       # GPUä½¿ç”¨ç‡
websocket.progress.connections # è¿›åº¦ç›‘æ§è¿æ¥æ•°
```

### æ—¥å¿—é…ç½®

```yaml
logging.level:
  org.nan.cloud.file: DEBUG
  org.nan.cloud.file.infrastructure.transcoding: INFO
  org.nan.cloud.file.infrastructure.progress: DEBUG
```

## ğŸ§ª æµ‹è¯•å’Œè°ƒè¯•

### åŠŸèƒ½æµ‹è¯•

#### è½¬ç è¿›åº¦ç›‘æ§æµ‹è¯•
è®¿é—® `http://localhost:8085/transcoding-progress.html` è¿›è¡ŒWebSocketè½¬ç è¿›åº¦æµ‹è¯•

#### APIæ¥å£æµ‹è¯•

```bash
# æµ‹è¯•æ–‡ä»¶ä¸Šä¼  (éœ€è¦å…ˆå®ç°æ§åˆ¶å™¨)
curl -X POST http://localhost:8085/file/upload/single \
  -F "file=@sample-video.mp4" \
  -F "organizationId=test-org"

# æµ‹è¯•è½¬ç ä»»åŠ¡æäº¤
curl -X POST http://localhost:8085/file/transcoding/submit \
  -H "Content-Type: application/json" \
  -d '{
    "fileId": "file123",
    "preset": "LED_HD",
    "outputFormat": "mp4",
    "organizationId": "test-org"
  }'

# æŸ¥è¯¢è½¬ç è¿›åº¦
curl http://localhost:8085/file/transcoding/progress/task123
```

### æ€§èƒ½æµ‹è¯•

```bash
# å¹¶å‘ä¸Šä¼ æµ‹è¯•
for i in {1..10}; do
  curl -X POST http://localhost:8085/file/upload/single \
    -F "file=@test-file-$i.mp4" &
done

# è½¬ç æ€§èƒ½æµ‹è¯•
curl -X POST http://localhost:8085/file/transcoding/batch \
  -H "Content-Type: application/json" \
  -d '{
    "tasks": [
      {"fileId": "file1", "preset": "LED_HD"},
      {"fileId": "file2", "preset": "LED_FHD"}
    ]
  }'
```

## ğŸ“‹ å¾…å®Œæˆä»»åŠ¡æ¸…å•

### ğŸ”¥ é«˜ä¼˜å…ˆçº§ (è¿è¡Œå¿…éœ€)

1. **æ ¸å¿ƒæœåŠ¡å®ç°**
   - [ ] StorageService - å­˜å‚¨æœåŠ¡å®ç°
   - [ ] FileValidationService - æ–‡ä»¶éªŒè¯æœåŠ¡
   - [ ] ProgressTrackingService - è¿›åº¦è·Ÿè¸ªæœåŠ¡
   - [ ] ThumbnailService - ç¼©ç•¥å›¾ç”ŸæˆæœåŠ¡

2. **æ•°æ®è®¿é—®å±‚**
   - [ ] FileInfoé¢†åŸŸå¯¹è±¡åˆ›å»º
   - [ ] FileInfoRepositoryæ¥å£å’Œå®ç°
   - [ ] æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡

3. **Webæ§åˆ¶å™¨å±‚**
   - [ ] FileUploadControllerå®ç°
   - [ ] TranscodingControllerå®ç°  
   - [ ] FileManagementControllerå®ç°

### âš¡ ä¸­ä¼˜å…ˆçº§ (åŠŸèƒ½å®Œå–„)

4. **ä¸šåŠ¡æœåŠ¡å®Œå–„**
   - [ ] TranscodingServiceImplå®Œæ•´å®ç°
   - [ ] å¼‚æ­¥ä»»åŠ¡é…ç½®å’Œé˜Ÿåˆ—ç®¡ç†
   - [ ] æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†

5. **é…ç½®å’Œé›†æˆ**
   - [ ] æ•°æ®åº“è¿æ¥æ± é…ç½®
   - [ ] Redisç¼“å­˜é…ç½®
   - [ ] OSSå­˜å‚¨é›†æˆé…ç½®

### ğŸ“ ä½ä¼˜å…ˆçº§ (è´¨é‡æå‡)

6. **æµ‹è¯•å’Œæ–‡æ¡£**
   - [ ] å•å…ƒæµ‹è¯•ç¼–å†™
   - [ ] é›†æˆæµ‹è¯•è¦†ç›–
   - [ ] APIæ–‡æ¡£å®Œå–„

7. **æ€§èƒ½ä¼˜åŒ–**
   - [ ] å¤§æ–‡ä»¶å¤„ç†ä¼˜åŒ–
   - [ ] è½¬ç é˜Ÿåˆ—ä¼˜åŒ–
   - [ ] ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

## ğŸš¨ å¸¸è§é—®é¢˜æ’æŸ¥

### è½¬ç ç›¸å…³é—®é¢˜

1. **FFmpegæœªæ‰¾åˆ°**
   ```bash
   # æ£€æŸ¥FFmpegå®‰è£…
   which ffmpeg
   ffmpeg -version
   
   # å®‰è£…FFmpeg
   sudo apt install ffmpeg
   ```

2. **GPUåŠ é€Ÿå¤±è´¥**
   ```bash
   # æ£€æŸ¥NVIDIAé©±åŠ¨
   nvidia-smi
   
   # æ£€æŸ¥CUDAæ”¯æŒ
   ffmpeg -hwaccels
   ```

3. **è½¬ç ä»»åŠ¡å¤±è´¥**
   ```bash
   # æŸ¥çœ‹è½¬ç æ—¥å¿—
   grep "FFmpeg" logs/file-service.log
   
   # æ£€æŸ¥ä¸´æ—¶ç›®å½•æƒé™
   ls -la /data/temp/transcoding
   ```

### å­˜å‚¨ç›¸å…³é—®é¢˜

1. **æœ¬åœ°å­˜å‚¨ç©ºé—´ä¸è¶³**
   ```bash
   # æ£€æŸ¥ç£ç›˜ç©ºé—´
   df -h /data/files
   
   # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
   find /data/temp -type f -mtime +1 -delete
   ```

2. **OSSè¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥ç½‘ç»œè¿æ¥
   ping oss-cn-hangzhou.aliyuncs.com
   
   # éªŒè¯è®¿é—®å¯†é’¥
   curl -H "Authorization: OSS your-access-key:signature" \
        https://your-bucket.oss-cn-hangzhou.aliyuncs.com/
   ```

## ğŸ“ ç‰ˆæœ¬è§„åˆ’

### v1.1.0 (å½“å‰å¼€å‘ç‰ˆ)
- [ ] å®Œæˆæ ¸å¿ƒåŠŸèƒ½å®ç°
- [ ] åŸºç¡€REST APIä¸Šçº¿  
- [ ] å•æœºç‰ˆæœ¬è½¬ç æ”¯æŒ

### v1.2.0 (è®¡åˆ’ä¸­)
- [ ] é›†ç¾¤éƒ¨ç½²æ”¯æŒ
- [ ] é«˜å¯ç”¨è½¬ç é˜Ÿåˆ—
- [ ] æ™ºèƒ½å­˜å‚¨ç­–ç•¥

### v2.0.0 (è¿œæœŸç›®æ ‡)
- [ ] AIè¾…åŠ©å†…å®¹ä¼˜åŒ–
- [ ] è·¨åœ°åŸŸå­˜å‚¨åŒæ­¥
- [ ] å¤§è§„æ¨¡å¹¶å‘å¤„ç†

---

**åˆ›å»ºæ—¥æœŸ**: 2025å¹´7æœˆ26æ—¥  
**ç»´æŠ¤å›¢é˜Ÿ**: LedDeviceCloudPlatformå¼€å‘ç»„  
**ç‰ˆæœ¬**: v1.0.0 (åˆå§‹ç‰ˆæœ¬)  
**çŠ¶æ€**: ğŸš§ å¼€å‘ä¸­ - APIå±‚å®Œæˆï¼Œå®ç°å±‚å¾…å®Œå–„