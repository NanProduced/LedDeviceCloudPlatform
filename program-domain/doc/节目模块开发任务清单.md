# 节目管理模块开发任务清单

## 开发优先级说明
- **P0**: 核心功能，必须优先完成
- **P1**: 重要功能，次优先级 
- **P2**: 增强功能，后续迭代

## 架构说明
本项目采用分层架构开发：
1. **program-domain**: 共享数据模型模块，纯数据结构定义
2. **core-service**: 业务逻辑实现，依赖program-domain
3. **file-service**: VSN文件处理，依赖program-domain

## 第一阶段：program-domain模块完善 (Data Model Layer)

### P0-1. 完善Entity类 - 补充缺失字段
- **任务**: 完善ProgramDO，添加VSN相关字段
- **文件**: `program-domain/src/main/java/org/nan/cloud/program/entity/ProgramDO.java`
- **实现内容**:
  - 添加VSN文件ID、路径字段
  - 添加VSN生成状态枚举字段
  - 添加VSN生成错误信息字段
  - 确保字段映射和注解正确
- **依赖**: 现有ProgramDO基础
- **预估工时**: 2小时

### P0-2. 补充枚举类定义
- **任务**: 添加VSN生成状态枚举和完善现有枚举
- **文件**: `program-domain/src/main/java/org/nan/cloud/program/enums/VsnGenerationStatusEnum.java`
- **实现内容**:
  - 定义VSN生成状态：PENDING, PROCESSING, COMPLETED, FAILED
  - 确保所有枚举类完整且一致
- **依赖**: 现有枚举基础
- **预估工时**: 1小时

### P0-3. 补充草稿管理DTO
- **任务**: 添加草稿相关的请求响应DTO
- **文件**: 
  - `program-domain/src/main/java/org/nan/cloud/program/dto/request/SaveDraftRequest.java`
  - `program-domain/src/main/java/org/nan/cloud/program/dto/request/UpdateDraftRequest.java`
  - `program-domain/src/main/java/org/nan/cloud/program/dto/response/DraftDTO.java`
- **实现内容**:
  - 草稿保存请求DTO
  - 草稿更新请求DTO  
  - 草稿响应DTO
  - 基于草稿创建正式节目的DTO
- **依赖**: 现有DTO基础
- **预估工时**: 2小时

### P0-4. 验证VSN映射类完整性
- **任务**: 检查并完善VSN相关的映射类
- **文件**: `program-domain/src/main/java/org/nan/cloud/program/vsn/` 目录下所有类
- **实现内容**:
  - 确保所有VSN规范对象都有对应的Java类
  - 验证字段映射的完整性和正确性
  - 添加缺失的VSN对象模型
- **依赖**: 现有VSN类基础和VSN规范文档
- **预估工时**: 3小时

## 第二阶段：core-service业务逻辑实现 (Service Layer in core-service)

### P0-5. Repository层实现 (在core-service中)
- **任务**: 在core-service中创建Repository层，使用program-domain的实体
- **文件**: 
  - `core-service/core-infrastructure/src/main/java/org/nan/cloud/core/repository/ProgramRepository.java`
  - `core-service/core-infrastructure/src/main/java/org/nan/cloud/core/repository/ProgramMaterialRefRepository.java`
  - `core-service/core-infrastructure/src/main/java/org/nan/cloud/core/repository/ProgramApprovalRepository.java`
  - `core-service/core-infrastructure/src/main/java/org/nan/cloud/core/repository/ProgramContentRepository.java`
- **实现内容**:
  - MySQL和MongoDB的数据访问接口
  - 基础CRUD操作
  - 版本控制相关查询
  - 草稿状态的特殊查询逻辑
- **依赖**: program-domain的Entity和Document类
- **预估工时**: 6小时

### P0-6. 节目管理核心服务 (在core-service中)
- **任务**: 在core-service中创建节目管理Service层
- **文件**: 
  - `core-service/core-application/src/main/java/org/nan/cloud/core/service/ProgramService.java`
  - `core-service/core-application/src/main/java/org/nan/cloud/core/service/impl/ProgramServiceImpl.java`
  - `core-service/core-application/src/main/java/org/nan/cloud/core/service/ProgramDraftService.java`
  - `core-service/core-application/src/main/java/org/nan/cloud/core/service/impl/ProgramDraftServiceImpl.java`
- **实现内容**:
  - 节目创建的完整业务流程
  - 草稿管理的完整业务逻辑
  - 节目更新和版本递增逻辑  
  - 节目查询和分页处理
  - 节目删除和状态管理
  - 素材依赖关系验证
- **依赖**: Repository层和program-domain
- **预估工时**: 10小时

### P0-7. 版本控制和素材依赖服务 (在core-service中)
- **任务**: 实现版本控制和素材依赖管理
- **文件**: 
  - `core-service/core-application/src/main/java/org/nan/cloud/core/service/ProgramVersionService.java`
  - `core-service/core-application/src/main/java/org/nan/cloud/core/service/MaterialDependencyService.java`
- **实现内容**:
  - 版本号自动递增逻辑（草稿不参与）
  - 历史版本查询和管理
  - 从JSON中提取素材引用
  - 验证素材存在性和可用性
  - 建立素材引用关系
- **依赖**: Repository层和素材管理接口
- **预估工时**: 6小时

## 第三阶段：core-service API接口层实现 (Controller Layer)

### P0-8. RESTful API控制器 (在core-service中)
- **任务**: 在core-service中创建节目Controller层
- **文件**: 
  - `core-service/core-boot/src/main/java/org/nan/cloud/core/controller/ProgramController.java`
  - `core-service/core-boot/src/main/java/org/nan/cloud/core/controller/ProgramDraftController.java`
- **实现内容**:
  - 节目CRUD操作的REST接口
  - 草稿管理的完整API接口
  - 预览功能接口
  - 请求参数验证和响应封装
  - 异常处理和错误返回
  - API文档注解完善
- **API设计**: 按照设计文档中的接口规范实现
- **依赖**: Service层完整实现和program-domain的DTO
- **预估工时**: 8小时

## 第四阶段：file-service VSN处理实现

### P0-9. VSN生成服务 (在file-service中)
- **任务**: 在file-service中实现VSN XML生成功能
- **文件**: 
  - `file-service/file-application/src/main/java/org/nan/cloud/file/service/VsnGenerationService.java`
  - `file-service/file-application/src/main/java/org/nan/cloud/file/service/impl/VsnGenerationServiceImpl.java`
- **实现内容**:
  - 基于MongoDB中的JSON生成VSN XML
  - 素材路径查询和解析
  - VSN XML文件存储
  - 缩略图生成
  - 异步消息处理
- **依赖**: program-domain的Document和VSN映射类
- **预估工时**: 10小时

### P0-10. MQ消息处理 (在core-service和file-service中)
- **任务**: 实现服务间的异步消息通信
- **文件**: 
  - `core-service/core-infrastructure/src/main/java/org/nan/cloud/core/mq/VsnGenerationMessageProducer.java`
  - `file-service/file-infrastructure/src/main/java/org/nan/cloud/file/mq/VsnGenerationMessageConsumer.java`
- **实现内容**:
  - VSN生成请求消息发送
  - VSN生成结果消息接收
  - 失败处理和重试机制
  - 消息格式统一
- **依赖**: RabbitMQ配置和program-domain的DTO
- **预估工时**: 6小时

## 第五阶段：审核工作流和系统集成

### P1-11. 节目审核工作流 (在core-service中)
- **任务**: 实现节目审核工作流
- **文件**: 
  - `core-service/core-application/src/main/java/org/nan/cloud/core/service/ProgramApprovalService.java`
  - `core-service/core-boot/src/main/java/org/nan/cloud/core/controller/ProgramApprovalController.java`
- **实现内容**:
  - 组织级别的审核配置管理
  - 审核状态流转处理
  - 审核记录的创建和查询
  - 审核通知机制
- **状态管理**: PENDING -> APPROVED/REJECTED
- **依赖**: Repository层和消息服务
- **预估工时**: 6小时

### P1-11. 节目状态管理
- **任务**: 实现节目状态管理 - 草稿、发布、模板等状态转换
- **实现内容**:
  - 状态枚举定义和验证
  - 状态转换规则和权限控制
  - 状态变更事件处理
  - 状态查询和过滤
- **状态流转**: DRAFT -> PENDING -> PUBLISHED/TEMPLATE
- **预估工时**: 3小时

### P1-12. 内容验证逻辑
- **任务**: 添加节目内容验证逻辑 - 确保VSN格式的完整性和正确性
- **实现内容**:
  - VSN格式规范验证
  - 必填字段完整性检查
  - 数据类型和范围验证
  - 素材引用有效性验证
- **依赖**: VSN生成器和素材验证
- **预估工时**: 4小时

### P2-13. 缩略图生成
- **任务**: 实现节目缩略图生成 - 基于节目内容自动生成预览图
- **实现内容**:
  - 基于第一页内容生成缩略图
  - 支持不同尺寸的缩略图
  - 缓存机制和存储管理
  - 与文件服务集成
- **技术方案**: 可集成图片处理服务或使用Canvas截图
- **依赖**: 文件服务和图片处理能力
- **预估工时**: 6小时

## 第七阶段：测试和质量保证

### P0-14. 单元测试
- **任务**: 编写单元测试 - 覆盖核心业务逻辑
- **覆盖范围**:
  - Repository层数据访问测试
  - Service层业务逻辑测试
  - VSN生成器功能测试
  - 版本控制逻辑测试
- **测试工具**: JUnit 5, Mockito, TestContainers
- **目标覆盖率**: 80%以上
- **预估工时**: 8小时

### P1-15. 集成测试
- **任务**: 集成测试 - 端到端测试完整的节目创建发布流程
- **测试场景**:
  - 节目创建到发布的完整流程
  - 审核工作流的状态流转
  - 版本控制和历史查询
  - 素材依赖和发布验证
- **测试环境**: 使用测试数据库和模拟外部服务
- **预估工时**: 6小时

## 开发里程碑

### 里程碑1 - program-domain模块完善 (预计1周)
- 完成P0任务 (1,2,3,4): 补充Entity、枚举、DTO、VSN映射类
- program-domain模块可被其他服务正确依赖
- 所有数据结构定义完整

### 里程碑2 - core-service基础功能 (预计3周)  
- 完成P0任务 (5,6,7,8): Repository、Service、Controller层
- 实现节目和草稿的基本CRUD操作
- 基础API接口可用
- 版本控制和素材依赖管理

### 里程碑3 - file-service VSN处理 (预计2周)
- 完成P0任务 (9,10): VSN生成服务和MQ消息处理
- 支持异步VSN生成
- core-service和file-service协作正常

### 里程碑4 - 完整功能 (预计1-2周)
- 完成P1任务 (11): 审核工作流
- 系统集成和联调
- 功能测试通过

## 技术债务和注意事项

1. **模块依赖**: program-domain作为共享依赖，需要保持向后兼容
2. **VSN格式兼容性**: 严格按照现有VSN格式规范实现
3. **数据一致性**: MySQL和MongoDB数据通过最终一致性保证
4. **异步处理**: VSN生成采用异步处理，需要完善的错误处理机制
5. **权限集成**: 需要与现有权限系统（Casbin）集成
6. **消息队列**: 确保RabbitMQ消息的可靠性和幂等性

## 开发环境准备

1. **program-domain构建**: 确保模块能正确编译和被引用
2. **数据库准备**: 
   - MySQL表结构初始化  
   - MongoDB集合和索引创建
3. **依赖服务**: 确保Nacos、Redis、RabbitMQ正常运行
4. **测试数据**: 准备多种类型的前端JSON数据用于测试
5. **IDE配置**: 确保能正确识别program-domain的类引用

## 开发顺序建议

**第1周**: program-domain模块完善
**第2-4周**: core-service开发 (Repository → Service → Controller)
**第5-6周**: file-service开发 (VSN生成 + MQ集成)
**第7周**: 审核工作流 + 系统联调测试

---

**总预估工时**: 66小时 (约8个工作日)
**建议开发周期**: 6-7周 (包含测试和优化时间)