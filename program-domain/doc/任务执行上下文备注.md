# 节目管理模块 - 任务执行上下文备注

## 项目背景和目标

### 重要：架构澄清
**program-domain** 是一个纯数据模型模块，不包含业务逻辑：
- **作用**: 封装节目相关的复杂数据结构，作为共享依赖
- **内容**: Entity(MySQL)、Document(MongoDB)、DTO、Enum、VSN映射类
- **依赖方**: core-service、file-service等需要操作节目数据的服务
- **特点**: 零业务逻辑，仅提供数据契约和对象模型

### 核心需求回顾
基于VSN格式分析和素材管理集成，需要在多个服务中实现节目管理功能：

1. **前端画布编辑集成** - 接收前端生成的节目JSON数据
2. **VSN格式转换** - 在file-service中将JSON转换为设备可识别的VSN XML
3. **版本控制** - 在core-service中实现版本递增，草稿不参与版本控制
4. **审核工作流** - 在core-service中实现可配置的组织级审批流程
5. **终端发布** - 暂不开发，后期独立实现
6. **状态管理** - DRAFT/PUBLISHED/PENDING/TEMPLATE状态控制
7. **素材集成** - 与现有素材管理系统深度集成

### 前端JSON数据结构示例
```json
{
  "information": { "width": 1920, "height": 1080 },
  "pages": [
    {
      "loopType": "appointDuration",
      "appointDuration": 15,
      "bgColor": "#000000",
      "regions": [
        {
          "rect": { "x": 100, "y": 200, "width": 800, "height": 600, "borderWidth": 0 },
          "items": [
            {
              "type": "IMAGE",
              "fileSource": { "mid": "12345", "fileId": "file_abc123" },
              "duration": 5
            }
          ]
        }
      ]
    }
  ]
}
```

## 技术架构决策

### 模块架构选择
- **共享domain模块**: program-domain作为纯数据模型，被多个服务依赖
- **服务分层**: 
  - program-domain: 数据结构定义
  - core-service: 业务逻辑实现（Repository → Service → Controller）
  - file-service: VSN文件处理
- **双数据库**: MySQL存储元数据，MongoDB存储JSON/VSN内容
- **异步处理**: 使用RabbitMQ处理VSN生成和状态通知

### 数据存储策略
```
MySQL (结构化数据):
├── program (节目元数据)
├── program_material_ref (素材引用关系)
└── program_approval (审核记录)

MongoDB (文档数据):
└── program_contents (JSON原始数据 + VSN XML)
```

### VSN生成策略
1. **解析前端JSON** - 提取页面、区域、素材信息
2. **素材路径解析** - 通过fileSource.mid查询素材实际路径
3. **VSN对象构建** - 构建标准VSN项目结构
4. **XML序列化** - 生成符合设备要求的VSN XML

## 开发上下文和注意事项

### program-domain模块现状
**已实现的内容**:
- ProgramDO (MySQL实体) - 缺少VSN相关字段
- ProgramContent (MongoDB文档) - 基本完整
- 基础DTO类 - 需要补充草稿管理DTO
- 部分枚举类 - 需要补充VSN生成状态枚举
- VSN映射类 - 需要验证完整性

**需要补充的内容**:
1. ProgramDO的VSN文件相关字段
2. VsnGenerationStatusEnum枚举
3. 草稿管理相关DTO
4. 验证VSN映射类的完整性

### 现有系统集成点

#### 1. 素材管理系统集成 (在core-service中实现)
- **位置**: `core-service/core-application/src/main/java/org/nan/cloud/core/service/impl/MaterialServiceImpl.java`
- **关键接口**: `Material getMaterialById(Long mid)`
- **集成要点**: 
  - 验证素材存在性和权限
  - 获取素材实际文件路径用于VSN生成
  - 更新素材使用统计
  - 建立素材引用关系保护

#### 2. 数据访问层集成 (在core-service中实现)
- **MySQL Repository**: 使用program-domain的Entity类
- **MongoDB Repository**: 使用program-domain的Document类
- **集成要点**:
  - Repository接口在core-service中定义
  - 直接使用program-domain的数据模型
  - 无需在program-domain中实现Repository

### VSN格式关键技术点

#### 1. 素材路径处理
```xml
<Project>
  <Medias>
    <Media ID="1" FilePath="/materials/images/image1.jpg" Duration="5000"/>
  </Medias>
  <Pages>
    <Page Duration="15000">
      <Region X="100" Y="200" Width="800" Height="600">
        <Item Type="IMAGE" MediaID="1" Duration="5000"/>
      </Region>
    </Page>
  </Pages>
</Project>
```

#### 2. 时间单位转换
- **前端**: 秒为单位 (duration: 5)
- **VSN**: 毫秒为单位 (Duration="5000")
- **转换逻辑**: frontend_duration * 1000

#### 3. 坐标系统
- **前端**: 基于canvas的相对坐标
- **VSN**: 基于设备分辨率的绝对坐标
- **无需转换**: 前端已按实际分辨率计算

### 版本控制实现策略

#### 1. 版本递增逻辑
```sql
-- 获取当前最大版本号
SELECT MAX(current_version) FROM program WHERE id = ?

-- 创建新版本
UPDATE program SET current_version = current_version + 1 WHERE id = ?
INSERT INTO program_contents (program_id, version, ...) VALUES (?, new_version, ...)
```

#### 2. 历史版本查询
- **列表查询**: 只显示最新版本 (`MAX(version) GROUP BY program_id`)
- **详情查询**: 可查看所有历史版本
- **版本比较**: 支持任意两个版本的差异对比

### 审核工作流设计

#### 1. 组织级配置
```java
// 组织审核配置（可扩展到配置表）
@Value("${program.approval.enabled.org.${oid}:true}")
private boolean approvalEnabled;
```

#### 2. 状态流转
```
DRAFT (草稿)
  ↓ submit
PENDING (待审核) 
  ↓ approve/reject
APPROVED (已通过) → PUBLISHED (已发布)
REJECTED (已拒绝) → DRAFT (重新编辑)
```

### DRAFT状态管理机制

#### 1. 草稿状态的特殊性
- **理念**: 草稿是用户编辑过程中的临时保存，不是正式节目
- **实现**: 完整验证但不生成VSN，保护素材依赖关系
- **版本控制**: 草稿不参与版本递增，无版本号概念
- **生命周期**: 用户主动删除，或转换为正式节目后删除

#### 2. 草稿转正式节目机制
```java
// 基于草稿创建正式节目
POST /api/programs/draft/{draftId}/create
{
  "name": "正式节目名称",
  "description": "节目描述"
}
```

#### 3. 失败处理的简化策略
- **VSN生成失败**: 直接删除节目记录，推送通知
- **数据一致性**: 最终一致性，无需分布式事务
- **错误恢复**: 删除策略优于复杂回滚

## 开发调试上下文

### 本地开发环境
```bash
# 启动必要服务
mvn spring-boot:run -pl gateway                    # 网关服务 (8082)  
mvn spring-boot:run -pl auth-server/auth-boot       # 认证服务 (8081)
mvn spring-boot:run -pl core-service/core-boot      # 核心服务 (素材管理)

# 编译和测试program-domain模块
mvn clean compile -pl program-domain
mvn test -pl program-domain
```

### 测试数据准备
1. **测试素材**: 确保数据库中有可用的测试素材记录
2. **用户组数据**: 准备测试用的用户组和组织数据  
3. **前端JSON**: 准备多种类型的测试JSON（图片、视频、混合内容）

### 调试要点
1. **VSN生成验证**: 生成的VSN XML必须能被实际设备正确解析
2. **事务一致性**: MySQL和MongoDB的数据一致性验证
3. **权限验证**: 确保素材引用权限正确验证
4. **性能监控**: 大节目内容的处理性能

## 错误处理和异常情况

### 常见异常场景
1. **素材不存在**: 前端引用的素材在系统中不存在
2. **权限不足**: 用户无权使用某些素材
3. **VSN格式错误**: 生成的VSN不符合设备要求
4. **版本冲突**: 并发编辑导致版本冲突
5. **发布失败**: 终端服务不可用或网络异常

### 异常处理策略
```java
// 自定义异常类型
- ProgramNotFoundException
- MaterialAccessDeniedException  
- VsnGenerationException
- ProgramVersionConflictException
- ProgramPublishException
```

## 性能优化考虑

### 1. VSN生成优化
- **缓存策略**: 对已生成的VSN内容进行缓存
- **异步处理**: 大节目的VSN生成考虑异步处理
- **批量查询**: 素材信息批量查询而非逐个查询

### 2. 数据库优化
```sql
-- 关键索引
CREATE INDEX idx_program_org_status ON program(org_id, status);
CREATE INDEX idx_program_version ON program_contents(program_id, version);
CREATE INDEX idx_material_ref ON program_material_ref(program_id, program_version);
```

### 3. 缓存策略
- **节目列表**: Redis缓存热门节目列表
- **VSN内容**: 缓存已生成的VSN XML
- **素材信息**: 缓存常用素材的元数据

## 监控和告警

### 关键指标监控
1. **节目创建成功率**: 监控节目创建失败的比例
2. **VSN生成耗时**: 监控VSN生成的平均耗时
3. **发布成功率**: 监控终端发布的成功率
4. **素材依赖验证**: 监控素材引用失败的情况

### 日志规范
```java
// 关键操作日志
log.info("节目创建开始 - 用户: {}, 节目名: {}", userId, programName);
log.info("VSN生成完成 - 节目ID: {}, 耗时: {}ms", programId, duration);
log.error("节目发布失败 - 节目ID: {}, 终端: {}, 错误: {}", programId, terminalId, error);
```

## 部署和配置

### 配置参数
```yaml
program:
  vsn:
    validation: true          # VSN格式验证开关
    cache-enabled: true       # VSN缓存开关
    cache-ttl: 3600          # 缓存TTL秒数
  approval:
    default-enabled: true     # 默认开启审核
    auto-approve-roles: ["ADMIN"]  # 自动通过审核的角色
  publish:
    timeout: 30              # 发布超时时间（秒）
    retry-times: 3           # 发布重试次数
```

### 外部依赖
- **Nacos**: 服务注册和配置中心
- **MySQL**: 节目元数据存储
- **MongoDB**: 节目内容文档存储
- **Redis**: 缓存和会话存储
- **RabbitMQ**: 异步消息处理

---

**备注**: 此文档应随开发进展持续更新，记录新的发现和决策变更。