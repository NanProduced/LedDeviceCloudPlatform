<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¼ºå¥ç‰ˆæƒé™é€‰æ‹©å™¨ - å¤šå±‚æƒé™è¦†ç›–</title>
  <style>
    :root {
      --green-solid: #52c41a;
      --red-solid: #ff4d4f;
      --green-bg: rgba(230, 247, 230, 0.7);
      --red-bg: rgba(255, 242, 240, 0.7);
      --blue: #1890ff;
      --orange: #fa8c16;
      --gray: #8c8c8c;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 450px;
      gap: 20px;
    }

    header {
      grid-column: 1 / -1;
      text-align: center;
      padding: 20px 0;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--green-solid);
    }

    h1 {
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 2.5rem;
    }

    .subtitle {
      color: #7f8c8d;
      font-size: 1.2rem;
      max-width: 900px;
      margin: 0 auto;
      line-height: 1.6;
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      padding: 25px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    }

    .card-title {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
      color: #2c3e50;
      font-size: 1.5rem;
    }

    .card-title i {
      margin-right: 10px;
      font-size: 1.8rem;
    }

    .tree-container {
      height: 600px;
      overflow-y: auto;
      padding-right: 10px;
    }

    /* æ ‘å½¢ç»“æ„æ ·å¼ */
    .node {
      margin: 8px 0;
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      border-radius: 6px;
      transition: background 0.2s, transform 0.2s;
      position: relative;
    }

    .node:hover {
      background: rgba(245, 245, 245, 0.8);
      transform: translateX(3px);
    }

    .node.final-included {
      background: rgba(82, 196, 26, 0.1);
      border-left: 3px solid var(--green-solid);
    }

    .node.final-excluded {
      background: rgba(255, 77, 79, 0.1);
      border-left: 3px solid var(--red-solid);
    }

    .toggle {
      margin-right: 8px;
      cursor: pointer;
      width: 24px;
      height: 24px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      background: #f0f2f5;
      font-weight: bold;
    }

    .selector {
      width: 28px;
      height: 28px;
      border-radius: 5px;
      margin-right: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
      position: relative;
    }

    .selector:hover {
      transform: scale(1.1);
    }

    .selector.green-solid {
      border: 2px solid var(--green-solid);
      background: var(--green-bg);
    }

    .selector.green-hollow {
      border: 1px dashed var(--green-solid);
      background: white;
    }

    .selector.red-solid {
      border: 2px solid var(--red-solid);
      background: var(--red-bg);
    }

    .selector.red-hollow {
      border: 1px dashed var(--red-solid);
      background: white;
    }

    .priority-indicator {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 16px;
      height: 16px;
      background: var(--blue);
      border-radius: 50%;
      color: white;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .children {
      margin-left: 36px;
      display: none;
    }

    .expanded > .children {
      display: block;
    }

    .node-label {
      display: flex;
      align-items: center;
      font-size: 1.1rem;
      font-weight: 500;
      flex: 1;
    }

    .final-permission {
      margin-left: 12px;
      font-size: 0.9rem;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
    }

    .final-permission.included {
      background: rgba(82, 196, 26, 0.15);
      color: var(--green-solid);
    }

    .final-permission.excluded {
      background: rgba(255, 77, 79, 0.15);
      color: var(--red-solid);
    }

    .calculation-path {
      font-size: 0.8rem;
      color: var(--gray);
      margin-left: 10px;
      font-family: 'Courier New', monospace;
    }

    /* ä¾§è¾¹æ æ ·å¼ */
    .controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .rules-panel {
      background: #f0f8ff;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid var(--blue);
    }

    .rule-item {
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .rule-title {
      font-weight: 600;
      color: var(--blue);
      margin-bottom: 5px;
    }

    .calculation-demo {
      background: #fff7e6;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid var(--orange);
    }

    .calculation-step {
      margin: 8px 0;
      padding: 8px;
      background: white;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
    }

    .legend {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .legend-item {
      display: flex;
      align-items: center;
    }

    .legend-box {
      width: 24px;
      height: 24px;
      margin-right: 10px;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .legend-box.green-solid {
      border: 2px solid var(--green-solid);
      background: var(--green-bg);
    }

    .legend-box.green-hollow {
      border: 1px dashed var(--green-solid);
      background: white;
    }

    .legend-box.red-solid {
      border: 2px solid var(--red-solid);
      background: var(--red-bg);
    }

    .legend-box.red-hollow {
      border: 1px dashed var(--red-solid);
      background: white;
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    button {
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s ease;
    }

    .btn-calculate {
      background: var(--blue);
      color: white;
    }

    .btn-calculate:hover {
      background: #0c7bda;
      box-shadow: 0 4px 15px rgba(24, 144, 255, 0.3);
    }

    .btn-reset {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #ddd;
    }

    .btn-reset:hover {
      background: #e9ecef;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .output {
      height: 300px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      font-family: 'Fira Code', 'Courier New', monospace;
      white-space: pre-wrap;
      overflow: auto;
      border: 1px solid #eee;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .feedback {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.4s ease;
      z-index: 1000;
      max-width: 300px;
    }

    .feedback.show {
      transform: translateY(0);
      opacity: 1;
    }

    .feedback.success {
      border-left: 4px solid var(--green-solid);
    }

    .feedback.info {
      border-left: 4px solid var(--blue);
    }

    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
<div class="container">
  <header>
    <h1><i class="fas fa-layer-group"></i> å¼ºå¥ç‰ˆæƒé™é€‰æ‹©å™¨</h1>
    <p class="subtitle">æ”¯æŒå¤šå±‚æƒé™è¦†ç›–ï¼ŒåŸºäºæ·±åº¦ä¼˜å…ˆå’ŒèŒƒå›´ä½œç”¨çš„å¼ºå¥è®¡ç®—æ¨¡å‹</p>
  </header>

  <main class="card">
    <div class="card-title">
      <i class="fas fa-tree"></i>
      <h2>ç»ˆç«¯ç»„æƒé™è®¾ç½®</h2>
    </div>
    <div class="tree-container" id="tree-root"></div>
  </main>

  <aside class="controls">
    <!-- æ ¸å¿ƒè§„åˆ™è¯´æ˜ -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-balance-scale"></i>
        <h2>æ ¸å¿ƒè§„åˆ™</h2>
      </div>
      <div class="rules-panel">
        <div class="rule-item">
          <div class="rule-title">æ·±åº¦ä¼˜å…ˆåŸåˆ™</div>
          <div>è·¯å¾„ä¸Šæ›´æ·±å±‚çš„è®¾ç½®è¦†ç›–æµ…å±‚è®¾ç½®</div>
        </div>
        <div class="rule-item">
          <div class="rule-title">èŒƒå›´ä½œç”¨åŸåˆ™</div>
          <div>å®å¿ƒå½±å“å­æ ‘ï¼Œç©ºå¿ƒä»…å½±å“è‡ªèº«</div>
        </div>
        <div class="rule-item">
          <div class="rule-title">é»˜è®¤ç»§æ‰¿åŸåˆ™</div>
          <div>æ— è®¾ç½®æ—¶ç»§æ‰¿æœ€è¿‘çš„æœ‰æ•ˆç¥–å…ˆ</div>
        </div>
      </div>
    </div>

    <!-- è®¡ç®—æ¼”ç¤º -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-calculator"></i>
        <h2>è®¡ç®—æ¼”ç¤º</h2>
      </div>
      <div class="calculation-demo" id="calculation-demo">
        <div>ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹æƒé™è®¡ç®—è¿‡ç¨‹</div>
      </div>
    </div>

    <!-- å›¾ä¾‹è¯´æ˜ -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-palette"></i>
        <h2>å›¾ä¾‹è¯´æ˜</h2>
      </div>
      <div class="legend">
        <div class="legend-item">
          <div class="legend-box green-solid"></div>
          <span>åŒ…å«æœ¬ç»„åŠå­ç»„</span>
        </div>
        <div class="legend-item">
          <div class="legend-box green-hollow"></div>
          <span>ä»…åŒ…å«æœ¬ç»„</span>
        </div>
        <div class="legend-item">
          <div class="legend-box red-solid"></div>
          <span>æ’é™¤æœ¬ç»„åŠå­ç»„</span>
        </div>
        <div class="legend-item">
          <div class="legend-box red-hollow"></div>
          <span>ä»…æ’é™¤æœ¬ç»„</span>
        </div>
      </div>
    </div>

    <!-- æ“ä½œé¢æ¿ -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-cogs"></i>
        <h2>æ“ä½œé¢æ¿</h2>
      </div>
      <div class="actions">
        <button class="btn-calculate" id="calculateBtn">
          <i class="fas fa-play"></i>
          é‡æ–°è®¡ç®—æƒé™
        </button>
        <button class="btn-calculate" id="optimizeBtn" style="background: var(--orange);">
          <i class="fas fa-compress-alt"></i>
          ä¼˜åŒ–å†—ä½™é…ç½®
        </button>
        <button class="btn-reset" id="resetBtn">
          <i class="fas fa-undo"></i>
          é‡ç½®è®¾ç½®
        </button>
      </div>
    </div>

    <!-- è¾“å‡ºé¢æ¿ -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-list"></i>
        <h2>æœ€ç»ˆæƒé™ç»“æœ</h2>
      </div>
      <div class="output" id="output">æƒé™è®¡ç®—ç»“æœå°†åœ¨æ­¤å¤„æ˜¾ç¤º...</div>
    </div>
  </aside>
</div>

<div class="feedback" id="feedback">
  <i class="fas fa-check-circle"></i>
  <span id="feedback-message">æ“ä½œæˆåŠŸå®Œæˆ</span>
</div>

<script>
  // æ ‘å½¢ç»“æ„æ•°æ®
  const treeData = {
    id: 'root',
    name: 'æ€»éƒ¨',
    children: [
      {
        id: 'dev',
        name: 'ç ”å‘ä¸­å¿ƒ',
        children: [
          {
            id: 'dev1',
            name: 'ç ”å‘ä¸€éƒ¨',
            children: [
              { id: 'dev1-1', name: 'å‰ç«¯ç»„' },
              { id: 'dev1-2', name: 'åç«¯ç»„' }
            ]
          },
          {
            id: 'dev2',
            name: 'ç ”å‘äºŒéƒ¨',
            children: [
              { id: 'dev2-1', name: 'ç®—æ³•ç»„' },
              { id: 'dev2-2', name: 'æµ‹è¯•ç»„' }
            ]
          }
        ]
      },
      {
        id: 'market',
        name: 'è¥é”€ä¸­å¿ƒ',
        children: [
          {
            id: 'market1',
            name: 'å¸‚åœºä¸€éƒ¨',
            children: [
              { id: 'market1-1', name: 'æ¨å¹¿ç»„' },
              { id: 'market1-2', name: 'ç­–åˆ’ç»„' }
            ]
          },
          {
            id: 'market2',
            name: 'å¸‚åœºäºŒéƒ¨',
            children: [
              { id: 'market2-1', name: 'æ¸ é“ç»„' },
              { id: 'market2-2', name: 'å“ç‰Œç»„' }
            ]
          }
        ]
      }
    ]
  };

  // çŠ¶æ€ç®¡ç†
  const nodeStates = {};
  const treeStructure = {};
  let contextMenu = null;
  let selectedNodeForDemo = null;

  // ğŸ¯ æ ¸å¿ƒæƒé™è®¡ç®—é€»è¾‘
  function calculateFinalPermission(nodeId) {
    const pathToRoot = [nodeId, ...getAncestors(nodeId)].reverse(); // root -> ... -> nodeId
    let finalPermission = 'EXCLUDE'; // é»˜è®¤æ’é™¤
    let calculationSteps = [];
    let effectiveRule = null;
    
    calculationSteps.push(`èŠ‚ç‚¹ ${nodeId} çš„æƒé™è®¡ç®—è·¯å¾„: ${pathToRoot.join(' -> ')}`);
    calculationSteps.push(`åˆå§‹çŠ¶æ€: EXCLUDE (é»˜è®¤)`);
    
    // æŒ‰è·¯å¾„é¡ºåºåº”ç”¨æƒé™è§„åˆ™ï¼ˆåè€…è¦†ç›–å‰è€…ï¼‰
    for (let i = 0; i < pathToRoot.length; i++) {
      const ancestorId = pathToRoot[i];
      const state = nodeStates[ancestorId];
      
      if (state?.explicit) {
        // æ£€æŸ¥å½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨ancestorçš„å½±å“èŒƒå›´å†…
        if (isNodeInScope(nodeId, ancestorId, state.explicit)) {
          finalPermission = state.explicit.type;
          effectiveRule = {
            nodeId: ancestorId,
            rule: state.explicit,
            priority: i + 1
          };
          
          const scopeDesc = state.explicit.includeChildren ? '(åŒ…å«å­ç»„)' : '(ä»…æœ¬ç»„)';
          calculationSteps.push(`Step ${i + 1}: ${ancestorId}${scopeDesc} -> ${state.explicit.type}`);
        }
      }
    }
    
    calculationSteps.push(`æœ€ç»ˆç»“æœ: ${finalPermission}`);
    
    return {
      permission: finalPermission,
      effectiveRule,
      calculationSteps
    };
  }

  // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦åœ¨æƒé™è®¾ç½®çš„å½±å“èŒƒå›´å†…
  function isNodeInScope(targetNodeId, ruleNodeId, rule) {
    if (targetNodeId === ruleNodeId) {
      return true; // è§„åˆ™ä½œç”¨äºè‡ªèº«
    }
    
    if (rule.includeChildren) {
      // å®å¿ƒè§„åˆ™ï¼šæ£€æŸ¥targetæ˜¯å¦æ˜¯ruleçš„åä»£
      return isDescendant(targetNodeId, ruleNodeId);
    }
    
    return false; // ç©ºå¿ƒè§„åˆ™ï¼šä»…ä½œç”¨äºè‡ªèº«
  }

  // æ£€æŸ¥æ˜¯å¦ä¸ºåä»£èŠ‚ç‚¹
  function isDescendant(nodeId, ancestorId) {
    return getAncestors(nodeId).includes(ancestorId);
  }

  // è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹çš„æœ€ç»ˆæƒé™
  function calculateAllPermissions() {
    const results = {};
    
    for (const nodeId in nodeStates) {
      results[nodeId] = calculateFinalPermission(nodeId);
    }
    
    return results;
  }

  // è·å–æœ€ç»ˆç»‘å®šé…ç½®ï¼ˆæ™ºèƒ½æ¸…ç†å†—ä½™ï¼‰
  function getFinalBindings() {
    const rawBindings = [];
    
    // æ”¶é›†æ‰€æœ‰æ˜¾å¼è®¾ç½®
    for (const nodeId in nodeStates) {
      const state = nodeStates[nodeId];
      if (state?.explicit) {
        rawBindings.push({
          terminal_group_id: nodeId,
          terminal_group_name: treeStructure[nodeId].name,
          type: state.explicit.type,
          include_children: state.explicit.includeChildren
        });
      }
    }
    
    // æ™ºèƒ½æ¸…ç†å†—ä½™
    return removeRedundantBindings(rawBindings);
  }

  // ğŸ¯ æ ¸å¿ƒç®—æ³•ï¼šæ™ºèƒ½å†—ä½™æ¸…ç†
  function removeRedundantBindings(bindings) {
    const optimizedBindings = [];
    
    for (const binding of bindings) {
      let isRedundant = false;
      
      // æ£€æŸ¥æ˜¯å¦è¢«ç¥–å…ˆè§„åˆ™è¦†ç›–
      const ancestors = getAncestors(binding.terminal_group_id);
      
      for (const ancestorId of ancestors) {
        // æŸ¥æ‰¾ç¥–å…ˆä¸­çš„æ˜¾å¼è®¾ç½®
        const ancestorBinding = bindings.find(b => b.terminal_group_id === ancestorId);
        
        if (ancestorBinding && isBindingRedundant(binding, ancestorBinding, ancestorId)) {
          isRedundant = true;
          break;
        }
      }
      
      if (!isRedundant) {
        optimizedBindings.push(binding);
      }
    }
    
    return optimizedBindings;
  }

  // åˆ¤æ–­bindingæ˜¯å¦è¢«ancestorBindingè¦†ç›–
  function isBindingRedundant(binding, ancestorBinding, ancestorId) {
    // åªæœ‰å½“ç¥–å…ˆåŒ…å«å­ç»„æ—¶æ‰å¯èƒ½äº§ç”Ÿè¦†ç›–
    if (!ancestorBinding.include_children) {
      return false;
    }
    
    // æ£€æŸ¥å½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨ç¥–å…ˆçš„ä½œç”¨åŸŸå†…
    const isInAncestorScope = ancestorId === binding.terminal_group_id || 
                              isDescendant(binding.terminal_group_id, ancestorId);
    
    if (!isInAncestorScope) {
      return false;
    }
    
    // è®¡ç®—å¦‚æœæ²¡æœ‰å½“å‰bindingï¼ŒèŠ‚ç‚¹çš„æƒé™æ˜¯ä»€ä¹ˆ
    const permissionWithoutBinding = calculatePermissionWithoutBinding(
      binding.terminal_group_id, 
      binding.terminal_group_id
    );
    
    // è®¡ç®—æœ‰å½“å‰bindingæ—¶èŠ‚ç‚¹çš„æƒé™  
    const permissionWithBinding = binding.type;
    
    // å¦‚æœæƒé™ç»“æœç›¸åŒï¼Œåˆ™å½“å‰bindingæ˜¯å†—ä½™çš„
    return permissionWithoutBinding === permissionWithBinding;
  }

  // è®¡ç®—ç§»é™¤ç‰¹å®šbindingåèŠ‚ç‚¹çš„æƒé™
  function calculatePermissionWithoutBinding(nodeId, excludeBindingNodeId) {
    const pathToRoot = [nodeId, ...getAncestors(nodeId)].reverse();
    let finalPermission = 'EXCLUDE'; // é»˜è®¤æ’é™¤
    
    for (const ancestorId of pathToRoot) {
      // è·³è¿‡è¦æ’é™¤çš„binding
      if (ancestorId === excludeBindingNodeId) {
        continue;
      }
      
      const state = nodeStates[ancestorId];
      if (state?.explicit && isNodeInScope(nodeId, ancestorId, state.explicit)) {
        finalPermission = state.explicit.type;
      }
    }
    
    return finalPermission;
  }

  // æ„å»ºæ ‘å½¢ç»“æ„æ˜ å°„
  function buildTreeStructure(node, parentId = null) {
    treeStructure[node.id] = {
      parentId,
      children: node.children ? node.children.map(child => child.id) : [],
      name: node.name
    };

    if (node.children) {
      node.children.forEach(child => buildTreeStructure(child, node.id));
    }
  }

  // è·å–ç¥–å…ˆèŠ‚ç‚¹
  function getAncestors(nodeId) {
    const ancestors = [];
    let currentId = treeStructure[nodeId]?.parentId;
    
    while (currentId) {
      ancestors.push(currentId);
      currentId = treeStructure[currentId]?.parentId;
    }
    
    return ancestors;
  }

  // è·å–æ‰€æœ‰åä»£èŠ‚ç‚¹
  function getAllDescendants(nodeId) {
    const descendants = [];
    const queue = [nodeId];
    
    while (queue.length > 0) {
      const currentId = queue.shift();
      const children = treeStructure[currentId]?.children || [];
      descendants.push(...children);
      queue.push(...children);
    }
    
    return descendants;
  }

  // åˆå§‹åŒ–çŠ¶æ€
  function initializeStates(node) {
    nodeStates[node.id] = {
      explicit: null
    };

    if (node.children) {
      node.children.forEach(child => initializeStates(child));
    }
  }

  // æ˜¾ç¤ºé€‰æ‹©èœå•
  function showSelectorMenu(nodeId, x, y) {
    if (contextMenu) {
      document.body.removeChild(contextMenu);
    }

    contextMenu = document.createElement('div');
    contextMenu.className = 'selector-menu';
    contextMenu.style.cssText = `
      position: fixed;
      left: ${x}px;
      top: ${y}px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
      z-index: 1000;
      padding: 10px 0;
      min-width: 300px;
    `;

    const title = document.createElement('div');
    title.textContent = `è®¾ç½®èŠ‚ç‚¹: ${treeStructure[nodeId].name}`;
    title.style.cssText = `
      padding: 10px 15px;
      font-weight: 600;
      border-bottom: 1px solid #eee;
    `;
    contextMenu.appendChild(title);

    const options = [
      { text: 'åŒ…å«æœ¬ç»„åŠæ‰€æœ‰å­ç»„', action: 'include-all', color: 'green', style: 'solid' },
      { text: 'ä»…åŒ…å«æœ¬ç»„', action: 'include-self', color: 'green', style: 'hollow' },
      { text: 'æ’é™¤æœ¬ç»„åŠæ‰€æœ‰å­ç»„', action: 'exclude-all', color: 'red', style: 'solid' },
      { text: 'ä»…æ’é™¤æœ¬ç»„', action: 'exclude-self', color: 'red', style: 'hollow' },
      { text: 'æ¸…é™¤è®¾ç½®', action: 'clear' }
    ];

    options.forEach((opt, index) => {
      if (index === 2) {
        const divider = document.createElement('div');
        divider.style.cssText = 'height: 1px; background: #eee; margin: 5px 0;';
        contextMenu.appendChild(divider);
      }

      const option = document.createElement('div');
      option.className = 'menu-option';
      option.style.cssText = `
        padding: 12px 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background 0.2s;
      `;

      if (opt.color) {
        const colorBox = document.createElement('div');
        colorBox.style.cssText = `
          width: 18px;
          height: 18px;
          margin-right: 12px;
          border-radius: 4px;
          border: ${opt.style === 'solid' ? '2px solid' : '1px dashed'} var(--${opt.color}-solid);
          background: ${opt.style === 'solid' ? `var(--${opt.color}-bg)` : 'white'};
        `;
        option.appendChild(colorBox);
      }

      const text = document.createElement('span');
      text.textContent = opt.text;
      text.style.flex = '1';
      option.appendChild(text);

      option.addEventListener('mouseenter', () => option.style.background = '#f8f9fa');
      option.addEventListener('mouseleave', () => option.style.background = 'transparent');
      option.addEventListener('click', () => {
        handleSelection(nodeId, opt.action);
        document.body.removeChild(contextMenu);
        contextMenu = null;
      });

      contextMenu.appendChild(option);
    });

    document.body.appendChild(contextMenu);

    const closeMenu = (e) => {
      if (contextMenu && !contextMenu.contains(e.target)) {
        document.body.removeChild(contextMenu);
        contextMenu = null;
        document.removeEventListener('click', closeMenu);
      }
    };

    setTimeout(() => document.addEventListener('click', closeMenu), 100);
  }

  // å¤„ç†é€‰æ‹©æ“ä½œ
  function handleSelection(nodeId, action) {
    const state = nodeStates[nodeId];
    
    switch (action) {
      case 'include-all':
        state.explicit = { type: 'INCLUDE', includeChildren: true };
        break;
      case 'include-self':
        state.explicit = { type: 'INCLUDE', includeChildren: false };
        break;
      case 'exclude-all':
        state.explicit = { type: 'EXCLUDE', includeChildren: true };
        break;
      case 'exclude-self':
        state.explicit = { type: 'EXCLUDE', includeChildren: false };
        break;
      case 'clear':
        state.explicit = null;
        break;
    }
    
    // é‡æ–°è®¡ç®—å’Œæ¸²æŸ“
    updateAllNodesAppearance();
    updateOutput();
    showFeedback(`${getActionName(action)}æ“ä½œå·²åº”ç”¨`, 'success');
  }

  // è·å–æ“ä½œåç§°
  function getActionName(action) {
    const names = {
      'include-all': 'åŒ…å«æœ¬ç»„åŠæ‰€æœ‰å­ç»„',
      'include-self': 'ä»…åŒ…å«æœ¬ç»„',
      'exclude-all': 'æ’é™¤æœ¬ç»„åŠæ‰€æœ‰å­ç»„',
      'exclude-self': 'ä»…æ’é™¤æœ¬ç»„',
      'clear': 'æ¸…é™¤è®¾ç½®'
    };
    return names[action] || action;
  }

  // æ›´æ–°èŠ‚ç‚¹å¤–è§‚
  function updateNodeAppearance(nodeId) {
    const state = nodeStates[nodeId];
    const selector = document.querySelector(`.selector[data-id="${nodeId}"]`);
    const nodeElement = document.querySelector(`.node[data-id="${nodeId}"]`);
    const finalPermissionElement = nodeElement.querySelector('.final-permission');
    
    if (!selector || !nodeElement) return;

    // æ¸…é™¤æ ·å¼
    selector.className = 'selector';
    nodeElement.classList.remove('final-included', 'final-excluded');
    
    // ç§»é™¤ä¼˜å…ˆçº§æŒ‡ç¤ºå™¨
    const existingIndicator = selector.querySelector('.priority-indicator');
    if (existingIndicator) {
      existingIndicator.remove();
    }

    // æ˜¾ç¤ºæ˜¾å¼è®¾ç½®
    if (state.explicit) {
      if (state.explicit.type === 'INCLUDE') {
        selector.classList.add(state.explicit.includeChildren ? 'green-solid' : 'green-hollow');
      } else {
        selector.classList.add(state.explicit.includeChildren ? 'red-solid' : 'red-hollow');
      }
    } else {
      selector.style.border = '1px solid #ddd';
      selector.style.background = '#f9f9f9';
    }

    // è®¡ç®—å¹¶æ˜¾ç¤ºæœ€ç»ˆæƒé™
    const result = calculateFinalPermission(nodeId);
    finalPermissionElement.textContent = result.permission === 'INCLUDE' ? 'âœ“ æœ‰æƒé™' : 'âœ— æ— æƒé™';
    finalPermissionElement.className = `final-permission ${result.permission === 'INCLUDE' ? 'included' : 'excluded'}`;
    
    // è®¾ç½®èŠ‚ç‚¹èƒŒæ™¯è‰²
    nodeElement.classList.add(result.permission === 'INCLUDE' ? 'final-included' : 'final-excluded');
    
    // æ˜¾ç¤ºä¼˜å…ˆçº§
    if (result.effectiveRule) {
      const priorityIndicator = document.createElement('div');
      priorityIndicator.className = 'priority-indicator';
      priorityIndicator.textContent = result.effectiveRule.priority;
      priorityIndicator.title = `ä¼˜å…ˆçº§ ${result.effectiveRule.priority}ï¼Œæ¥æº: ${result.effectiveRule.nodeId}`;
      selector.appendChild(priorityIndicator);
    }
  }

  // æ›´æ–°æ‰€æœ‰èŠ‚ç‚¹å¤–è§‚
  function updateAllNodesAppearance() {
    for (const nodeId in nodeStates) {
      updateNodeAppearance(nodeId);
    }
  }

  // æ›´æ–°è®¡ç®—æ¼”ç¤º
  function updateCalculationDemo(nodeId) {
    const demo = document.getElementById('calculation-demo');
    if (!nodeId) {
      demo.innerHTML = '<div>ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹æƒé™è®¡ç®—è¿‡ç¨‹</div>';
      return;
    }
    
    const result = calculateFinalPermission(nodeId);
    
    demo.innerHTML = `
      <div style="font-weight: 600; margin-bottom: 10px;">
        èŠ‚ç‚¹: ${treeStructure[nodeId].name} çš„æƒé™è®¡ç®—
      </div>
      ${result.calculationSteps.map(step => 
        `<div class="calculation-step">${step}</div>`
      ).join('')}
    `;
  }

  // æ›´æ–°è¾“å‡º
  function updateOutput() {
    const rawBindings = [];
    
    // æ”¶é›†åŸå§‹ç»‘å®š
    for (const nodeId in nodeStates) {
      const state = nodeStates[nodeId];
      if (state?.explicit) {
        rawBindings.push({
          terminal_group_id: nodeId,
          terminal_group_name: treeStructure[nodeId].name,
          type: state.explicit.type,
          include_children: state.explicit.includeChildren
        });
      }
    }
    
    const optimizedBindings = getFinalBindings();
    const allPermissions = calculateAllPermissions();
    
    const output = {
      // æ˜¾ç¤ºä¼˜åŒ–ç»Ÿè®¡
      optimization: {
        rawCount: rawBindings.length,
        optimizedCount: optimizedBindings.length,
        redundantCount: rawBindings.length - optimizedBindings.length,
        compressionRatio: rawBindings.length > 0 ? 
          `${Math.round((1 - optimizedBindings.length / rawBindings.length) * 100)}%` : '0%'
      },
      
      // åŸå§‹è®¾ç½®ï¼ˆä¼˜åŒ–å‰ï¼‰
      rawSettings: rawBindings,
      
      // ä¼˜åŒ–åçš„è®¾ç½®ï¼ˆæ¨èä¼ ç»™åç«¯ï¼‰
      optimizedSettings: optimizedBindings,
      
      // æœ€ç»ˆæƒé™ç»“æœï¼ˆéªŒè¯æ­£ç¡®æ€§ï¼‰
      finalPermissions: Object.fromEntries(
        Object.entries(allPermissions).map(([nodeId, result]) => [
          `${nodeId}(${treeStructure[nodeId].name})`,
          result.permission
        ])
      )
    };
    
    document.getElementById('output').textContent = JSON.stringify(output, null, 2);
  }

  // æ¸²æŸ“æ ‘å½¢ç»“æ„
  function renderTree(node, parentElement) {
    const nodeElement = document.createElement('div');
    nodeElement.className = 'node';
    nodeElement.dataset.id = node.id;

    const nodeContent = document.createElement('div');
    nodeContent.style.cssText = 'display: flex; align-items: center; width: 100%;';

    const toggle = document.createElement('div');
    toggle.className = 'toggle';
    if (node.children && node.children.length > 0) {
      toggle.textContent = 'â–¶';
      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleChildren(nodeElement);
      });
    } else {
      toggle.textContent = 'â€¢';
      toggle.style.cssText = 'color: #aaa; font-size: 1.5rem; line-height: 1;';
    }

    const selector = document.createElement('div');
    selector.className = 'selector';
    selector.dataset.id = node.id;
    selector.addEventListener('click', (e) => {
      e.stopPropagation();
      showSelectorMenu(node.id, e.clientX, e.clientY);
    });

    const label = document.createElement('div');
    label.className = 'node-label';
    label.textContent = node.name;
    
    // ç‚¹å‡»èŠ‚ç‚¹æ˜¾ç¤ºè®¡ç®—è¿‡ç¨‹
    label.addEventListener('click', (e) => {
      e.stopPropagation();
      selectedNodeForDemo = node.id;
      updateCalculationDemo(node.id);
      
      // é«˜äº®é€‰ä¸­èŠ‚ç‚¹
      document.querySelectorAll('.node').forEach(n => n.style.outline = 'none');
      nodeElement.style.outline = '2px solid var(--blue)';
    });

    const finalPermission = document.createElement('span');
    finalPermission.className = 'final-permission';

    nodeContent.appendChild(toggle);
    nodeContent.appendChild(selector);
    nodeContent.appendChild(label);
    nodeContent.appendChild(finalPermission);
    nodeElement.appendChild(nodeContent);
    parentElement.appendChild(nodeElement);

    if (node.children) {
      const childrenContainer = document.createElement('div');
      childrenContainer.className = 'children';
      nodeElement.appendChild(childrenContainer);

      node.children.forEach(child => {
        renderTree(child, childrenContainer);
      });
    }
  }

  // åˆ‡æ¢å­èŠ‚ç‚¹æ˜¾ç¤º
  function toggleChildren(nodeElement) {
    const children = nodeElement.querySelector('.children');
    if (children) {
      nodeElement.classList.toggle('expanded');
      const toggle = nodeElement.querySelector('.toggle');
      toggle.textContent = nodeElement.classList.contains('expanded') ? 'â–¼' : 'â–¶';
    }
  }

  // æ˜¾ç¤ºåé¦ˆæ¶ˆæ¯
  function showFeedback(message, type) {
    const feedback = document.getElementById('feedback');
    const messageEl = document.getElementById('feedback-message');

    messageEl.textContent = message;
    feedback.className = 'feedback ' + type;
    feedback.classList.add('show');

    setTimeout(() => {
      feedback.classList.remove('show');
    }, 3000);
  }

  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    const treeRoot = document.getElementById('tree-root');

    // æ„å»ºæ ‘å½¢ç»“æ„æ˜ å°„
    buildTreeStructure(treeData);
    
    // åˆå§‹åŒ–çŠ¶æ€
    initializeStates(treeData);

    // è®¾ç½®ç¤ºä¾‹çŠ¶æ€ï¼ˆæ‚¨æåˆ°çš„åœºæ™¯ï¼‰
    nodeStates['root'].explicit = { type: 'INCLUDE', includeChildren: true };
    nodeStates['dev'].explicit = { type: 'EXCLUDE', includeChildren: true };
    // ç”¨æˆ·å¯ä»¥ç»§ç»­è®¾ç½® dev2 ä¸ºåŒ…å«ï¼Œè¿™æ˜¯å®Œå…¨åˆç†çš„

    // æ¸²æŸ“æ ‘
    renderTree(treeData, treeRoot);

    // å±•å¼€æ ¹èŠ‚ç‚¹
    document.querySelector(`.node[data-id="root"]`).classList.add('expanded');

    // åˆå§‹åŒ–æ˜¾ç¤º
    updateAllNodesAppearance();
    updateOutput();

    // äº‹ä»¶ç›‘å¬
    document.getElementById('calculateBtn').addEventListener('click', () => {
      updateAllNodesAppearance();
      updateOutput();
      if (selectedNodeForDemo) {
        updateCalculationDemo(selectedNodeForDemo);
      }
      showFeedback('æƒé™é‡æ–°è®¡ç®—å®Œæˆ', 'info');
    });

    document.getElementById('optimizeBtn').addEventListener('click', () => {
      const rawCount = Object.values(nodeStates).filter(s => s.explicit).length;
      const optimized = getFinalBindings();
      const savedCount = rawCount - optimized.length;
      
      if (savedCount > 0) {
        showFeedback(`ä¼˜åŒ–å®Œæˆï¼æ¸…ç†äº† ${savedCount} ä¸ªå†—ä½™é…ç½®`, 'success');
      } else {
        showFeedback('å½“å‰é…ç½®å·²æ˜¯æœ€ä¼˜ï¼Œæ— å†—ä½™é¡¹', 'info');
      }
      
      updateOutput();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      for (const nodeId in nodeStates) {
        nodeStates[nodeId].explicit = null;
      }
      
      // è®¾ç½®é»˜è®¤çŠ¶æ€
      nodeStates['root'].explicit = { type: 'INCLUDE', includeChildren: true };
      
      updateAllNodesAppearance();
      updateOutput();
      updateCalculationDemo(null);
      selectedNodeForDemo = null;
      
      document.querySelectorAll('.node').forEach(n => n.style.outline = 'none');
      showFeedback('æ‰€æœ‰è®¾ç½®å·²é‡ç½®', 'info');
    });
  });
</script>
</body>
</html>