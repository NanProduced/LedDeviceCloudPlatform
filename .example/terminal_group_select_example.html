<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ‘å½¢æƒé™é€‰æ‹©å™¨ - ç¦æ­¢å†—ä½™æ“ä½œ</title>
  <style>
    :root {
      --green-solid: #52c41a;
      --red-solid: #ff4d4f;
      --green-bg: rgba(230, 247, 230, 0.7);
      --red-bg: rgba(255, 242, 240, 0.7);
      --blue: #1890ff;
      --orange: #fa8c16;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 20px;
    }

    header {
      grid-column: 1 / -1;
      text-align: center;
      padding: 20px 0;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--green-solid);
    }

    h1 {
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 2.5rem;
    }

    .subtitle {
      color: #7f8c8d;
      font-size: 1.2rem;
      max-width: 800px;
      margin: 0 auto;
      line-height: 1.6;
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      padding: 25px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    }

    .card-title {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
      color: #2c3e50;
      font-size: 1.5rem;
    }

    .card-title i {
      margin-right: 10px;
      font-size: 1.8rem;
    }

    .tree-container {
      height: 600px;
      overflow-y: auto;
      padding-right: 10px;
    }

    /* æ ‘å½¢ç»“æ„æ ·å¼ */
    .node {
      margin: 8px 0;
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      border-radius: 6px;
      transition: background 0.2s, transform 0.2s;
    }

    .node:hover {
      background: rgba(245, 245, 245, 0.8);
      transform: translateX(3px);
    }

    .node.inherited-green {
      background: var(--green-bg);
    }

    .node.inherited-red {
      background: var(--red-bg);
    }

    .toggle {
      margin-right: 8px;
      cursor: pointer;
      width: 24px;
      height: 24px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      background: #f0f2f5;
      font-weight: bold;
    }

    .selector {
      width: 28px;
      height: 28px;
      border-radius: 5px;
      margin-right: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }

    .selector:hover {
      transform: scale(1.1);
    }

    .selector.green-solid {
      border: 2px solid var(--green-solid);
      background: var(--green-bg);
    }

    .selector.green-hollow {
      border: 1px dashed var(--green-solid);
      background: white;
    }

    .selector.red-solid {
      border: 2px solid var(--red-solid);
      background: var(--red-bg);
    }

    .selector.red-hollow {
      border: 1px dashed var(--red-solid);
      background: white;
    }

    .children {
      margin-left: 36px;
      display: none;
    }

    .expanded > .children {
      display: block;
    }

    .node-label {
      display: flex;
      align-items: center;
      font-size: 1.1rem;
      font-weight: 500;
    }

    .status-indicator {
      margin-left: 12px;
      font-size: 0.85rem;
      padding: 3px 8px;
      border-radius: 4px;
    }

    .status-inherited {
      background: rgba(24, 144, 255, 0.15);
      color: var(--blue);
    }

    .status-explicit {
      background: rgba(250, 140, 22, 0.15);
      color: var(--orange);
    }

    /* æ“ä½œé¢æ¿æ ·å¼ */
    .controls {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .legend {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .legend-item {
      display: flex;
      align-items: center;
    }

    .legend-box {
      width: 24px;
      height: 24px;
      margin-right: 10px;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .legend-box.green-solid {
      border: 2px solid var(--green-solid);
      background: var(--green-bg);
    }

    .legend-box.green-hollow {
      border: 1px dashed var(--green-solid);
      background: white;
    }

    .legend-box.red-solid {
      border: 2px solid var(--red-solid);
      background: var(--red-bg);
    }

    .legend-box.red-hollow {
      border: 1px dashed var(--red-solid);
      background: white;
    }

    .legend-box.inherited-green {
      border: 2px solid var(--green-solid);
      background: var(--green-bg);
    }

    .legend-box.inherited-red {
      border: 2px solid var(--red-solid);
      background: var(--red-bg);
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    button {
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s ease;
    }

    .btn-save {
      background: var(--green-solid);
      color: white;
    }

    .btn-save:hover {
      background: #3daa2b;
      box-shadow: 0 4px 15px rgba(82, 196, 26, 0.3);
    }

    .btn-reset {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #ddd;
    }

    .btn-reset:hover {
      background: #e9ecef;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .btn-export {
      background: var(--blue);
      color: white;
    }

    .btn-export:hover {
      background: #0c7bda;
      box-shadow: 0 4px 15px rgba(24, 144, 255, 0.3);
    }

    .output {
      height: 300px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      font-family: 'Fira Code', 'Courier New', monospace;
      white-space: pre-wrap;
      overflow: auto;
      border: 1px solid #eee;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .rules {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid var(--blue);
    }

    .rules h3 {
      margin-bottom: 15px;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .rules ul {
      padding-left: 20px;
    }

    .rules li {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .feedback {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.4s ease;
      z-index: 1000;
    }

    .feedback.show {
      transform: translateY(0);
      opacity: 1;
    }

    .feedback.success {
      border-left: 4px solid var(--green-solid);
    }

    .feedback.error {
      border-left: 4px solid var(--red-solid);
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
<div class="container">
  <header>
    <h1><i class="fas fa-sitemap"></i> æ ‘å½¢æƒé™é€‰æ‹©å™¨ - ç¦æ­¢å†—ä½™æ“ä½œ</h1>
    <p class="subtitle">ç¦æ­¢åœ¨å®å¿ƒå‹¾é€‰çš„ç»„ä¸‹è¿›è¡ŒåŒé¢œè‰²ç©ºå¿ƒå‹¾é€‰æ“ä½œï¼Œé¿å…å†—ä½™æ“ä½œ</p>
  </header>

  <main class="card">
    <div class="card-title">
      <i class="fas fa-tree"></i>
      <h2>ç»ˆç«¯ç»„æƒé™è®¾ç½®</h2>
    </div>
    <div class="tree-container" id="tree-root"></div>
  </main>

  <aside class="controls">
    <div class="card">
      <div class="card-title">
        <i class="fas fa-palette"></i>
        <h2>å›¾ä¾‹è¯´æ˜</h2>
      </div>
      <div class="legend">
        <div class="legend-item">
          <div class="legend-box green-solid"></div>
          <span>åŒ…å«æœ¬ç»„åŠæ‰€æœ‰å­ç»„</span>
        </div>
        <div class="legend-item">
          <div class="legend-box green-hollow"></div>
          <span>ä»…åŒ…å«æœ¬ç»„</span>
        </div>
        <div class="legend-item">
          <div class="legend-box red-solid"></div>
          <span>æ’é™¤æœ¬ç»„åŠæ‰€æœ‰å­ç»„</span>
        </div>
        <div class="legend-item">
          <div class="legend-box red-hollow"></div>
          <span>ä»…æ’é™¤æœ¬ç»„</span>
        </div>
        <div class="legend-item">
          <div class="legend-box inherited-green"></div>
          <span>ç»§æ‰¿åŒ…å«çŠ¶æ€</span>
        </div>
        <div class="legend-item">
          <div class="legend-box inherited-red"></div>
          <span>ç»§æ‰¿æ’é™¤çŠ¶æ€</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <i class="fas fa-lightbulb"></i>
        <h2>æ“ä½œè§„åˆ™</h2>
      </div>
      <div class="rules">
        <ul>
          <li>ç¦æ­¢åœ¨å®å¿ƒå‹¾é€‰çš„ç»„ä¸‹è¿›è¡ŒåŒé¢œè‰²ç©ºå¿ƒå‹¾é€‰</li>
          <li>ç»§æ‰¿çŠ¶æ€ä¸‹ç¦æ­¢é‡å¤ç›¸åŒç±»å‹çš„å…¨å±€æ“ä½œ</li>
          <li>æ’é™¤æ“ä½œå¿…é¡»ä½äºåŒ…å«æ“ä½œçš„å­æ ‘ä¸‹æ–¹</li>
          <li>å®å¿ƒèŠ‚ç‚¹è‡ªåŠ¨æ¸…é™¤å­æ ‘ä¸­çš„åŒç±»å‹è®°å½•</li>
          <li>æ˜¾å¼è®¾ç½®ä¼˜å…ˆäºç»§æ‰¿çŠ¶æ€</li>
          <li>æ‰€æœ‰æ“ä½œå‡ä¸ä¼šæ‹’ç»ï¼Œä½†ä¼šæ™ºèƒ½ä¼˜åŒ–å­˜å‚¨</li>
          <li>æ ¹èŠ‚ç‚¹(root)ä¸å…è®¸è®¾ç½®æ’é™¤çŠ¶æ€</li>
        </ul>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <i class="fas fa-cogs"></i>
        <h2>æ“ä½œé¢æ¿</h2>
      </div>
      <div class="actions">
        <button class="btn-save" id="saveBtn">
          <i class="fas fa-save"></i>
          ä¿å­˜é…ç½®
        </button>
        <button class="btn-reset" id="resetBtn">
          <i class="fas fa-undo"></i>
          é‡ç½®è®¾ç½®
        </button>
        <button class="btn-export" id="exportBtn">
          <i class="fas fa-download"></i>
          å¯¼å‡ºé…ç½®
        </button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <i class="fas fa-code"></i>
        <h2>ç»‘å®šé…ç½®è¾“å‡º</h2>
      </div>
      <div class="output" id="output">é…ç½®å°†åœ¨æ­¤å¤„æ˜¾ç¤º...</div>
    </div>
  </aside>
</div>

<div class="feedback" id="feedback">
  <i class="fas fa-check-circle"></i>
  <span id="feedback-message">æ“ä½œæˆåŠŸå®Œæˆ</span>
</div>

<script>
  // æ ‘å½¢ç»“æ„æ•°æ®
  const treeData = {
    id: 'root',
    name: 'æ€»éƒ¨',
    children: [
      {
        id: 'dev',
        name: 'ç ”å‘ä¸­å¿ƒ',
        children: [
          {
            id: 'dev1',
            name: 'ç ”å‘ä¸€éƒ¨',
            children: [
              { id: 'dev1-1', name: 'å‰ç«¯ç»„' },
              { id: 'dev1-2', name: 'åç«¯ç»„' }
            ]
          },
          {
            id: 'dev2',
            name: 'ç ”å‘äºŒéƒ¨',
            children: [
              { id: 'dev2-1', name: 'ç®—æ³•ç»„' },
              { id: 'dev2-2', name: 'æµ‹è¯•ç»„' }
            ]
          }
        ]
      },
      {
        id: 'market',
        name: 'è¥é”€ä¸­å¿ƒ',
        children: [
          {
            id: 'market1',
            name: 'å¸‚åœºä¸€éƒ¨',
            children: [
              { id: 'market1-1', name: 'æ¨å¹¿ç»„' },
              { id: 'market1-2', name: 'ç­–åˆ’ç»„' }
            ]
          },
          {
            id: 'market2',
            name: 'å¸‚åœºäºŒéƒ¨',
            children: [
              { id: 'market2-1', name: 'æ¸ é“ç»„' },
              { id: 'market2-2', name: 'å“ç‰Œç»„' }
            ]
          }
        ]
      },
      {
        id: 'finance',
        name: 'è´¢åŠ¡ä¸­å¿ƒ',
        children: [
          {
            id: 'finance1',
            name: 'è´¢åŠ¡ä¸€éƒ¨',
            children: [
              { id: 'finance1-1', name: 'æ ¸ç®—ç»„' },
              { id: 'finance1-2', name: 'å®¡è®¡ç»„' }
            ]
          },
          {
            id: 'finance2',
            name: 'è´¢åŠ¡äºŒéƒ¨',
            children: [
              { id: 'finance2-1', name: 'ç¨åŠ¡ç»„' },
              { id: 'finance2-2', name: 'é¢„ç®—ç»„' }
            ]
          }
        ]
      }
    ]
  };

  // å­˜å‚¨èŠ‚ç‚¹çŠ¶æ€
  const nodeStates = {};
  let contextMenu = null;

  // åˆå§‹åŒ–é»˜è®¤çŠ¶æ€
  function initializeStates(node) {
    nodeStates[node.id] = {
      explicit: null, // æ˜¾å¼è®¾ç½®çš„çŠ¶æ€
      inherited: null // ç»§æ‰¿çš„çŠ¶æ€
    };

    if (node.children) {
      node.children.forEach(child => initializeStates(child));
    }
  }

  // è®¡ç®—ç»§æ‰¿çŠ¶æ€
  function computeInheritedState(nodeId) {
    const ancestors = getAncestors(nodeId);
    for (const ancestorId of ancestors) {
      const state = nodeStates[ancestorId];
      if (state && state.explicit) {
        // åªæœ‰å®å¿ƒè®¾ç½®æ‰ä¼šè¢«ç»§æ‰¿
        if (state.explicit.includeChildren) {
          return {
            type: state.explicit.type,
            includeChildren: true, // ç»§æ‰¿çŠ¶æ€æ€»æ˜¯å®å¿ƒ
            inheritedFrom: ancestorId
          };
        }
      }
    }
    return null;
  }

  // è·å–æ‰€æœ‰ç¥–å…ˆï¼ˆç®€åŒ–å®ç°ï¼‰
  function getAncestors(nodeId) {
    const map = {
      'dev1-1': ['dev1', 'dev', 'root'],
      'dev1-2': ['dev1', 'dev', 'root'],
      'dev2-1': ['dev2', 'dev', 'root'],
      'dev2-2': ['dev2', 'dev', 'root'],
      'market1-1': ['market1', 'market', 'root'],
      'market1-2': ['market1', 'market', 'root'],
      'market2-1': ['market2', 'market', 'root'],
      'market2-2': ['market2', 'market', 'root'],
      'finance1-1': ['finance1', 'finance', 'root'],
      'finance1-2': ['finance1', 'finance', 'root'],
      'finance2-1': ['finance2', 'finance', 'root'],
      'finance2-2': ['finance2', 'finance', 'root'],
      'dev1': ['dev', 'root'],
      'dev2': ['dev', 'root'],
      'market1': ['market', 'root'],
      'market2': ['market', 'root'],
      'finance1': ['finance', 'root'],
      'finance2': ['finance', 'root'],
      'dev': ['root'],
      'market': ['root'],
      'finance': ['root']
    };
    return map[nodeId] || [];
  }

  // æ¸²æŸ“æ ‘å½¢ç»“æ„
  function renderTree(node, parentElement) {
    const nodeElement = document.createElement('div');
    nodeElement.className = 'node';
    nodeElement.dataset.id = node.id;

    const nodeContent = document.createElement('div');
    nodeContent.className = 'node-content';
    nodeContent.style.display = 'flex';
    nodeContent.style.alignItems = 'center';
    nodeContent.style.width = '100%';

    const toggle = document.createElement('div');
    toggle.className = 'toggle';
    if (node.children && node.children.length > 0) {
      toggle.textContent = 'â–¶';
      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleChildren(nodeElement);
      });
    } else {
      toggle.textContent = 'â€¢';
      toggle.style.color = '#aaa';
      toggle.style.fontSize = '1.5rem';
      toggle.style.lineHeight = '1';
    }

    const selector = document.createElement('div');
    selector.className = 'selector';
    selector.dataset.id = node.id;

    const label = document.createElement('div');
    label.className = 'node-label';
    label.textContent = node.name;

    // çŠ¶æ€æŒ‡ç¤ºå™¨
    const statusIndicator = document.createElement('span');
    statusIndicator.className = 'status-indicator';

    nodeContent.appendChild(toggle);
    nodeContent.appendChild(selector);
    nodeContent.appendChild(label);
    nodeContent.appendChild(statusIndicator);

    nodeElement.appendChild(nodeContent);
    parentElement.appendChild(nodeElement);

    // åˆå§‹åŒ–çŠ¶æ€
    if (!nodeStates[node.id]) {
      nodeStates[node.id] = {
        explicit: null,
        inherited: null
      };
    }

    // è®¡ç®—ç»§æ‰¿çŠ¶æ€
    nodeStates[node.id].inherited = computeInheritedState(node.id);

    // æ›´æ–°é€‰æ‹©å™¨çŠ¶æ€
    updateNodeAppearance(node.id);

    // æ·»åŠ äº‹ä»¶ç›‘å¬
    selector.addEventListener('click', (e) => {
      e.stopPropagation();
      showSelectorMenu(node.id, e.clientX, e.clientY);
    });

    if (node.children) {
      const childrenContainer = document.createElement('div');
      childrenContainer.className = 'children';
      nodeElement.appendChild(childrenContainer);

      node.children.forEach(child => {
        renderTree(child, childrenContainer);
      });
    }
  }

  // æ›´æ–°èŠ‚ç‚¹å¤–è§‚ - ä¿®æ­£ç»§æ‰¿çŠ¶æ€æ˜¾ç¤ºä¸ºå®å¿ƒ
  function updateNodeAppearance(nodeId) {
    const state = nodeStates[nodeId];
    const selector = document.querySelector(`.selector[data-id="${nodeId}"]`);
    const nodeElement = document.querySelector(`.node[data-id="${nodeId}"]`);
    const statusIndicator = nodeElement.querySelector('.status-indicator');

    // æ¸…é™¤æ‰€æœ‰æ ·å¼
    selector.className = 'selector';
    nodeElement.classList.remove('inherited-green', 'inherited-red');
    statusIndicator.textContent = '';
    statusIndicator.className = 'status-indicator';

    // æ˜¾å¼çŠ¶æ€ä¼˜å…ˆçº§æœ€é«˜
    if (state.explicit) {
      if (state.explicit.type === 'INCLUDE') {
        selector.classList.add(state.explicit.includeChildren ? 'green-solid' : 'green-hollow');
        statusIndicator.textContent = 'æ˜¾å¼è®¾ç½®';
        statusIndicator.classList.add('status-explicit');
      } else {
        selector.classList.add(state.explicit.includeChildren ? 'red-solid' : 'red-hollow');
        statusIndicator.textContent = 'æ˜¾å¼è®¾ç½®';
        statusIndicator.classList.add('status-explicit');
      }
    }
    // å…¶æ¬¡æ˜¾ç¤ºç»§æ‰¿çŠ¶æ€ - è¿™é‡Œæ”¹ä¸ºå®å¿ƒæ˜¾ç¤º
    else if (state.inherited) {
      if (state.inherited.type === 'INCLUDE') {
        // ç»§æ‰¿çŠ¶æ€æ€»æ˜¯æ˜¾ç¤ºä¸ºå®å¿ƒ
        selector.classList.add('green-solid');
        selector.style.opacity = '0.9';
        nodeElement.classList.add('inherited-green');
        statusIndicator.textContent = `ç»§æ‰¿è‡ª ${state.inherited.inheritedFrom}`;
        statusIndicator.classList.add('status-inherited');
      } else {
        selector.classList.add('red-solid');
        selector.style.opacity = '0.9';
        nodeElement.classList.add('inherited-red');
        statusIndicator.textContent = `ç»§æ‰¿è‡ª ${state.inherited.inheritedFrom}`;
        statusIndicator.classList.add('status-inherited');
      }
    } else {
      // é»˜è®¤çŠ¶æ€
      selector.style.border = '1px solid #ddd';
      selector.style.background = '#f9f9f9';
    }
  }

  // åˆ‡æ¢å­èŠ‚ç‚¹æ˜¾ç¤º
  function toggleChildren(nodeElement) {
    const children = nodeElement.querySelector('.children');
    if (children) {
      nodeElement.classList.toggle('expanded');
      const toggle = nodeElement.querySelector('.toggle');
      toggle.textContent = nodeElement.classList.contains('expanded') ? 'â–¼' : 'â–¶';
    }
  }

  // æ£€æŸ¥æ˜¯å¦åœ¨å®å¿ƒç»„ä¸‹è¿›è¡ŒåŒé¢œè‰²ç©ºå¿ƒæ“ä½œ
  function isRedundantHollowOperation(nodeId, action) {
    // åªæ£€æŸ¥ç©ºå¿ƒæ“ä½œ
    if (action !== 'include-self' && action !== 'exclude-self') {
      return false;
    }

    // è·å–æ“ä½œç±»å‹
    const operationType = action === 'include-self' ? 'INCLUDE' : 'EXCLUDE';

    // æ£€æŸ¥æ‰€æœ‰ç¥–å…ˆ
    const ancestors = getAncestors(nodeId);
    for (const ancestorId of ancestors) {
      const state = nodeStates[ancestorId];

      // å¦‚æœç¥–å…ˆæœ‰åŒç±»å‹çš„å®å¿ƒæ˜¾å¼è®¾ç½®
      if (state && state.explicit &&
              state.explicit.type === operationType &&
              state.explicit.includeChildren) {
        return true;
      }
    }

    return false;
  }

  // æ£€æŸ¥æ˜¯å¦å…è®¸æ’é™¤æ“ä½œ
  function isExcludeAllowed(nodeId) {
    // æ ¹èŠ‚ç‚¹ä¸å…è®¸æ’é™¤æ“ä½œ
    if (nodeId === 'root') {
      return false;
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰åŒ…å«æ“ä½œçš„ç¥–å…ˆ
    const ancestors = getAncestors(nodeId);
    for (const ancestorId of ancestors) {
      const state = nodeStates[ancestorId];
      if (state && state.explicit && state.explicit.type === 'INCLUDE') {
        return true;
      }
    }

    return false;
  }

  // æ˜¾ç¤ºé€‰æ‹©èœå•
  function showSelectorMenu(nodeId, x, y) {
    // ç§»é™¤ç°æœ‰çš„èœå•
    if (contextMenu) {
      document.body.removeChild(contextMenu);
    }

    // è·å–å½“å‰æœ‰æ•ˆçŠ¶æ€
    const effectiveState = getEffectiveState(nodeId);

    // åˆ›å»ºèœå•å…ƒç´ 
    contextMenu = document.createElement('div');
    contextMenu.className = 'selector-menu';
    contextMenu.style.position = 'fixed';
    contextMenu.style.left = `${x}px`;
    contextMenu.style.top = `${y}px`;
    contextMenu.style.background = 'white';
    contextMenu.style.border = '1px solid #ddd';
    contextMenu.style.borderRadius = '8px';
    contextMenu.style.boxShadow = '0 5px 20px rgba(0,0,0,0.15)';
    contextMenu.style.zIndex = '1000';
    contextMenu.style.padding = '10px 0';
    contextMenu.style.minWidth = '280px';

    // èœå•æ ‡é¢˜
    const title = document.createElement('div');
    title.textContent = 'é€‰æ‹©æ“ä½œç±»å‹';
    title.style.padding = '10px 15px';
    title.style.fontWeight = '600';
    title.style.borderBottom = '1px solid #eee';
    contextMenu.appendChild(title);

    // èœå•é€‰é¡¹
    const options = [
      { text: 'åŒ…å«æœ¬ç»„åŠæ‰€æœ‰å­ç»„', action: 'include-all', color: 'green', style: 'solid' },
      { text: 'ä»…åŒ…å«æœ¬ç»„', action: 'include-self', color: 'green', style: 'hollow' },
      { text: 'æ’é™¤æœ¬ç»„åŠæ‰€æœ‰å­ç»„', action: 'exclude-all', color: 'red', style: 'solid' },
      { text: 'ä»…æ’é™¤æœ¬ç»„', action: 'exclude-self', color: 'red', style: 'hollow' },
      { text: 'æ¸…é™¤è®¾ç½®', action: 'clear' }
    ];

    // æ·»åŠ åˆ†éš”çº¿
    const divider = document.createElement('div');
    divider.style.height = '1px';
    divider.style.background = '#eee';
    divider.style.margin = '5px 0';

    options.forEach((opt, index) => {
      if (index === 2) {
        contextMenu.appendChild(divider.cloneNode(true));
      }

      const option = document.createElement('div');
      option.className = 'menu-option';
      option.style.padding = '12px 15px';
      option.style.cursor = 'pointer';
      option.style.display = 'flex';
      option.style.alignItems = 'center';
      option.style.transition = 'background 0.2s';

      // æ£€æŸ¥æ˜¯å¦ç¦ç”¨è¯¥æ“ä½œ
      let disabled = false;
      let reason = '';

      // è§„åˆ™1: æ£€æŸ¥æ˜¯å¦åœ¨å®å¿ƒç»„ä¸‹è¿›è¡ŒåŒé¢œè‰²ç©ºå¿ƒæ“ä½œ
      if (isRedundantHollowOperation(nodeId, opt.action)) {
        disabled = true;
        reason = 'çˆ¶ç»„å·²è®¾ç½®å…¨å±€æ“ä½œï¼Œæ­¤æ“ä½œå†—ä½™';
      }
      // è§„åˆ™2: æ£€æŸ¥ç»§æ‰¿çŠ¶æ€ä¸‹çš„å†—ä½™å…¨å±€æ“ä½œ
      else if (effectiveState.source === 'inherited') {
        if (effectiveState.type === 'INCLUDE' && opt.action === 'include-all') {
          disabled = true;
          reason = 'å·²ç»§æ‰¿åŒ…å«çŠ¶æ€ï¼Œæ— éœ€é‡å¤æ“ä½œ';
        }
        if (effectiveState.type === 'EXCLUDE' && opt.action === 'exclude-all') {
          disabled = true;
          reason = 'å·²ç»§æ‰¿æ’é™¤çŠ¶æ€ï¼Œæ— éœ€é‡å¤æ“ä½œ';
        }
      }

      // è§„åˆ™3: æ’é™¤æ“ä½œå¿…é¡»ä½äºåŒ…å«æ“ä½œçš„å­æ ‘ä¸‹æ–¹
      if (opt.action === 'exclude-all' || opt.action === 'exclude-self') {
        if (!isExcludeAllowed(nodeId)) {
          disabled = true;
          reason = 'æ’é™¤æ“ä½œå¿…é¡»ä½äºåŒ…å«æ“ä½œçš„å­æ ‘ä¸‹æ–¹';
        }
      }

      // è§„åˆ™4: æ ¹èŠ‚ç‚¹(root)ä¸å…è®¸è®¾ç½®æ’é™¤çŠ¶æ€
      if (nodeId === 'root' && (opt.action === 'exclude-all' || opt.action === 'exclude-self')) {
        disabled = true;
        reason = 'æ ¹èŠ‚ç‚¹ä¸å…è®¸è®¾ç½®æ’é™¤çŠ¶æ€';
      }

      if (opt.color) {
        const colorBox = document.createElement('div');
        colorBox.style.width = '18px';
        colorBox.style.height = '18px';
        colorBox.style.marginRight = '12px';
        colorBox.style.borderRadius = '4px';

        if (opt.color === 'green') {
          colorBox.style.border = opt.style === 'solid'
                  ? '2px solid var(--green-solid)'
                  : '1px dashed var(--green-solid)';
          colorBox.style.background = opt.style === 'solid'
                  ? 'var(--green-bg)'
                  : 'white';
        } else {
          colorBox.style.border = opt.style === 'solid'
                  ? '2px solid var(--red-solid)'
                  : '1px dashed var(--red-solid)';
          colorBox.style.background = opt.style === 'solid'
                  ? 'var(--red-bg)'
                  : 'white';
        }

        option.appendChild(colorBox);
      }

      const text = document.createElement('span');
      text.textContent = opt.text;
      text.style.flex = '1';
      option.appendChild(text);

      if (disabled) {
        option.classList.add('disabled');
        option.style.opacity = '0.5';
        option.style.cursor = 'not-allowed';

        const tooltip = document.createElement('div');
        tooltip.textContent = 'ğŸš« ' + reason;
        tooltip.style.fontSize = '0.8rem';
        tooltip.style.color = '#ff4d4f';
        tooltip.style.marginLeft = '10px';
        option.appendChild(tooltip);
      } else {
        option.addEventListener('mouseenter', () => {
          option.style.background = '#f8f9fa';
        });
        option.addEventListener('mouseleave', () => {
          option.style.background = 'transparent';
        });
        option.addEventListener('click', () => {
          handleSelection(nodeId, opt.action);
          document.body.removeChild(contextMenu);
          contextMenu = null;
        });
      }

      contextMenu.appendChild(option);
    });

    document.body.appendChild(contextMenu);

    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
    const closeMenu = (e) => {
      if (contextMenu && !contextMenu.contains(e.target)) {
        document.body.removeChild(contextMenu);
        contextMenu = null;
        document.removeEventListener('click', closeMenu);
      }
    };

    setTimeout(() => {
      document.addEventListener('click', closeMenu);
    }, 100);
  }

  // è·å–å½“å‰æœ‰æ•ˆçŠ¶æ€
  function getEffectiveState(nodeId) {
    const state = nodeStates[nodeId];

    if (state.explicit) {
      return {
        type: state.explicit.type,
        includeChildren: state.explicit.includeChildren,
        source: 'explicit'
      };
    }

    if (state.inherited) {
      return {
        type: state.inherited.type,
        includeChildren: true, // ç»§æ‰¿çŠ¶æ€æ€»æ˜¯å®å¿ƒ
        source: 'inherited'
      };
    }

    return {
      type: 'EXCLUDE',
      includeChildren: false,
      source: 'default'
    };
  }

  // å¤„ç†é€‰æ‹©
  function handleSelection(nodeId, action) {
    const state = nodeStates[nodeId];

    switch (action) {
      case 'include-all':
        state.explicit = { type: 'INCLUDE', includeChildren: true };
        showFeedback('åŒ…å«æœ¬ç»„åŠæ‰€æœ‰å­ç»„æ“ä½œå·²åº”ç”¨', 'success');
        break;
      case 'include-self':
        state.explicit = { type: 'INCLUDE', includeChildren: false };
        showFeedback('ä»…åŒ…å«æœ¬ç»„æ“ä½œå·²åº”ç”¨', 'success');
        break;
      case 'exclude-all':
        state.explicit = { type: 'EXCLUDE', includeChildren: true };
        showFeedback('æ’é™¤æœ¬ç»„åŠæ‰€æœ‰å­ç»„æ“ä½œå·²åº”ç”¨', 'success');
        break;
      case 'exclude-self':
        state.explicit = { type: 'EXCLUDE', includeChildren: false };
        showFeedback('ä»…æ’é™¤æœ¬ç»„æ“ä½œå·²åº”ç”¨', 'success');
        break;
      case 'clear':
        state.explicit = null;
        showFeedback('è®¾ç½®å·²æ¸…é™¤', 'success');
        break;
    }

    // æ›´æ–°å½“å‰èŠ‚ç‚¹
    updateNodeAppearance(nodeId);

    // æ›´æ–°æ‰€æœ‰åä»£èŠ‚ç‚¹çš„ç»§æ‰¿çŠ¶æ€
    updateDescendants(nodeId);
  }

  // æ›´æ–°æ‰€æœ‰åä»£èŠ‚ç‚¹
  function updateDescendants(nodeId) {
    const descendants = getAllDescendants(nodeId);
    descendants.forEach(descId => {
      nodeStates[descId].inherited = computeInheritedState(descId);
      updateNodeAppearance(descId);
    });
  }

  // è·å–æ‰€æœ‰åä»£
  function getAllDescendants(nodeId) {
    const map = {
      'root': ['dev', 'market', 'finance', 'dev1', 'dev2', 'market1', 'market2', 'finance1', 'finance2',
        'dev1-1', 'dev1-2', 'dev2-1', 'dev2-2', 'market1-1', 'market1-2', 'market2-1', 'market2-2',
        'finance1-1', 'finance1-2', 'finance2-1', 'finance2-2'],
      'dev': ['dev1', 'dev2', 'dev1-1', 'dev1-2', 'dev2-1', 'dev2-2'],
      'market': ['market1', 'market2', 'market1-1', 'market1-2', 'market2-1', 'market2-2'],
      'finance': ['finance1', 'finance2', 'finance1-1', 'finance1-2', 'finance2-1', 'finance2-2'],
      'dev1': ['dev1-1', 'dev1-2'],
      'dev2': ['dev2-1', 'dev2-2'],
      'market1': ['market1-1', 'market1-2'],
      'market2': ['market2-1', 'market2-2'],
      'finance1': ['finance1-1', 'finance1-2'],
      'finance2': ['finance2-1', 'finance2-2']
    };
    return map[nodeId] || [];
  }

  // è·å–æœ€ç»ˆç»‘å®šé…ç½®ï¼ˆæ¸…ç†å†—ä½™ï¼‰
  function getFinalBindings() {
    const bindings = [];

    for (const nodeId in nodeStates) {
      const state = nodeStates[nodeId];
      if (state.explicit) {
        // æ£€æŸ¥æ˜¯å¦è¢«ç¥–å…ˆè¦†ç›–
        const ancestors = getAncestors(nodeId);
        let isRedundant = false;

        for (const ancestorId of ancestors) {
          const ancestorState = nodeStates[ancestorId];
          if (ancestorState && ancestorState.explicit &&
                  ancestorState.explicit.includeChildren &&
                  ancestorState.explicit.type === state.explicit.type) {
            isRedundant = true;
            break;
          }
        }

        if (!isRedundant) {
          bindings.push({
            terminal_group_id: nodeId,
            type: state.explicit.type,
            include_children: state.explicit.includeChildren
          });
        }
      }
    }

    return bindings;
  }

  // æ˜¾ç¤ºåé¦ˆæ¶ˆæ¯
  function showFeedback(message, type) {
    const feedback = document.getElementById('feedback');
    const messageEl = document.getElementById('feedback-message');

    messageEl.textContent = message;
    feedback.className = 'feedback ' + type;
    feedback.classList.add('show');

    setTimeout(() => {
      feedback.classList.remove('show');
    }, 3000);
  }

  // åˆå§‹åŒ–æ ‘
  document.addEventListener('DOMContentLoaded', () => {
    const treeRoot = document.getElementById('tree-root');

    // åˆå§‹åŒ–çŠ¶æ€
    initializeStates(treeData);

    // è®¾ç½®æ ¹èŠ‚ç‚¹é»˜è®¤çŠ¶æ€
    nodeStates['root'].explicit = { type: 'INCLUDE', includeChildren: true };

    // è®¾ç½®å‡ ä¸ªç¤ºä¾‹èŠ‚ç‚¹çŠ¶æ€
    nodeStates['dev'].explicit = { type: 'INCLUDE', includeChildren: true };
    nodeStates['market'].explicit = { type: 'EXCLUDE', includeChildren: true };
    nodeStates['finance2'].explicit = { type: 'EXCLUDE', includeChildren: true };

    // æ¸²æŸ“æ ‘
    renderTree(treeData, treeRoot);

    // æ›´æ–°æ‰€æœ‰èŠ‚ç‚¹çš„ç»§æ‰¿çŠ¶æ€
    for (const nodeId in nodeStates) {
      nodeStates[nodeId].inherited = computeInheritedState(nodeId);
      updateNodeAppearance(nodeId);
    }

    // å±•å¼€æ ¹èŠ‚ç‚¹
    document.querySelector(`.node[data-id="root"]`).classList.add('expanded');

    // ä¿å­˜æŒ‰é’®äº‹ä»¶
    document.getElementById('saveBtn').addEventListener('click', () => {
      const bindings = getFinalBindings();
      document.getElementById('output').textContent =
              'æœ€ç»ˆç»‘å®šé…ç½®ï¼ˆå·²æ¸…ç†å†—ä½™ï¼‰:\n' + JSON.stringify(bindings, null, 2);
      showFeedback('é…ç½®å·²ä¿å­˜å¹¶æ¸…ç†å†—ä½™', 'success');
    });

    // é‡ç½®æŒ‰é’®äº‹ä»¶
    document.getElementById('resetBtn').addEventListener('click', () => {
      for (const nodeId in nodeStates) {
        if (nodeId !== 'root') {
          nodeStates[nodeId].explicit = null;
        }
      }

      // ç¡®ä¿æ ¹èŠ‚ç‚¹æ¢å¤åŒ…å«çŠ¶æ€
      nodeStates['root'].explicit = { type: 'INCLUDE', includeChildren: true };

      // æ›´æ–°æ‰€æœ‰èŠ‚ç‚¹
      for (const nodeId in nodeStates) {
        nodeStates[nodeId].inherited = computeInheritedState(nodeId);
        updateNodeAppearance(nodeId);
      }

      document.getElementById('output').textContent = 'é…ç½®å·²é‡ç½®';
      showFeedback('æ‰€æœ‰è®¾ç½®å·²é‡ç½®', 'success');
    });

    // å¯¼å‡ºæŒ‰é’®äº‹ä»¶
    document.getElementById('exportBtn').addEventListener('click', () => {
      const bindings = getFinalBindings();
      const dataStr = JSON.stringify(bindings, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

      const exportFileDefaultName = 'ç»‘å®šé…ç½®.json';

      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();

      showFeedback('é…ç½®å·²å¯¼å‡º', 'success');
    });
  });
</script>
</body>
</html>