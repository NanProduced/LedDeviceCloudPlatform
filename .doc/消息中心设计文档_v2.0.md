# 消息中心设计文档

## 文档信息
- **项目名称**: LedDeviceCloudPlatform 消息中心组件
- **文档版本**: v2.0
- **创建日期**: 2025-01-20
- **文档作者**: 系统架构组
- **最后更新**: 2025-01-20
- **更新说明**: 采用RabbitMQ作为消息队列中间件，优化大型项目事件处理架构

---

## 1. 项目概述

### 1.1 项目背景
LedDeviceCloudPlatform 作为物联网 LED 设备控制平台，需要一个统一的消息中心来处理系统通知、业务消息、告警信息等各类消息的实时推送和管理。消息中心将为平台提供完整的消息服务能力，支持实时通信、消息持久化、多租户隔离等核心功能。

### 1.2 设计目标
- **实时性**: 用户在线时能够立即接收到消息推送
- **可靠性**: 消息持久化存储，确保消息不丢失
- **可扩展性**: 支持高并发用户和大量消息处理
- **多租户**: 支持组织级别的消息隔离和权限控制
- **通用性**: 提供标准化的WebSocket接口，适配各种前端框架
- **事件驱动**: 支持复杂的事件响应和业务流程自动化

### 1.3 业务需求
1. **系统消息推送**: 系统维护通知、公告等
2. **业务消息**: 任务提醒、设备状态变更、权限变更等
3. **告警消息**: 设备故障、安全警告等紧急消息
4. **设备事件**: 设备上线/下线、状态变更、数据采集等
5. **用户事件**: 用户登录/登出、权限变更、行为跟踪等
6. **业务事件**: 任务创建/完成、工作流状态变更、数据同步等
7. **消息管理**: 消息查询、标记已读、批量操作等
8. **消息模板**: 支持消息模板化，提高消息发送效率
9. **事件驱动**: 支持复杂的事件响应和业务流程自动化

---

## 2. 系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              消息中心系统架构 (v2.0)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────┐                    ┌─────────────────────────────┐ │
│  │    前端应用层        │                    │        网关层               │ │
│  │                     │       WebSocket     │                             │ │
│  │  ┌─────────────────┐ │ ◄─────────────────► │  ┌─────────────────────────┐ │ │
│  │  │   Vue/React     │ │                    │  │   Spring Cloud Gateway │ │ │
│  │  │   Angular       │ │                    │  │                         │ │ │
│  │  │   Mobile App    │ │                    │  │ - WebSocket 代理        │ │ │
│  │  └─────────────────┘ │                    │  │ - 负载均衡              │ │ │
│  └─────────────────────┘                    │  │ - 认证集成              │ │ │
│                                               │  └─────────────────────────┘ │ │
├─────────────────────────────────────────────────────────────────────────────┤
│                              微服务层                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                       Business Services                                 │ │
│  │                                                                         │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │ │
│  │  │  core-service   │  │terminal-service │  │      auth-service       │ │ │
│  │  │                 │  │                 │  │                         │ │ │
│  │  │ - 用户管理      │  │ - 设备通信      │  │ - 认证授权             │ │ │
│  │  │ - 权限管理      │  │ - 协议处理      │  │ - 用户管理             │ │ │
│  │  │ - 设备管理      │  │ - 数据采集      │  │ - 令牌管理             │ │ │
│  │  │ - 业务逻辑      │  │ - 状态监控      │  │                         │ │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                      │ Event Publishing                    │
│                                      ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        RabbitMQ Message Broker                         │ │
│  │                                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                     Topic Exchanges                                 │ │ │
│  │  │                                                                     │ │ │
│  │  │ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────────────┐ │ │ │
│  │  │ │  device.topic   │ │  user.topic     │ │    message.topic        │ │ │ │
│  │  │ │                 │ │                 │ │                         │ │ │ │
│  │  │ │ - 设备事件路由   │ │ - 用户事件路由   │ │ - 消息事件路由          │ │ │ │
│  │  │ │ - 告警事件      │ │ - 权限变更      │ │ - 实时推送             │ │ │ │
│  │  │ └─────────────────┘ └─────────────────┘ └─────────────────────────┘ │ │ │
│  │  │                                                                     │ │ │
│  │  │ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────────────┐ │ │ │
│  │  │ │ business.topic  │ │ system.topic    │ │    dead.letter          │ │ │ │
│  │  │ │                 │ │                 │ │                         │ │ │ │
│  │  │ │ - 业务事件路由   │ │ - 系统事件路由   │ │ - 失败消息处理          │ │ │ │
│  │  │ │ - 工作流触发    │ │ - 维护通知      │ │ - 重试机制             │ │ │ │
│  │  │ └─────────────────┘ └─────────────────┘ └─────────────────────────┘ │ │ │
│  │  └─────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                      │ Event Consuming                     │
│                                      ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        Message Service                                  │ │
│  │                                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │ │
│  │  │              Event Processing & WebSocket Center                     │ │ │
│  │  │                                                                     │ │ │
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐ │ │ │
│  │  │  │ Event Consumers │  │  Message Logic  │  │   WebSocket Hub     │ │ │ │
│  │  │  │                 │  │                 │  │                     │ │ │ │
│  │  │  │ - 实时消息处理   │  │ - 消息路由      │  │ - 连接管理          │ │ │ │
│  │  │  │ - 设备事件处理   │  │ - 模板引擎      │  │ - 会话管理          │ │ │ │
│  │  │  │ - 用户事件处理   │  │ - 状态管理      │  │ - 实时推送          │ │ │ │
│  │  │  │ - 业务事件处理   │  │ - 统计分析      │  │ - 在线用户管理      │ │ │ │
│  │  │  └─────────────────┘  └─────────────────┘  └─────────────────────┘ │ │ │
│  │  └─────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│                              数据存储层                                      │
│                                                                             │
│  ┌─────────────────────────────────────────┐  ┌─────────────────────────────┐ │
│  │              MongoDB                    │  │           Redis             │ │
│  │                                         │  │                             │ │
│  │  ┌─────────────────────────────────────┐ │  │  ┌─────────────────────────┐ │ │
│  │  │         消息存储                     │ │  │  │      在线用户管理       │ │ │
│  │  │                                     │ │  │  │                         │ │ │
│  │  │ - 消息文档 (messages)               │ │  │  │ - 在线用户集合          │ │ │
│  │  │ - 消息模板 (templates)              │ │  │  │ - WebSocket会话         │ │ │
│  │  │ - 用户消息状态 (user_message_status)│ │  │  │ - 用户状态缓存          │ │ │
│  │  │ - 事件日志 (event_logs)             │ │  │  │ - 心跳检测             │ │ │
│  │  │ - 消息统计 (message_stats)          │ │  │  │ - 消息计数缓存          │ │ │
│  │  └─────────────────────────────────────┘ │  │  └─────────────────────────┘ │ │
│  │                                         │  │                             │ │
│  │  ┌─────────────────────────────────────┐ │  │  ┌─────────────────────────┐ │ │
│  │  │         索引策略                     │ │  │  │      分布式锁           │ │ │
│  │  │                                     │ │  │  │                         │ │ │
│  │  │ - 用户ID + 创建时间 (复合索引)       │ │  │  │ - 消息发送锁            │ │ │
│  │  │ - 组织ID + 消息类型 (复合索引)       │ │  │  │ - 会话管理锁            │ │ │
│  │  │ - 事件类型 + 时间戳 (复合索引)       │ │  │  │ - 缓存更新锁            │ │ │
│  │  │ - 全文搜索索引                      │ │  │  │ - 限流控制锁            │ │ │
│  │  └─────────────────────────────────────┘ │  │  └─────────────────────────┘ │ │
│  └─────────────────────────────────────────┘  └─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 技术选型

#### 2.2.1 核心框架
- **Spring Boot 3.3.11**: 应用基础框架
- **Spring Cloud 2023.0.5**: 微服务治理
- **Spring WebSocket**: WebSocket支持
- **STOMP协议**: 消息传输协议
- **Spring AMQP**: RabbitMQ集成
- **Spring Cloud Stream**: 消息驱动微服务框架

#### 2.2.2 消息队列中间件
- **RabbitMQ 3.12+**: 企业级消息队列
  - 高可靠性消息传递
  - 支持复杂路由规则（Topic Exchange）
  - 死信队列和重试机制
  - 集群支持和高可用
  - Web管理界面和监控
  - 消息确认和持久化

#### 2.2.3 数据存储
- **MongoDB 5.0+**: 消息持久化存储
  - 文档型数据库，适合消息的灵活结构
  - 支持复杂查询和聚合操作
  - 水平扩展能力强
- **Redis 6.0+**: 缓存和会话管理
  - 在线用户状态管理
  - WebSocket会话存储
  - 分布式锁和缓存

#### 2.2.4 通信协议
- **WebSocket + STOMP**: 实时通信
- **HTTP/HTTPS**: REST API
- **AMQP 0.9.1**: RabbitMQ消息协议
- **JSON**: 数据序列化格式

### 2.3 服务启动配置

```bash
# 服务启动顺序和端口分配
mvn spring-boot:run -pl gateway                      # 网关服务 (8080)
mvn spring-boot:run -pl auth-server/auth-boot        # 认证服务 (8081)
mvn spring-boot:run -pl core-service/core-boot       # 核心服务 (8082)
mvn spring-boot:run -pl message-service/message-boot # 消息服务 (8084)

# 未来扩展
mvn spring-boot:run -pl terminal-service/terminal-boot # 终端服务 (8083)
```

### 2.4 服务间通信

```
前端应用 ──WebSocket──▶ Gateway(8080) ──代理──▶ Message-Service(8084)
前端应用 ──HTTP API──▶ Gateway(8080) ──路由──▶ Core-Service(8082)

Core-Service(8082) ──RabbitMQ事件──▶ Message-Service(8084)
Terminal-Service(8083) ──RabbitMQ事件──▶ Message-Service(8084)

Message-Service(8084) ──WebSocket推送──▶ 前端应用
```

---

## 3. 模块设计

### 3.1 模块结构

```
message-service/                      # 独立消息服务
├── message-api/                      # API定义模块
│   ├── src/main/java/
│   │   └── org/nan/cloud/message/api/
│   │       ├── dto/                  # 数据传输对象
│   │       │   ├── request/          # 请求DTO
│   │       │   ├── response/         # 响应DTO
│   │       │   ├── websocket/        # WebSocket消息DTO
│   │       │   └── event/            # 事件DTO
│   │       ├── enums/                # 枚举定义
│   │       │   ├── MessageType.java  # 消息类型
│   │       │   ├── EventType.java    # 事件类型
│   │       │   └── Priority.java     # 优先级
│   │       ├── service/              # 服务接口定义
│   │       ├── event/                # 事件定义
│   │       │   ├── BaseEvent.java    # 基础事件
│   │       │   ├── DeviceEvent.java  # 设备事件
│   │       │   ├── UserEvent.java    # 用户事件
│   │       │   └── MessageEvent.java # 消息事件
│   │       └── constants/            # 常量定义
│   │           └── MessageRoutingKeys.java # 路由键定义
│   └── pom.xml
│
├── message-application/              # 应用业务逻辑模块
│   ├── src/main/java/
│   │   └── org/nan/cloud/message/
│   │       ├── service/              # 业务服务实现
│   │       │   ├── impl/
│   │       │   ├── MessageService.java
│   │       │   ├── MessageTemplateService.java
│   │       │   ├── MessageStatisticsService.java
│   │       │   └── EventProcessorService.java
│   │       ├── domain/               # 领域模型
│   │       │   ├── Message.java
│   │       │   ├── MessageTemplate.java
│   │       │   ├── MessageStatus.java
│   │       │   └── EventLog.java
│   │       ├── repository/           # 仓储接口
│   │       ├── event/                # 领域事件
│   │       │   ├── handler/          # 事件处理器
│   │       │   ├── producer/         # 事件生产者
│   │       │   └── consumer/         # 事件消费者
│   │       └── processor/            # 消息处理器
│   └── pom.xml
│
├── message-infrastructure/           # 基础设施模块
│   ├── src/main/java/
│   │   └── org/nan/cloud/message/infrastructure/
│   │       ├── mongodb/              # MongoDB相关
│   │       │   ├── document/         # 文档实体
│   │       │   ├── repository/       # 仓储实现
│   │       │   └── config/           # MongoDB配置
│   │       ├── redis/                # Redis相关
│   │       │   ├── manager/          # Redis管理器
│   │       │   └── config/           # Redis配置
│   │       ├── rabbitmq/             # RabbitMQ相关
│   │       │   ├── config/           # RabbitMQ配置
│   │       │   ├── producer/         # 消息生产者
│   │       │   ├── consumer/         # 消息消费者
│   │       │   ├── exchange/         # 交换器配置
│   │       │   └── queue/            # 队列配置
│   │       ├── websocket/            # WebSocket相关
│   │       │   ├── handler/          # 消息处理器
│   │       │   ├── manager/          # 会话管理器
│   │       │   ├── router/           # 消息路由器
│   │       │   └── config/           # WebSocket配置
│   │       └── external/             # 外部系统集成
│   └── pom.xml
│
├── message-boot/                     # 启动配置模块
│   ├── src/main/java/
│   │   └── org/nan/cloud/message/
│   │       ├── controller/           # REST控制器
│   │       ├── facade/               # 应用门面
│   │       ├── config/               # 配置类
│   │       └── MessageApplication.java
│   ├── src/main/resources/
│   │   ├── application.yml
│   │   ├── application-dev.yml
│   │   ├── application-prod.yml
│   │   └── rabbitmq/                # RabbitMQ配置文件
│   │       ├── exchanges.json       # 交换器定义
│   │       ├── queues.json          # 队列定义
│   │       └── bindings.json        # 绑定关系定义
│   └── pom.xml
│
└── pom.xml                           # 父模块POM
```

---

## 4. RabbitMQ部署指南

### 4.1 生产环境部署方案

#### 4.1.1 Docker Compose部署（推荐）

**创建目录结构**:
```bash
mkdir -p /opt/rabbitmq/{data,logs,config}
chmod 755 /opt/rabbitmq/{data,logs,config}
```

**docker-compose.yml配置**:
```yaml
version: '3.8'

services:
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: rabbitmq-server
    hostname: rabbitmq-node1
    restart: unless-stopped
    
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123456
      RABBITMQ_DEFAULT_VHOST: /led-platform
      
    ports:
      - "5672:5672"    # AMQP端口
      - "15672:15672"  # 管理界面端口
      - "25672:25672"  # 集群通信端口
      
    volumes:
      - /opt/rabbitmq/data:/var/lib/rabbitmq
      - /opt/rabbitmq/logs:/var/log/rabbitmq
      - /opt/rabbitmq/config:/etc/rabbitmq
      
    networks:
      - rabbitmq-network
      
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  rabbitmq-network:
    driver: bridge
```

**启动命令**:
```bash
# 启动RabbitMQ
docker-compose up -d

# 检查运行状态
docker-compose ps

# 查看日志
docker-compose logs -f rabbitmq
```

#### 4.1.2 集群部署配置

**集群docker-compose.yml**:
```yaml
version: '3.8'

services:
  rabbitmq-node1:
    image: rabbitmq:3.12-management
    container_name: rabbitmq-node1
    hostname: rabbitmq-node1
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123456
      RABBITMQ_ERLANG_COOKIE: rabbitmq-cluster-cookie
      RABBITMQ_DEFAULT_VHOST: /led-platform
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-node1-data:/var/lib/rabbitmq
    networks:
      - rabbitmq-cluster
      
  rabbitmq-node2:
    image: rabbitmq:3.12-management
    container_name: rabbitmq-node2
    hostname: rabbitmq-node2
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123456
      RABBITMQ_ERLANG_COOKIE: rabbitmq-cluster-cookie
      RABBITMQ_DEFAULT_VHOST: /led-platform
    ports:
      - "5673:5672"
      - "15673:15672"
    volumes:
      - rabbitmq-node2-data:/var/lib/rabbitmq
    networks:
      - rabbitmq-cluster
    depends_on:
      - rabbitmq-node1
      
  rabbitmq-node3:
    image: rabbitmq:3.12-management
    container_name: rabbitmq-node3
    hostname: rabbitmq-node3
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123456
      RABBITMQ_ERLANG_COOKIE: rabbitmq-cluster-cookie
      RABBITMQ_DEFAULT_VHOST: /led-platform
    ports:
      - "5674:5672"
      - "15674:15672"
    volumes:
      - rabbitmq-node3-data:/var/lib/rabbitmq
    networks:
      - rabbitmq-cluster
    depends_on:
      - rabbitmq-node1

volumes:
  rabbitmq-node1-data:
  rabbitmq-node2-data:
  rabbitmq-node3-data:

networks:
  rabbitmq-cluster:
    driver: bridge
```

**集群初始化脚本**:
```bash
#!/bin/bash

# 等待所有节点启动
sleep 30

# 将node2加入集群
docker exec rabbitmq-node2 rabbitmqctl stop_app
docker exec rabbitmq-node2 rabbitmqctl reset
docker exec rabbitmq-node2 rabbitmqctl join_cluster rabbit@rabbitmq-node1
docker exec rabbitmq-node2 rabbitmqctl start_app

# 将node3加入集群
docker exec rabbitmq-node3 rabbitmqctl stop_app
docker exec rabbitmq-node3 rabbitmqctl reset
docker exec rabbitmq-node3 rabbitmqctl join_cluster rabbit@rabbitmq-node1
docker exec rabbitmq-node3 rabbitmqctl start_app

# 检查集群状态
docker exec rabbitmq-node1 rabbitmqctl cluster_status

# 设置高可用策略
docker exec rabbitmq-node1 rabbitmqctl set_policy ha-all ".*" '{"ha-mode":"all"}'

echo "RabbitMQ集群部署完成！"
```

#### 4.1.3 Kubernetes部署

**rabbitmq-statefulset.yaml**:
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rabbitmq
  namespace: led-platform
spec:
  serviceName: rabbitmq-headless
  replicas: 3
  selector:
    matchLabels:
      app: rabbitmq
  template:
    metadata:
      labels:
        app: rabbitmq
    spec:
      containers:
      - name: rabbitmq
        image: rabbitmq:3.12-management
        env:
        - name: RABBITMQ_DEFAULT_USER
          value: "admin"
        - name: RABBITMQ_DEFAULT_PASS
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secret
              key: password
        - name: RABBITMQ_ERLANG_COOKIE
          value: "rabbitmq-cluster-cookie"
        - name: RABBITMQ_DEFAULT_VHOST
          value: "/led-platform"
        ports:
        - containerPort: 5672
          name: amqp
        - containerPort: 15672
          name: management
        volumeMounts:
        - name: rabbitmq-data
          mountPath: /var/lib/rabbitmq
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
  volumeClaimTemplates:
  - metadata:
      name: rabbitmq-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi
```

### 4.2 配置优化

#### 4.2.1 性能配置

**rabbitmq.conf**:
```
# 内存配置
vm_memory_high_watermark.relative = 0.6
vm_memory_high_watermark_paging_ratio = 0.5

# 磁盘配置
disk_free_limit.relative = 1.0

# 网络配置
num_acceptors.tcp = 10
handshake_timeout = 10000

# 集群配置
cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config
cluster_formation.classic_config.nodes.1 = rabbit@rabbitmq-node1
cluster_formation.classic_config.nodes.2 = rabbit@rabbitmq-node2
cluster_formation.classic_config.nodes.3 = rabbit@rabbitmq-node3

# 日志配置
log.console = true
log.console.level = info
log.file = /var/log/rabbitmq/rabbit.log
log.file.level = info
```

#### 4.2.2 安全配置

**创建SSL证书**:
```bash
# 生成CA证书
openssl genrsa -out ca-key.pem 4096
openssl req -new -x509 -days 365 -key ca-key.pem -sha256 -out ca.pem

# 生成服务器证书
openssl genrsa -out server-key.pem 4096
openssl req -subj "/CN=rabbitmq-server" -sha256 -new -key server-key.pem -out server.csr
openssl x509 -req -days 365 -sha256 -in server.csr -CA ca.pem -CAkey ca-key.pem -out server-cert.pem

# 生成客户端证书
openssl genrsa -out client-key.pem 4096
openssl req -subj '/CN=rabbitmq-client' -new -key client-key.pem -out client.csr
openssl x509 -req -days 365 -sha256 -in client.csr -CA ca.pem -CAkey ca-key.pem -out client-cert.pem
```

### 4.3 监控和运维

#### 4.3.1 健康检查脚本

**health-check.sh**:
```bash
#!/bin/bash

# RabbitMQ健康检查
RABBITMQ_HOST="localhost"
RABBITMQ_PORT="15672"
RABBITMQ_USER="admin"
RABBITMQ_PASS="admin123456"

# 检查管理接口
response=$(curl -s -o /dev/null -w "%{http_code}" \
  -u $RABBITMQ_USER:$RABBITMQ_PASS \
  http://$RABBITMQ_HOST:$RABBITMQ_PORT/api/overview)

if [ $response -eq 200 ]; then
  echo "✅ RabbitMQ管理接口正常"
else
  echo "❌ RabbitMQ管理接口异常，状态码: $response"
  exit 1
fi

# 检查集群状态
cluster_status=$(docker exec rabbitmq-node1 rabbitmqctl cluster_status --formatter json)
node_count=$(echo $cluster_status | jq '.running_nodes | length')

if [ $node_count -eq 3 ]; then
  echo "✅ RabbitMQ集群节点正常 ($node_count/3)"
else
  echo "⚠️  RabbitMQ集群节点异常 ($node_count/3)"
fi

# 检查队列状态
queue_info=$(curl -s -u $RABBITMQ_USER:$RABBITMQ_PASS \
  http://$RABBITMQ_HOST:$RABBITMQ_PORT/api/queues)

echo "📊 队列统计:"
echo $queue_info | jq '.[] | {name: .name, messages: .messages, consumers: .consumers}'

echo "✅ RabbitMQ健康检查完成"
```

#### 4.3.2 Prometheus监控配置

**rabbitmq-prometheus.yml**:
```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'rabbitmq'
    static_configs:
      - targets: ['localhost:15692']
    scrape_interval: 15s
    metrics_path: /metrics
```

### 4.4 访问信息

部署完成后，你可以通过以下方式访问RabbitMQ：

- **管理界面**: http://your-server-ip:15672
- **用户名**: admin
- **密码**: admin123456
- **Virtual Host**: /led-platform
- **AMQP端口**: 5672

下一步就可以开始实现message-service的RabbitMQ集成了！

---

## 5. 总结

本消息中心设计文档全面规划了LedDeviceCloudPlatform的消息推送和管理能力。通过采用RabbitMQ作为消息队列中间件，构建了企业级的事件驱动架构，为平台提供可靠、高效、可扩展的消息服务。

### 5.1 核心优势
- **实时性强**: WebSocket长连接保证消息实时推送
- **可靠性高**: RabbitMQ提供企业级消息可靠性保障
- **扩展性好**: 微服务架构支持水平扩展
- **事件驱动**: 基于RabbitMQ的完整事件驱动架构
- **运维友好**: 完善的监控告警和管理界面
- **安全可控**: 完善的认证授权和安全防护

### 5.2 技术亮点
- **RabbitMQ集群**: 高可用消息队列集群部署
- **事件驱动架构**: 支持复杂的事件响应和业务解耦
- **Topic路由**: 灵活的消息路由和分发机制
- **死信队列**: 完善的失败消息处理和重试机制
- **多租户架构**: 支持组织级别的消息隔离
- **消息模板**: 灵活的模板引擎提高发送效率
- **统计分析**: 丰富的消息数据统计和分析

### 5.3 架构升级
相比v1.0版本，v2.0版本的主要改进：
- **消息队列**: 从Redis Streams升级到RabbitMQ企业级消息中间件
- **事件支持**: 增加了设备事件、用户事件、业务事件的完整支持
- **可靠性**: 增强了消息可靠性和失败处理机制
- **扩展性**: 更好地支持大型项目的复杂事件处理需求
- **运维性**: 提供了完善的部署、监控和运维方案

### 5.4 预期效果
通过实施本设计方案，预期达到以下效果：
- 支持大型项目的复杂事件处理需求
- 提供企业级的消息可靠性和性能保障
- 实现完整的事件驱动业务架构
- 支持未来terminal-service等新服务的快速集成
- 建立统一的消息和事件处理规范
- 提升系统的可观测性和运维效率

### 5.5 部署建议
- **开发环境**: 使用Docker Compose单节点部署
- **测试环境**: 使用Docker Compose 3节点集群
- **生产环境**: 使用Kubernetes部署高可用集群
- **监控**: 集成Prometheus + Grafana监控
- **备份**: 定期备份RabbitMQ配置和元数据

---

**文档完成日期**: 2025年1月20日  
**版本更新**: v2.0 - 采用RabbitMQ消息队列架构  
**后续更新**: 本文档将根据项目进展和需求变更及时更新