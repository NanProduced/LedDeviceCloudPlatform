# æ¶ˆæ¯ä¸­å¿ƒè®¾è®¡æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯
- **é¡¹ç›®åç§°**: LedDeviceCloudPlatform æ¶ˆæ¯ä¸­å¿ƒç»„ä»¶
- **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
- **åˆ›å»ºæ—¥æœŸ**: 2025-01-20
- **æ–‡æ¡£ä½œè€…**: ç³»ç»Ÿæ¶æ„ç»„
- **æœ€åæ›´æ–°**: 2025-01-20
- **æ›´æ–°è¯´æ˜**: é‡‡ç”¨RabbitMQä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œä¼˜åŒ–å¤§å‹é¡¹ç›®äº‹ä»¶å¤„ç†æ¶æ„

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯
LedDeviceCloudPlatform ä½œä¸ºç‰©è”ç½‘ LED è®¾å¤‡æ§åˆ¶å¹³å°ï¼Œéœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„æ¶ˆæ¯ä¸­å¿ƒæ¥å¤„ç†ç³»ç»Ÿé€šçŸ¥ã€ä¸šåŠ¡æ¶ˆæ¯ã€å‘Šè­¦ä¿¡æ¯ç­‰å„ç±»æ¶ˆæ¯çš„å®æ—¶æ¨é€å’Œç®¡ç†ã€‚æ¶ˆæ¯ä¸­å¿ƒå°†ä¸ºå¹³å°æä¾›å®Œæ•´çš„æ¶ˆæ¯æœåŠ¡èƒ½åŠ›ï¼Œæ”¯æŒå®æ—¶é€šä¿¡ã€æ¶ˆæ¯æŒä¹…åŒ–ã€å¤šç§Ÿæˆ·éš”ç¦»ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### 1.2 è®¾è®¡ç›®æ ‡
- **å®æ—¶æ€§**: ç”¨æˆ·åœ¨çº¿æ—¶èƒ½å¤Ÿç«‹å³æ¥æ”¶åˆ°æ¶ˆæ¯æ¨é€
- **å¯é æ€§**: æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨ï¼Œç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±
- **å¯æ‰©å±•æ€§**: æ”¯æŒé«˜å¹¶å‘ç”¨æˆ·å’Œå¤§é‡æ¶ˆæ¯å¤„ç†
- **å¤šç§Ÿæˆ·**: æ”¯æŒç»„ç»‡çº§åˆ«çš„æ¶ˆæ¯éš”ç¦»å’Œæƒé™æ§åˆ¶
- **é€šç”¨æ€§**: æä¾›æ ‡å‡†åŒ–çš„WebSocketæ¥å£ï¼Œé€‚é…å„ç§å‰ç«¯æ¡†æ¶
- **äº‹ä»¶é©±åŠ¨**: æ”¯æŒå¤æ‚çš„äº‹ä»¶å“åº”å’Œä¸šåŠ¡æµç¨‹è‡ªåŠ¨åŒ–

### 1.3 ä¸šåŠ¡éœ€æ±‚
1. **ç³»ç»Ÿæ¶ˆæ¯æ¨é€**: ç³»ç»Ÿç»´æŠ¤é€šçŸ¥ã€å…¬å‘Šç­‰
2. **ä¸šåŠ¡æ¶ˆæ¯**: ä»»åŠ¡æé†’ã€è®¾å¤‡çŠ¶æ€å˜æ›´ã€æƒé™å˜æ›´ç­‰
3. **å‘Šè­¦æ¶ˆæ¯**: è®¾å¤‡æ•…éšœã€å®‰å…¨è­¦å‘Šç­‰ç´§æ€¥æ¶ˆæ¯
4. **è®¾å¤‡äº‹ä»¶**: è®¾å¤‡ä¸Šçº¿/ä¸‹çº¿ã€çŠ¶æ€å˜æ›´ã€æ•°æ®é‡‡é›†ç­‰
5. **ç”¨æˆ·äº‹ä»¶**: ç”¨æˆ·ç™»å½•/ç™»å‡ºã€æƒé™å˜æ›´ã€è¡Œä¸ºè·Ÿè¸ªç­‰
6. **ä¸šåŠ¡äº‹ä»¶**: ä»»åŠ¡åˆ›å»º/å®Œæˆã€å·¥ä½œæµçŠ¶æ€å˜æ›´ã€æ•°æ®åŒæ­¥ç­‰
7. **æ¶ˆæ¯ç®¡ç†**: æ¶ˆæ¯æŸ¥è¯¢ã€æ ‡è®°å·²è¯»ã€æ‰¹é‡æ“ä½œç­‰
8. **æ¶ˆæ¯æ¨¡æ¿**: æ”¯æŒæ¶ˆæ¯æ¨¡æ¿åŒ–ï¼Œæé«˜æ¶ˆæ¯å‘é€æ•ˆç‡
9. **äº‹ä»¶é©±åŠ¨**: æ”¯æŒå¤æ‚çš„äº‹ä»¶å“åº”å’Œä¸šåŠ¡æµç¨‹è‡ªåŠ¨åŒ–

---

## 2. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ¶ˆæ¯ä¸­å¿ƒç³»ç»Ÿæ¶æ„ (v2.0)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    å‰ç«¯åº”ç”¨å±‚        â”‚                    â”‚        ç½‘å…³å±‚               â”‚ â”‚
â”‚  â”‚                     â”‚       WebSocket     â”‚                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚   Vue/React     â”‚ â”‚                    â”‚  â”‚   Spring Cloud Gateway â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   Angular       â”‚ â”‚                    â”‚  â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   Mobile App    â”‚ â”‚                    â”‚  â”‚ - WebSocket ä»£ç†        â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                    â”‚  â”‚ - è´Ÿè½½å‡è¡¡              â”‚ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  â”‚ - è®¤è¯é›†æˆ              â”‚ â”‚ â”‚
â”‚                                               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              å¾®æœåŠ¡å±‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                       Business Services                                 â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  core-service   â”‚  â”‚terminal-service â”‚  â”‚      auth-service       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - ç”¨æˆ·ç®¡ç†      â”‚  â”‚ - è®¾å¤‡é€šä¿¡      â”‚  â”‚ - è®¤è¯æˆæƒ             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - æƒé™ç®¡ç†      â”‚  â”‚ - åè®®å¤„ç†      â”‚  â”‚ - ç”¨æˆ·ç®¡ç†             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - è®¾å¤‡ç®¡ç†      â”‚  â”‚ - æ•°æ®é‡‡é›†      â”‚  â”‚ - ä»¤ç‰Œç®¡ç†             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - ä¸šåŠ¡é€»è¾‘      â”‚  â”‚ - çŠ¶æ€ç›‘æ§      â”‚  â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                      â”‚ Event Publishing                    â”‚
â”‚                                      â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        RabbitMQ Message Broker                         â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚                     Topic Exchanges                                 â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â”‚  device.topic   â”‚ â”‚  user.topic     â”‚ â”‚    message.topic        â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â”‚                 â”‚ â”‚                 â”‚ â”‚                         â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ - è®¾å¤‡äº‹ä»¶è·¯ç”±   â”‚ â”‚ - ç”¨æˆ·äº‹ä»¶è·¯ç”±   â”‚ â”‚ - æ¶ˆæ¯äº‹ä»¶è·¯ç”±          â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ - å‘Šè­¦äº‹ä»¶      â”‚ â”‚ - æƒé™å˜æ›´      â”‚ â”‚ - å®æ—¶æ¨é€             â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ business.topic  â”‚ â”‚ system.topic    â”‚ â”‚    dead.letter          â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â”‚                 â”‚ â”‚                 â”‚ â”‚                         â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ - ä¸šåŠ¡äº‹ä»¶è·¯ç”±   â”‚ â”‚ - ç³»ç»Ÿäº‹ä»¶è·¯ç”±   â”‚ â”‚ - å¤±è´¥æ¶ˆæ¯å¤„ç†          â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â”‚ - å·¥ä½œæµè§¦å‘    â”‚ â”‚ - ç»´æŠ¤é€šçŸ¥      â”‚ â”‚ - é‡è¯•æœºåˆ¶             â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                      â”‚ Event Consuming                     â”‚
â”‚                                      â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        Message Service                                  â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚              Event Processing & WebSocket Center                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ Event Consumers â”‚  â”‚  Message Logic  â”‚  â”‚   WebSocket Hub     â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                     â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ - å®æ—¶æ¶ˆæ¯å¤„ç†   â”‚  â”‚ - æ¶ˆæ¯è·¯ç”±      â”‚  â”‚ - è¿æ¥ç®¡ç†          â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ - è®¾å¤‡äº‹ä»¶å¤„ç†   â”‚  â”‚ - æ¨¡æ¿å¼•æ“      â”‚  â”‚ - ä¼šè¯ç®¡ç†          â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ - ç”¨æˆ·äº‹ä»¶å¤„ç†   â”‚  â”‚ - çŠ¶æ€ç®¡ç†      â”‚  â”‚ - å®æ—¶æ¨é€          â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ - ä¸šåŠ¡äº‹ä»¶å¤„ç†   â”‚  â”‚ - ç»Ÿè®¡åˆ†æ      â”‚  â”‚ - åœ¨çº¿ç”¨æˆ·ç®¡ç†      â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              æ•°æ®å­˜å‚¨å±‚                                      â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              MongoDB                    â”‚  â”‚           Redis             â”‚ â”‚
â”‚  â”‚                                         â”‚  â”‚                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚         æ¶ˆæ¯å­˜å‚¨                     â”‚ â”‚  â”‚  â”‚      åœ¨çº¿ç”¨æˆ·ç®¡ç†       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                     â”‚ â”‚  â”‚  â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - æ¶ˆæ¯æ–‡æ¡£ (messages)               â”‚ â”‚  â”‚  â”‚ - åœ¨çº¿ç”¨æˆ·é›†åˆ          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - æ¶ˆæ¯æ¨¡æ¿ (templates)              â”‚ â”‚  â”‚  â”‚ - WebSocketä¼šè¯         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - ç”¨æˆ·æ¶ˆæ¯çŠ¶æ€ (user_message_status)â”‚ â”‚  â”‚  â”‚ - ç”¨æˆ·çŠ¶æ€ç¼“å­˜          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - äº‹ä»¶æ—¥å¿— (event_logs)             â”‚ â”‚  â”‚  â”‚ - å¿ƒè·³æ£€æµ‹             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - æ¶ˆæ¯ç»Ÿè®¡ (message_stats)          â”‚ â”‚  â”‚  â”‚ - æ¶ˆæ¯è®¡æ•°ç¼“å­˜          â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                         â”‚  â”‚                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚         ç´¢å¼•ç­–ç•¥                     â”‚ â”‚  â”‚  â”‚      åˆ†å¸ƒå¼é”           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                     â”‚ â”‚  â”‚  â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - ç”¨æˆ·ID + åˆ›å»ºæ—¶é—´ (å¤åˆç´¢å¼•)       â”‚ â”‚  â”‚  â”‚ - æ¶ˆæ¯å‘é€é”            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - ç»„ç»‡ID + æ¶ˆæ¯ç±»å‹ (å¤åˆç´¢å¼•)       â”‚ â”‚  â”‚  â”‚ - ä¼šè¯ç®¡ç†é”            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - äº‹ä»¶ç±»å‹ + æ—¶é—´æˆ³ (å¤åˆç´¢å¼•)       â”‚ â”‚  â”‚  â”‚ - ç¼“å­˜æ›´æ–°é”            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - å…¨æ–‡æœç´¢ç´¢å¼•                      â”‚ â”‚  â”‚  â”‚ - é™æµæ§åˆ¶é”            â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯é€‰å‹

#### 2.2.1 æ ¸å¿ƒæ¡†æ¶
- **Spring Boot 3.3.11**: åº”ç”¨åŸºç¡€æ¡†æ¶
- **Spring Cloud 2023.0.5**: å¾®æœåŠ¡æ²»ç†
- **Spring WebSocket**: WebSocketæ”¯æŒ
- **STOMPåè®®**: æ¶ˆæ¯ä¼ è¾“åè®®
- **Spring AMQP**: RabbitMQé›†æˆ
- **Spring Cloud Stream**: æ¶ˆæ¯é©±åŠ¨å¾®æœåŠ¡æ¡†æ¶

#### 2.2.2 æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶
- **RabbitMQ 3.12+**: ä¼ä¸šçº§æ¶ˆæ¯é˜Ÿåˆ—
  - é«˜å¯é æ€§æ¶ˆæ¯ä¼ é€’
  - æ”¯æŒå¤æ‚è·¯ç”±è§„åˆ™ï¼ˆTopic Exchangeï¼‰
  - æ­»ä¿¡é˜Ÿåˆ—å’Œé‡è¯•æœºåˆ¶
  - é›†ç¾¤æ”¯æŒå’Œé«˜å¯ç”¨
  - Webç®¡ç†ç•Œé¢å’Œç›‘æ§
  - æ¶ˆæ¯ç¡®è®¤å’ŒæŒä¹…åŒ–

#### 2.2.3 æ•°æ®å­˜å‚¨
- **MongoDB 5.0+**: æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨
  - æ–‡æ¡£å‹æ•°æ®åº“ï¼Œé€‚åˆæ¶ˆæ¯çš„çµæ´»ç»“æ„
  - æ”¯æŒå¤æ‚æŸ¥è¯¢å’Œèšåˆæ“ä½œ
  - æ°´å¹³æ‰©å±•èƒ½åŠ›å¼º
- **Redis 6.0+**: ç¼“å­˜å’Œä¼šè¯ç®¡ç†
  - åœ¨çº¿ç”¨æˆ·çŠ¶æ€ç®¡ç†
  - WebSocketä¼šè¯å­˜å‚¨
  - åˆ†å¸ƒå¼é”å’Œç¼“å­˜

#### 2.2.4 é€šä¿¡åè®®
- **WebSocket + STOMP**: å®æ—¶é€šä¿¡
- **HTTP/HTTPS**: REST API
- **AMQP 0.9.1**: RabbitMQæ¶ˆæ¯åè®®
- **JSON**: æ•°æ®åºåˆ—åŒ–æ ¼å¼

### 2.3 æœåŠ¡å¯åŠ¨é…ç½®

```bash
# æœåŠ¡å¯åŠ¨é¡ºåºå’Œç«¯å£åˆ†é…
mvn spring-boot:run -pl gateway                      # ç½‘å…³æœåŠ¡ (8080)
mvn spring-boot:run -pl auth-server/auth-boot        # è®¤è¯æœåŠ¡ (8081)
mvn spring-boot:run -pl core-service/core-boot       # æ ¸å¿ƒæœåŠ¡ (8082)
mvn spring-boot:run -pl message-service/message-boot # æ¶ˆæ¯æœåŠ¡ (8084)

# æœªæ¥æ‰©å±•
mvn spring-boot:run -pl terminal-service/terminal-boot # ç»ˆç«¯æœåŠ¡ (8083)
```

### 2.4 æœåŠ¡é—´é€šä¿¡

```
å‰ç«¯åº”ç”¨ â”€â”€WebSocketâ”€â”€â–¶ Gateway(8080) â”€â”€ä»£ç†â”€â”€â–¶ Message-Service(8084)
å‰ç«¯åº”ç”¨ â”€â”€HTTP APIâ”€â”€â–¶ Gateway(8080) â”€â”€è·¯ç”±â”€â”€â–¶ Core-Service(8082)

Core-Service(8082) â”€â”€RabbitMQäº‹ä»¶â”€â”€â–¶ Message-Service(8084)
Terminal-Service(8083) â”€â”€RabbitMQäº‹ä»¶â”€â”€â–¶ Message-Service(8084)

Message-Service(8084) â”€â”€WebSocketæ¨é€â”€â”€â–¶ å‰ç«¯åº”ç”¨
```

---

## 3. æ¨¡å—è®¾è®¡

### 3.1 æ¨¡å—ç»“æ„

```
message-service/                      # ç‹¬ç«‹æ¶ˆæ¯æœåŠ¡
â”œâ”€â”€ message-api/                      # APIå®šä¹‰æ¨¡å—
â”‚   â”œâ”€â”€ src/main/java/
â”‚   â”‚   â””â”€â”€ org/nan/cloud/message/api/
â”‚   â”‚       â”œâ”€â”€ dto/                  # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”‚       â”‚   â”œâ”€â”€ request/          # è¯·æ±‚DTO
â”‚   â”‚       â”‚   â”œâ”€â”€ response/         # å“åº”DTO
â”‚   â”‚       â”‚   â”œâ”€â”€ websocket/        # WebSocketæ¶ˆæ¯DTO
â”‚   â”‚       â”‚   â””â”€â”€ event/            # äº‹ä»¶DTO
â”‚   â”‚       â”œâ”€â”€ enums/                # æšä¸¾å®šä¹‰
â”‚   â”‚       â”‚   â”œâ”€â”€ MessageType.java  # æ¶ˆæ¯ç±»å‹
â”‚   â”‚       â”‚   â”œâ”€â”€ EventType.java    # äº‹ä»¶ç±»å‹
â”‚   â”‚       â”‚   â””â”€â”€ Priority.java     # ä¼˜å…ˆçº§
â”‚   â”‚       â”œâ”€â”€ service/              # æœåŠ¡æ¥å£å®šä¹‰
â”‚   â”‚       â”œâ”€â”€ event/                # äº‹ä»¶å®šä¹‰
â”‚   â”‚       â”‚   â”œâ”€â”€ BaseEvent.java    # åŸºç¡€äº‹ä»¶
â”‚   â”‚       â”‚   â”œâ”€â”€ DeviceEvent.java  # è®¾å¤‡äº‹ä»¶
â”‚   â”‚       â”‚   â”œâ”€â”€ UserEvent.java    # ç”¨æˆ·äº‹ä»¶
â”‚   â”‚       â”‚   â””â”€â”€ MessageEvent.java # æ¶ˆæ¯äº‹ä»¶
â”‚   â”‚       â””â”€â”€ constants/            # å¸¸é‡å®šä¹‰
â”‚   â”‚           â””â”€â”€ MessageRoutingKeys.java # è·¯ç”±é”®å®šä¹‰
â”‚   â””â”€â”€ pom.xml
â”‚
â”œâ”€â”€ message-application/              # åº”ç”¨ä¸šåŠ¡é€»è¾‘æ¨¡å—
â”‚   â”œâ”€â”€ src/main/java/
â”‚   â”‚   â””â”€â”€ org/nan/cloud/message/
â”‚   â”‚       â”œâ”€â”€ service/              # ä¸šåŠ¡æœåŠ¡å®ç°
â”‚   â”‚       â”‚   â”œâ”€â”€ impl/
â”‚   â”‚       â”‚   â”œâ”€â”€ MessageService.java
â”‚   â”‚       â”‚   â”œâ”€â”€ MessageTemplateService.java
â”‚   â”‚       â”‚   â”œâ”€â”€ MessageStatisticsService.java
â”‚   â”‚       â”‚   â””â”€â”€ EventProcessorService.java
â”‚   â”‚       â”œâ”€â”€ domain/               # é¢†åŸŸæ¨¡å‹
â”‚   â”‚       â”‚   â”œâ”€â”€ Message.java
â”‚   â”‚       â”‚   â”œâ”€â”€ MessageTemplate.java
â”‚   â”‚       â”‚   â”œâ”€â”€ MessageStatus.java
â”‚   â”‚       â”‚   â””â”€â”€ EventLog.java
â”‚   â”‚       â”œâ”€â”€ repository/           # ä»“å‚¨æ¥å£
â”‚   â”‚       â”œâ”€â”€ event/                # é¢†åŸŸäº‹ä»¶
â”‚   â”‚       â”‚   â”œâ”€â”€ handler/          # äº‹ä»¶å¤„ç†å™¨
â”‚   â”‚       â”‚   â”œâ”€â”€ producer/         # äº‹ä»¶ç”Ÿäº§è€…
â”‚   â”‚       â”‚   â””â”€â”€ consumer/         # äº‹ä»¶æ¶ˆè´¹è€…
â”‚   â”‚       â””â”€â”€ processor/            # æ¶ˆæ¯å¤„ç†å™¨
â”‚   â””â”€â”€ pom.xml
â”‚
â”œâ”€â”€ message-infrastructure/           # åŸºç¡€è®¾æ–½æ¨¡å—
â”‚   â”œâ”€â”€ src/main/java/
â”‚   â”‚   â””â”€â”€ org/nan/cloud/message/infrastructure/
â”‚   â”‚       â”œâ”€â”€ mongodb/              # MongoDBç›¸å…³
â”‚   â”‚       â”‚   â”œâ”€â”€ document/         # æ–‡æ¡£å®ä½“
â”‚   â”‚       â”‚   â”œâ”€â”€ repository/       # ä»“å‚¨å®ç°
â”‚   â”‚       â”‚   â””â”€â”€ config/           # MongoDBé…ç½®
â”‚   â”‚       â”œâ”€â”€ redis/                # Redisç›¸å…³
â”‚   â”‚       â”‚   â”œâ”€â”€ manager/          # Redisç®¡ç†å™¨
â”‚   â”‚       â”‚   â””â”€â”€ config/           # Redisé…ç½®
â”‚   â”‚       â”œâ”€â”€ rabbitmq/             # RabbitMQç›¸å…³
â”‚   â”‚       â”‚   â”œâ”€â”€ config/           # RabbitMQé…ç½®
â”‚   â”‚       â”‚   â”œâ”€â”€ producer/         # æ¶ˆæ¯ç”Ÿäº§è€…
â”‚   â”‚       â”‚   â”œâ”€â”€ consumer/         # æ¶ˆæ¯æ¶ˆè´¹è€…
â”‚   â”‚       â”‚   â”œâ”€â”€ exchange/         # äº¤æ¢å™¨é…ç½®
â”‚   â”‚       â”‚   â””â”€â”€ queue/            # é˜Ÿåˆ—é…ç½®
â”‚   â”‚       â”œâ”€â”€ websocket/            # WebSocketç›¸å…³
â”‚   â”‚       â”‚   â”œâ”€â”€ handler/          # æ¶ˆæ¯å¤„ç†å™¨
â”‚   â”‚       â”‚   â”œâ”€â”€ manager/          # ä¼šè¯ç®¡ç†å™¨
â”‚   â”‚       â”‚   â”œâ”€â”€ router/           # æ¶ˆæ¯è·¯ç”±å™¨
â”‚   â”‚       â”‚   â””â”€â”€ config/           # WebSocketé…ç½®
â”‚   â”‚       â””â”€â”€ external/             # å¤–éƒ¨ç³»ç»Ÿé›†æˆ
â”‚   â””â”€â”€ pom.xml
â”‚
â”œâ”€â”€ message-boot/                     # å¯åŠ¨é…ç½®æ¨¡å—
â”‚   â”œâ”€â”€ src/main/java/
â”‚   â”‚   â””â”€â”€ org/nan/cloud/message/
â”‚   â”‚       â”œâ”€â”€ controller/           # RESTæ§åˆ¶å™¨
â”‚   â”‚       â”œâ”€â”€ facade/               # åº”ç”¨é—¨é¢
â”‚   â”‚       â”œâ”€â”€ config/               # é…ç½®ç±»
â”‚   â”‚       â””â”€â”€ MessageApplication.java
â”‚   â”œâ”€â”€ src/main/resources/
â”‚   â”‚   â”œâ”€â”€ application.yml
â”‚   â”‚   â”œâ”€â”€ application-dev.yml
â”‚   â”‚   â”œâ”€â”€ application-prod.yml
â”‚   â”‚   â””â”€â”€ rabbitmq/                # RabbitMQé…ç½®æ–‡ä»¶
â”‚   â”‚       â”œâ”€â”€ exchanges.json       # äº¤æ¢å™¨å®šä¹‰
â”‚   â”‚       â”œâ”€â”€ queues.json          # é˜Ÿåˆ—å®šä¹‰
â”‚   â”‚       â””â”€â”€ bindings.json        # ç»‘å®šå…³ç³»å®šä¹‰
â”‚   â””â”€â”€ pom.xml
â”‚
â””â”€â”€ pom.xml                           # çˆ¶æ¨¡å—POM
```

---

## 4. RabbitMQéƒ¨ç½²æŒ‡å—

### 4.1 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ–¹æ¡ˆ

#### 4.1.1 Docker Composeéƒ¨ç½²ï¼ˆæ¨èï¼‰

**åˆ›å»ºç›®å½•ç»“æ„**:
```bash
mkdir -p /opt/rabbitmq/{data,logs,config}
chmod 755 /opt/rabbitmq/{data,logs,config}
```

**docker-compose.ymlé…ç½®**:
```yaml
version: '3.8'

services:
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: rabbitmq-server
    hostname: rabbitmq-node1
    restart: unless-stopped
    
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123456
      RABBITMQ_DEFAULT_VHOST: /led-platform
      
    ports:
      - "5672:5672"    # AMQPç«¯å£
      - "15672:15672"  # ç®¡ç†ç•Œé¢ç«¯å£
      - "25672:25672"  # é›†ç¾¤é€šä¿¡ç«¯å£
      
    volumes:
      - /opt/rabbitmq/data:/var/lib/rabbitmq
      - /opt/rabbitmq/logs:/var/log/rabbitmq
      - /opt/rabbitmq/config:/etc/rabbitmq
      
    networks:
      - rabbitmq-network
      
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  rabbitmq-network:
    driver: bridge
```

**å¯åŠ¨å‘½ä»¤**:
```bash
# å¯åŠ¨RabbitMQ
docker-compose up -d

# æ£€æŸ¥è¿è¡ŒçŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f rabbitmq
```

#### 4.1.2 é›†ç¾¤éƒ¨ç½²é…ç½®

**é›†ç¾¤docker-compose.yml**:
```yaml
version: '3.8'

services:
  rabbitmq-node1:
    image: rabbitmq:3.12-management
    container_name: rabbitmq-node1
    hostname: rabbitmq-node1
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123456
      RABBITMQ_ERLANG_COOKIE: rabbitmq-cluster-cookie
      RABBITMQ_DEFAULT_VHOST: /led-platform
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-node1-data:/var/lib/rabbitmq
    networks:
      - rabbitmq-cluster
      
  rabbitmq-node2:
    image: rabbitmq:3.12-management
    container_name: rabbitmq-node2
    hostname: rabbitmq-node2
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123456
      RABBITMQ_ERLANG_COOKIE: rabbitmq-cluster-cookie
      RABBITMQ_DEFAULT_VHOST: /led-platform
    ports:
      - "5673:5672"
      - "15673:15672"
    volumes:
      - rabbitmq-node2-data:/var/lib/rabbitmq
    networks:
      - rabbitmq-cluster
    depends_on:
      - rabbitmq-node1
      
  rabbitmq-node3:
    image: rabbitmq:3.12-management
    container_name: rabbitmq-node3
    hostname: rabbitmq-node3
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123456
      RABBITMQ_ERLANG_COOKIE: rabbitmq-cluster-cookie
      RABBITMQ_DEFAULT_VHOST: /led-platform
    ports:
      - "5674:5672"
      - "15674:15672"
    volumes:
      - rabbitmq-node3-data:/var/lib/rabbitmq
    networks:
      - rabbitmq-cluster
    depends_on:
      - rabbitmq-node1

volumes:
  rabbitmq-node1-data:
  rabbitmq-node2-data:
  rabbitmq-node3-data:

networks:
  rabbitmq-cluster:
    driver: bridge
```

**é›†ç¾¤åˆå§‹åŒ–è„šæœ¬**:
```bash
#!/bin/bash

# ç­‰å¾…æ‰€æœ‰èŠ‚ç‚¹å¯åŠ¨
sleep 30

# å°†node2åŠ å…¥é›†ç¾¤
docker exec rabbitmq-node2 rabbitmqctl stop_app
docker exec rabbitmq-node2 rabbitmqctl reset
docker exec rabbitmq-node2 rabbitmqctl join_cluster rabbit@rabbitmq-node1
docker exec rabbitmq-node2 rabbitmqctl start_app

# å°†node3åŠ å…¥é›†ç¾¤
docker exec rabbitmq-node3 rabbitmqctl stop_app
docker exec rabbitmq-node3 rabbitmqctl reset
docker exec rabbitmq-node3 rabbitmqctl join_cluster rabbit@rabbitmq-node1
docker exec rabbitmq-node3 rabbitmqctl start_app

# æ£€æŸ¥é›†ç¾¤çŠ¶æ€
docker exec rabbitmq-node1 rabbitmqctl cluster_status

# è®¾ç½®é«˜å¯ç”¨ç­–ç•¥
docker exec rabbitmq-node1 rabbitmqctl set_policy ha-all ".*" '{"ha-mode":"all"}'

echo "RabbitMQé›†ç¾¤éƒ¨ç½²å®Œæˆï¼"
```

#### 4.1.3 Kuberneteséƒ¨ç½²

**rabbitmq-statefulset.yaml**:
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rabbitmq
  namespace: led-platform
spec:
  serviceName: rabbitmq-headless
  replicas: 3
  selector:
    matchLabels:
      app: rabbitmq
  template:
    metadata:
      labels:
        app: rabbitmq
    spec:
      containers:
      - name: rabbitmq
        image: rabbitmq:3.12-management
        env:
        - name: RABBITMQ_DEFAULT_USER
          value: "admin"
        - name: RABBITMQ_DEFAULT_PASS
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secret
              key: password
        - name: RABBITMQ_ERLANG_COOKIE
          value: "rabbitmq-cluster-cookie"
        - name: RABBITMQ_DEFAULT_VHOST
          value: "/led-platform"
        ports:
        - containerPort: 5672
          name: amqp
        - containerPort: 15672
          name: management
        volumeMounts:
        - name: rabbitmq-data
          mountPath: /var/lib/rabbitmq
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
  volumeClaimTemplates:
  - metadata:
      name: rabbitmq-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi
```

### 4.2 é…ç½®ä¼˜åŒ–

#### 4.2.1 æ€§èƒ½é…ç½®

**rabbitmq.conf**:
```
# å†…å­˜é…ç½®
vm_memory_high_watermark.relative = 0.6
vm_memory_high_watermark_paging_ratio = 0.5

# ç£ç›˜é…ç½®
disk_free_limit.relative = 1.0

# ç½‘ç»œé…ç½®
num_acceptors.tcp = 10
handshake_timeout = 10000

# é›†ç¾¤é…ç½®
cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config
cluster_formation.classic_config.nodes.1 = rabbit@rabbitmq-node1
cluster_formation.classic_config.nodes.2 = rabbit@rabbitmq-node2
cluster_formation.classic_config.nodes.3 = rabbit@rabbitmq-node3

# æ—¥å¿—é…ç½®
log.console = true
log.console.level = info
log.file = /var/log/rabbitmq/rabbit.log
log.file.level = info
```

#### 4.2.2 å®‰å…¨é…ç½®

**åˆ›å»ºSSLè¯ä¹¦**:
```bash
# ç”ŸæˆCAè¯ä¹¦
openssl genrsa -out ca-key.pem 4096
openssl req -new -x509 -days 365 -key ca-key.pem -sha256 -out ca.pem

# ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦
openssl genrsa -out server-key.pem 4096
openssl req -subj "/CN=rabbitmq-server" -sha256 -new -key server-key.pem -out server.csr
openssl x509 -req -days 365 -sha256 -in server.csr -CA ca.pem -CAkey ca-key.pem -out server-cert.pem

# ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦
openssl genrsa -out client-key.pem 4096
openssl req -subj '/CN=rabbitmq-client' -new -key client-key.pem -out client.csr
openssl x509 -req -days 365 -sha256 -in client.csr -CA ca.pem -CAkey ca-key.pem -out client-cert.pem
```

### 4.3 ç›‘æ§å’Œè¿ç»´

#### 4.3.1 å¥åº·æ£€æŸ¥è„šæœ¬

**health-check.sh**:
```bash
#!/bin/bash

# RabbitMQå¥åº·æ£€æŸ¥
RABBITMQ_HOST="localhost"
RABBITMQ_PORT="15672"
RABBITMQ_USER="admin"
RABBITMQ_PASS="admin123456"

# æ£€æŸ¥ç®¡ç†æ¥å£
response=$(curl -s -o /dev/null -w "%{http_code}" \
  -u $RABBITMQ_USER:$RABBITMQ_PASS \
  http://$RABBITMQ_HOST:$RABBITMQ_PORT/api/overview)

if [ $response -eq 200 ]; then
  echo "âœ… RabbitMQç®¡ç†æ¥å£æ­£å¸¸"
else
  echo "âŒ RabbitMQç®¡ç†æ¥å£å¼‚å¸¸ï¼ŒçŠ¶æ€ç : $response"
  exit 1
fi

# æ£€æŸ¥é›†ç¾¤çŠ¶æ€
cluster_status=$(docker exec rabbitmq-node1 rabbitmqctl cluster_status --formatter json)
node_count=$(echo $cluster_status | jq '.running_nodes | length')

if [ $node_count -eq 3 ]; then
  echo "âœ… RabbitMQé›†ç¾¤èŠ‚ç‚¹æ­£å¸¸ ($node_count/3)"
else
  echo "âš ï¸  RabbitMQé›†ç¾¤èŠ‚ç‚¹å¼‚å¸¸ ($node_count/3)"
fi

# æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€
queue_info=$(curl -s -u $RABBITMQ_USER:$RABBITMQ_PASS \
  http://$RABBITMQ_HOST:$RABBITMQ_PORT/api/queues)

echo "ğŸ“Š é˜Ÿåˆ—ç»Ÿè®¡:"
echo $queue_info | jq '.[] | {name: .name, messages: .messages, consumers: .consumers}'

echo "âœ… RabbitMQå¥åº·æ£€æŸ¥å®Œæˆ"
```

#### 4.3.2 Prometheusç›‘æ§é…ç½®

**rabbitmq-prometheus.yml**:
```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'rabbitmq'
    static_configs:
      - targets: ['localhost:15692']
    scrape_interval: 15s
    metrics_path: /metrics
```

### 4.4 è®¿é—®ä¿¡æ¯

éƒ¨ç½²å®Œæˆåï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®RabbitMQï¼š

- **ç®¡ç†ç•Œé¢**: http://your-server-ip:15672
- **ç”¨æˆ·å**: admin
- **å¯†ç **: admin123456
- **Virtual Host**: /led-platform
- **AMQPç«¯å£**: 5672

ä¸‹ä¸€æ­¥å°±å¯ä»¥å¼€å§‹å®ç°message-serviceçš„RabbitMQé›†æˆäº†ï¼

---

## 5. æ€»ç»“

æœ¬æ¶ˆæ¯ä¸­å¿ƒè®¾è®¡æ–‡æ¡£å…¨é¢è§„åˆ’äº†LedDeviceCloudPlatformçš„æ¶ˆæ¯æ¨é€å’Œç®¡ç†èƒ½åŠ›ã€‚é€šè¿‡é‡‡ç”¨RabbitMQä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œæ„å»ºäº†ä¼ä¸šçº§çš„äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œä¸ºå¹³å°æä¾›å¯é ã€é«˜æ•ˆã€å¯æ‰©å±•çš„æ¶ˆæ¯æœåŠ¡ã€‚

### 5.1 æ ¸å¿ƒä¼˜åŠ¿
- **å®æ—¶æ€§å¼º**: WebSocketé•¿è¿æ¥ä¿è¯æ¶ˆæ¯å®æ—¶æ¨é€
- **å¯é æ€§é«˜**: RabbitMQæä¾›ä¼ä¸šçº§æ¶ˆæ¯å¯é æ€§ä¿éšœ
- **æ‰©å±•æ€§å¥½**: å¾®æœåŠ¡æ¶æ„æ”¯æŒæ°´å¹³æ‰©å±•
- **äº‹ä»¶é©±åŠ¨**: åŸºäºRabbitMQçš„å®Œæ•´äº‹ä»¶é©±åŠ¨æ¶æ„
- **è¿ç»´å‹å¥½**: å®Œå–„çš„ç›‘æ§å‘Šè­¦å’Œç®¡ç†ç•Œé¢
- **å®‰å…¨å¯æ§**: å®Œå–„çš„è®¤è¯æˆæƒå’Œå®‰å…¨é˜²æŠ¤

### 5.2 æŠ€æœ¯äº®ç‚¹
- **RabbitMQé›†ç¾¤**: é«˜å¯ç”¨æ¶ˆæ¯é˜Ÿåˆ—é›†ç¾¤éƒ¨ç½²
- **äº‹ä»¶é©±åŠ¨æ¶æ„**: æ”¯æŒå¤æ‚çš„äº‹ä»¶å“åº”å’Œä¸šåŠ¡è§£è€¦
- **Topicè·¯ç”±**: çµæ´»çš„æ¶ˆæ¯è·¯ç”±å’Œåˆ†å‘æœºåˆ¶
- **æ­»ä¿¡é˜Ÿåˆ—**: å®Œå–„çš„å¤±è´¥æ¶ˆæ¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **å¤šç§Ÿæˆ·æ¶æ„**: æ”¯æŒç»„ç»‡çº§åˆ«çš„æ¶ˆæ¯éš”ç¦»
- **æ¶ˆæ¯æ¨¡æ¿**: çµæ´»çš„æ¨¡æ¿å¼•æ“æé«˜å‘é€æ•ˆç‡
- **ç»Ÿè®¡åˆ†æ**: ä¸°å¯Œçš„æ¶ˆæ¯æ•°æ®ç»Ÿè®¡å’Œåˆ†æ

### 5.3 æ¶æ„å‡çº§
ç›¸æ¯”v1.0ç‰ˆæœ¬ï¼Œv2.0ç‰ˆæœ¬çš„ä¸»è¦æ”¹è¿›ï¼š
- **æ¶ˆæ¯é˜Ÿåˆ—**: ä»Redis Streamså‡çº§åˆ°RabbitMQä¼ä¸šçº§æ¶ˆæ¯ä¸­é—´ä»¶
- **äº‹ä»¶æ”¯æŒ**: å¢åŠ äº†è®¾å¤‡äº‹ä»¶ã€ç”¨æˆ·äº‹ä»¶ã€ä¸šåŠ¡äº‹ä»¶çš„å®Œæ•´æ”¯æŒ
- **å¯é æ€§**: å¢å¼ºäº†æ¶ˆæ¯å¯é æ€§å’Œå¤±è´¥å¤„ç†æœºåˆ¶
- **æ‰©å±•æ€§**: æ›´å¥½åœ°æ”¯æŒå¤§å‹é¡¹ç›®çš„å¤æ‚äº‹ä»¶å¤„ç†éœ€æ±‚
- **è¿ç»´æ€§**: æä¾›äº†å®Œå–„çš„éƒ¨ç½²ã€ç›‘æ§å’Œè¿ç»´æ–¹æ¡ˆ

### 5.4 é¢„æœŸæ•ˆæœ
é€šè¿‡å®æ–½æœ¬è®¾è®¡æ–¹æ¡ˆï¼Œé¢„æœŸè¾¾åˆ°ä»¥ä¸‹æ•ˆæœï¼š
- æ”¯æŒå¤§å‹é¡¹ç›®çš„å¤æ‚äº‹ä»¶å¤„ç†éœ€æ±‚
- æä¾›ä¼ä¸šçº§çš„æ¶ˆæ¯å¯é æ€§å’Œæ€§èƒ½ä¿éšœ
- å®ç°å®Œæ•´çš„äº‹ä»¶é©±åŠ¨ä¸šåŠ¡æ¶æ„
- æ”¯æŒæœªæ¥terminal-serviceç­‰æ–°æœåŠ¡çš„å¿«é€Ÿé›†æˆ
- å»ºç«‹ç»Ÿä¸€çš„æ¶ˆæ¯å’Œäº‹ä»¶å¤„ç†è§„èŒƒ
- æå‡ç³»ç»Ÿçš„å¯è§‚æµ‹æ€§å’Œè¿ç»´æ•ˆç‡

### 5.5 éƒ¨ç½²å»ºè®®
- **å¼€å‘ç¯å¢ƒ**: ä½¿ç”¨Docker Composeå•èŠ‚ç‚¹éƒ¨ç½²
- **æµ‹è¯•ç¯å¢ƒ**: ä½¿ç”¨Docker Compose 3èŠ‚ç‚¹é›†ç¾¤
- **ç”Ÿäº§ç¯å¢ƒ**: ä½¿ç”¨Kuberneteséƒ¨ç½²é«˜å¯ç”¨é›†ç¾¤
- **ç›‘æ§**: é›†æˆPrometheus + Grafanaç›‘æ§
- **å¤‡ä»½**: å®šæœŸå¤‡ä»½RabbitMQé…ç½®å’Œå…ƒæ•°æ®

---

**æ–‡æ¡£å®Œæˆæ—¥æœŸ**: 2025å¹´1æœˆ20æ—¥  
**ç‰ˆæœ¬æ›´æ–°**: v2.0 - é‡‡ç”¨RabbitMQæ¶ˆæ¯é˜Ÿåˆ—æ¶æ„  
**åç»­æ›´æ–°**: æœ¬æ–‡æ¡£å°†æ ¹æ®é¡¹ç›®è¿›å±•å’Œéœ€æ±‚å˜æ›´åŠæ—¶æ›´æ–°