# 云服务器对接设备二次开发文档总结

## 1. 概述

本文档旨在指导开发者如何在自定义服务器上实现与设备的对接，主要涉及设备与服务器之间的消息交互、接口实现以及通信协议。设备与服务器的交互消息体为指令，通过实现少量接口即可实现终端的正常链接和指令的下发。业务功能可在此基础上自行添加。

## 2. 通信协议

设备与服务器的交互协议主要有两种：HTTP 和 WebSocket。

### 2.1 HTTP 协议

通过 HTTP 协议交互时，设备会定时（默认1分钟/次）向服务器轮询获取指令。这种方式不需要建立长连接，但下发指令与设备执行指令之间可能存在短暂的时差。指令的轮询频率可以通过指令进行修改。

### 2.2 WebSocket 协议

通过 WebSocket 协议交互时，服务器需要与设备保持长连接。设备会定时发送心跳（固定55秒/次），服务器需要作出回应。这种方式可以实现指令的实时处理，服务器可以主动下发指令给设备，减轻设备轮询给服务器造成的压力。即使不实现 WebSocket 服务，设备也会通过 HTTP 轮询来获取指令。

## 3. 服务器必须实现的接口

为了实现设备与服务器的正常交互，服务器必须实现以下核心接口：

### 3.1 设备取指令接口

*   **Path**: `/wp-json/wp/v2/comments`
*   **Method**: `GET`
*   **描述**: 设备获取指令的接口。
*   **请求参数 (Query)**:
    *   `clt_type`: 必须，固定为 `terminal`。
    *   `device_num`: 必须，设备序列号。
*   **返回数据**: 包含指令确认ID、终端ID、终端屏执行方式（GET/POST/PUT/DELETE）、指令对象（ContentDTO）、指令对应的 JSON 字符串（raw）和指令操作类型（author_url）等。

### 3.2 指令应答接口

*   **Path**: `/wp-json/wp/v2/comments`
*   **Method**: `POST`
*   **描述**: 设备收到指令并校验后，会向服务器确认指令。服务器返回状态码介于 200-300 之间表示允许执行，其他状态码表示不执行。
*   **请求参数 (Headers)**:
    *   `Content-Type`: `application/json`。
*   **请求参数 (Query)**:
    *   `post`: 必须，终端 ID。
*   **请求参数 (Body)**:
    *   `parent`: 必须，指令 ID。
    *   `content`: 必须，设备校验指令结果，如 `Duplicate comments` 或 `Executable comment`。

### 3.3 设备上报状态接口

*   **Path**: `/wp-json/screen/v1/status`
*   **Method**: `PUT`
*   **描述**: 设备上报自身状态的接口。

## 4. 设备连接服务器流程

1.  **服务器实现相关接口**: 确保上述必须实现的接口已在自定义服务器上部署。
2.  **设备配置设备链接**: 在设备端进行配置，包括设置网络（保证服务器与设备在同一网段下）和配置连接信息（高级->云账号->修改）。
3.  **连接成功**: 连接成功后，设备状态会显示为“已连接、登录成功”。

## 5. 指令格式

设备与服务器交互的指令内容在 HTTP 和 WebSocket 协议下是相同的，但指令下发结构略有差异。

### 5.1 HTTP 指令下发结构

*   `root`: 指令集合，包含 `id` (指令确认 ID), `post` (终端 ID), `karma` (终端屏执行方式), `ContentDTO` (指令对象), `raw` (指令对应的 JSON), `author_url` (指令操作类型) 等。

### 5.2 WebSocket 指令下发结构

*   `data`: 指令集合，包含 `id`, `post`, `karma`, `ContentDTO`, `raw`, `author_url` 等，并额外包含 `led_id` (设备 ID，业务码)。

## 6. 接口权限

### 6.1 HTTP 请求的权限校验

所有来自设备的请求都带有 Basic 认证。服务器可以选择进行权限认证，通过获取请求头中的 `Authorization` 字段进行校验。校验失败时，服务器应返回 401 状态码。

### 6.2 WebSocket 请求的权限校验

建立 WebSocket 连接后，可以获取设备携带的认证信息，并在此阶段进行校验。

## 7. 其他重要接口 (非必须实现)

### 7.1 终端取节目列表接口

*   **Path**: `/wp-json/wp/v2/programs`
*   **Method**: `GET`
*   **描述**: 终端接收到更新节目指令后，调用此接口获取最新的节目列表。

### 7.2 终端取素材列表接口

*   **Path**: `/wp-json/wp/v2/media`
*   **Method**: `GET`
*   **描述**: 终端调用此接口获取指定节目的素材信息并下载素材文件。

### 7.3 终端取排程接口

*   **Path**: `/wp-json/wp/v3/schedules`
*   **Method**: `GET`
*   **描述**: 设备获取排程的接口。

### 7.4 终端日志上报接口

*   **Path**: `/wp-json/screen/v1/logcat`
*   **Method**: `POST`
*   **描述**: 终端上报日志的接口。

### 7.5 终端下载进度上报接口

*   **Path**: `/wp-json/screen/v1/info`
*   **Method**: `POST`
*   **描述**: 终端上报下载进度的接口。

### 7.6 终端获取 led_status 接口

*   **Path**: `/wp-json/screen/v1/status`
*   **Method**: `GET`
*   **描述**: 终端获取 `led_status` MD5 的 JSON。

## 8. 指令集合

指令的交互有两种方式：设备轮询取指令和服务器直接下发指令。两种指令的格式不同，但核心数据相同。不同类型的指令（如截图、休眠、唤醒、重启、亮度、更新节目、音量、排程、校时等）的 `authorUrl`、`content->raw`、`karma` 属性不同。

## 9. 节目下发

节目分为 `vsn` (播放格式) 和素材 (播放内容)。设备通过处理 `vsn` 和素材来达到播放目的。素材和 `vsn` 都有固定的命名规范：`name_文件MD5_文件字节数`。

## 10. 错误排查

*   **设备日志**: 可以通过局域网导出设备日志 (`http://192.168.42.129/api/logcat.json`) 进行分析排查问题。
*   **指令不执行**: 检查与设备的交互响应是否正确，并排查日志。
*   **指令下发和节目执行的等待**: 指令下发和节目执行都需要等待，因为涉及网络传输和文件下载时间。

## 11. 常见问题

*   **Mac 是否支持 USB 连接设备访问单机 Web**: 支持。
*   **生产新节目注意事项**: 文件命名必须遵循 `name_md5_size` 格式，并更新设备下载文件的 URL 和响应资源。
*   **消息数限制**: 设备保存的最大消息数有限制，空间快用完时下发会失败，需要定期清理。
*   **节目不及时播放**: 修改节目下发时间，将 `TerminalProgramDTO` 中的下发时间、更新时间设置为当前时间。
*   **验证指令是否正确**: 可以利用 USB 直连下发指令 (`http://192.168.42.129/api/action`) 进行模拟测试。

