# ç»ˆç«¯ç»„æƒé™ç»‘å®šAPIä½¿ç”¨æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£é¢å‘å‰ç«¯å¼€å‘äººå‘˜ï¼Œè¯¦ç»†è¯´æ˜å¦‚ä½•ä½¿ç”¨ç»ˆç«¯ç»„æƒé™ç»‘å®šAPIï¼Œå®ç°ç”¨æˆ·ç»„ä¸ç»ˆç«¯ç»„çš„æƒé™ç®¡ç†åŠŸèƒ½ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

- **ç»ˆç«¯ç»„ï¼ˆTerminal Groupï¼‰**ï¼šLEDè®¾å¤‡çš„ç»„ç»‡ç»“æ„ï¼Œæ”¯æŒæ ‘å½¢å±‚çº§ç®¡ç†
- **ç”¨æˆ·ç»„ï¼ˆUser Groupï¼‰**ï¼šç”¨æˆ·çš„åˆ†ç»„ç®¡ç†
- **æƒé™ç»‘å®š**ï¼šç”¨æˆ·ç»„ä¸ç»ˆç«¯ç»„ä¹‹é—´çš„è®¿é—®æƒé™å…³ç³»
- **INCLUDE/EXCLUDEæ¨¡å¼**ï¼šæ”¯æŒåŒ…å«å’Œæ’é™¤ä¸¤ç§æƒé™ç±»å‹
- **includeChildren**ï¼šæ˜¯å¦åŒ…å«å­ç»ˆç«¯ç»„çš„æƒé™æ§åˆ¶

---

## ğŸ—ï¸ æƒé™æ¨¡å‹

### æƒé™ç»‘å®šç±»å‹

| ç»‘å®šç±»å‹ | includeChildren | è¯´æ˜ | UIå±•ç¤º |
|---------|----------------|------|--------|
| INCLUDE | true | åŒ…å«è¯¥ç»ˆç«¯ç»„åŠå…¶æ‰€æœ‰å­ç»„ | ğŸŸ¢ ç»¿è‰²å®å¿ƒ |
| INCLUDE | false | ä»…åŒ…å«è¯¥ç»ˆç«¯ç»„ï¼Œä¸åŒ…å«å­ç»„ | ğŸŸ¢ ç»¿è‰²ç©ºå¿ƒ |
| EXCLUDE | true | æ’é™¤è¯¥ç»ˆç«¯ç»„åŠå…¶æ‰€æœ‰å­ç»„ | ğŸ”´ çº¢è‰²å®å¿ƒ |
| EXCLUDE | false | ä»…æ’é™¤è¯¥ç»ˆç«¯ç»„ï¼Œä¸æ’é™¤å­ç»„ | ğŸ”´ çº¢è‰²ç©ºå¿ƒ |

### æƒé™è®¡ç®—è§„åˆ™

1. **ä¼˜å…ˆçº§æ ˆæ¨¡å‹**ï¼šæŒ‰ç…§ç»ˆç«¯ç»„çš„å±‚çº§æ·±åº¦è®¡ç®—æƒé™
2. **EXCLUDEä¼˜å…ˆ**ï¼šEXCLUDEç±»å‹çš„æƒé™ä¼˜å…ˆçº§é«˜äºINCLUDE
3. **æ™ºèƒ½å»é‡**ï¼šç³»ç»Ÿè‡ªåŠ¨æ¸…ç†å†—ä½™çš„æƒé™é…ç½®

---

## ğŸš€ APIæ¥å£è¯¦è§£

### åŸºç¡€URL
```
/terminal-group
```

### 1. è·å–ç»ˆç«¯ç»„æ ‘ç»“æ„

**æ¥å£**ï¼š`GET /terminal-group/tree/init`

**ç”¨é€”**ï¼šè·å–å½“å‰ç”¨æˆ·å¯è®¿é—®çš„ç»ˆç«¯ç»„æ ‘å½¢ç»“æ„

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```javascript
// GET /terminal-group/tree/init
fetch('/terminal-group/tree/init', {
  method: 'GET',
  headers: {
    'Authorization': 'Bearer ' + token
  }
})
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "terminalGroups": [
    {
      "tgid": 1,
      "name": "æ€»éƒ¨",
      "path": "1",
      "parent": null,
      "children": [
        {
          "tgid": 2,
          "name": "å¼€å‘éƒ¨",
          "path": "1|2",
          "parent": 1,
          "children": []
        }
      ]
    }
  ]
}
```

---

### 2. è·å–ç”¨æˆ·ç»„æƒé™çŠ¶æ€

**æ¥å£**ï¼š`GET /terminal-group/permission/status`

**ç”¨é€”**ï¼šè·å–æŒ‡å®šç”¨æˆ·ç»„çš„æƒé™ç»‘å®šçŠ¶æ€ï¼Œç”¨äºæƒé™æ ‘çš„åˆå§‹åŒ–å±•ç¤º

**è¯·æ±‚å‚æ•°**ï¼š
- `ugid` (Long) - ç”¨æˆ·ç»„ID

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```javascript
// GET /terminal-group/permission/status?ugid=1001
fetch('/terminal-group/permission/status?ugid=1001', {
  method: 'GET',
  headers: {
    'Authorization': 'Bearer ' + token
  }
})
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "ugid": 1001,
  "userGroupName": "å¼€å‘ç»„",
  "permissionBindings": [
    {
      "bindingId": 1,
      "tgid": 2,
      "terminalGroupName": "å¼€å‘éƒ¨",
      "terminalGroupPath": "1|2",
      "bindingType": "INCLUDE",
      "includeChildren": true,
      "depth": 2,
      "parentTgid": 1,
      "createTime": "2024-01-01T10:00:00",
      "remarks": "å¼€å‘ç»„æœ‰æƒé™è®¿é—®å¼€å‘éƒ¨åŠå…¶å­ç»„"
    }
  ],
  "statistics": {
    "totalBindings": 3,
    "includeBindings": 2,
    "excludeBindings": 1,
    "includeChildrenBindings": 2,
    "totalCoveredTerminalGroups": 15,
    "maxDepth": 4
  },
  "lastUpdateTime": "2024-01-01T10:00:00"
}
```

---

### 3. æ›´æ–°æƒé™è¡¨è¾¾å¼

**æ¥å£**ï¼š`POST /terminal-group/permission/expression/update`

**ç”¨é€”**ï¼šå…¨é‡æ›´æ–°ç”¨æˆ·ç»„çš„æƒé™ç»‘å®šå…³ç³»

**è¯·æ±‚ä½“**ï¼š
```json
{
  "ugid": 1001,
  "permissionBindings": [
    {
      "tgid": 1,
      "bindingType": "INCLUDE",
      "includeChildren": true,
      "remarks": "æ€»éƒ¨æƒé™"
    },
    {
      "tgid": 3,
      "bindingType": "EXCLUDE", 
      "includeChildren": false,
      "remarks": "æ’é™¤è´¢åŠ¡éƒ¨"
    }
  ],
  "description": "æ›´æ–°å¼€å‘ç»„æƒé™",
  "enableRedundancyOptimization": true
}
```

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```javascript
const updatePermissions = async (ugid, bindings) => {
  const response = await fetch('/terminal-group/permission/expression/update', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({
      ugid: ugid,
      permissionBindings: bindings,
      description: 'æƒé™æ›´æ–°',
      enableRedundancyOptimization: true
    })
  });
  
  return response.json();
};
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "processedBindings": 2,
  "optimizedBindings": 1,
  "removedRedundantBindings": 1,
  "finalBindings": [
    {
      "tgid": 1,
      "bindingType": "INCLUDE",
      "includeChildren": true
    }
  ],
  "optimizationSummary": {
    "redundancyDetected": true,
    "conflictResolved": false,
    "optimizationDetails": "ç§»é™¤äº†1ä¸ªå†—ä½™çš„å­ç»„ç»‘å®š"
  }
}
```

---

## ğŸ¨ å‰ç«¯äº¤äº’è®¾è®¡

### æƒé™æ ‘ç»„ä»¶è®¾è®¡

#### 1. æ ‘å½¢ç»“æ„å±•ç¤º
```html
<div class="permission-tree">
  <div class="tree-node" v-for="node in terminalGroups" :key="node.tgid">
    <div class="node-content">
      <!-- æƒé™çŠ¶æ€æŒ‡ç¤ºå™¨ -->
      <span class="permission-indicator" 
            :class="getPermissionClass(node.tgid)">
      </span>
      
      <!-- ç»ˆç«¯ç»„åç§° -->
      <span class="node-name">{{ node.name }}</span>
      
      <!-- æƒé™æ§åˆ¶æŒ‰é’® -->
      <div class="permission-controls">
        <button @click="setPermission(node.tgid, 'INCLUDE', true)"
                class="btn-include-all" title="åŒ…å«å­ç»„">
          ğŸŸ¢
        </button>
        <button @click="setPermission(node.tgid, 'INCLUDE', false)"
                class="btn-include-only" title="ä»…åŒ…å«æœ¬ç»„">
          âšª
        </button>
        <button @click="setPermission(node.tgid, 'EXCLUDE', true)"
                class="btn-exclude-all" title="æ’é™¤å­ç»„">
          ğŸ”´
        </button>
        <button @click="setPermission(node.tgid, 'EXCLUDE', false)"
                class="btn-exclude-only" title="ä»…æ’é™¤æœ¬ç»„">
          â­•
        </button>
        <button @click="removePermission(node.tgid)"
                class="btn-remove" title="ç§»é™¤æƒé™">
          âŒ
        </button>
      </div>
    </div>
    
    <!-- å­èŠ‚ç‚¹ -->
    <div class="child-nodes" v-if="node.children">
      <!-- é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹ -->
    </div>
  </div>
</div>
```

#### 2. CSSæ ·å¼å®šä¹‰
```css
.permission-indicator {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 8px;
}

.permission-indicator.include-all {
  background-color: #52c41a; /* ç»¿è‰²å®å¿ƒ */
}

.permission-indicator.include-only {
  background-color: transparent;
  border: 2px solid #52c41a; /* ç»¿è‰²ç©ºå¿ƒ */
}

.permission-indicator.exclude-all {
  background-color: #ff4d4f; /* çº¢è‰²å®å¿ƒ */
}

.permission-indicator.exclude-only {
  background-color: transparent;
  border: 2px solid #ff4d4f; /* çº¢è‰²ç©ºå¿ƒ */
}

.permission-indicator.no-permission {
  background-color: #d9d9d9; /* ç°è‰² */
}
```

#### 3. Vue.jsäº¤äº’é€»è¾‘
```javascript
export default {
  data() {
    return {
      terminalGroups: [],
      permissionBindings: [],
      currentUgid: null
    };
  },
  
  methods: {
    // è·å–æƒé™çŠ¶æ€æ ·å¼ç±»
    getPermissionClass(tgid) {
      const binding = this.permissionBindings.find(b => b.tgid === tgid);
      if (!binding) return 'no-permission';
      
      if (binding.bindingType === 'INCLUDE') {
        return binding.includeChildren ? 'include-all' : 'include-only';
      } else {
        return binding.includeChildren ? 'exclude-all' : 'exclude-only';
      }
    },
    
    // è®¾ç½®æƒé™
    setPermission(tgid, bindingType, includeChildren) {
      const existingIndex = this.permissionBindings.findIndex(b => b.tgid === tgid);
      const newBinding = {
        tgid,
        bindingType,
        includeChildren,
        remarks: `${bindingType === 'INCLUDE' ? 'åŒ…å«' : 'æ’é™¤'}${includeChildren ? '(å«å­ç»„)' : '(ä»…æœ¬ç»„)'}`
      };
      
      if (existingIndex >= 0) {
        this.permissionBindings[existingIndex] = newBinding;
      } else {
        this.permissionBindings.push(newBinding);
      }
      
      // å®æ—¶ä¿å­˜
      this.savePermissions();
    },
    
    // ç§»é™¤æƒé™
    removePermission(tgid) {
      const index = this.permissionBindings.findIndex(b => b.tgid === tgid);
      if (index >= 0) {
        this.permissionBindings.splice(index, 1);
        this.savePermissions();
      }
    },
    
    // ä¿å­˜æƒé™è®¾ç½®
    async savePermissions() {
      try {
        const response = await fetch('/terminal-group/permission/expression/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + this.$store.state.token
          },
          body: JSON.stringify({
            ugid: this.currentUgid,
            permissionBindings: this.permissionBindings,
            description: 'æƒé™æ›´æ–°',
            enableRedundancyOptimization: true
          })
        });
        
        const result = await response.json();
        if (result.success) {
          this.$message.success('æƒé™æ›´æ–°æˆåŠŸ');
          // æ›´æ–°æœ¬åœ°æƒé™çŠ¶æ€
          this.permissionBindings = result.finalBindings;
        }
      } catch (error) {
        this.$message.error('æƒé™æ›´æ–°å¤±è´¥');
      }
    },
    
    // åŠ è½½ç»ˆç«¯ç»„æ ‘
    async loadTerminalGroups() {
      try {
        const response = await fetch('/terminal-group/tree/init');
        const data = await response.json();
        this.terminalGroups = data.terminalGroups;
      } catch (error) {
        this.$message.error('åŠ è½½ç»ˆç«¯ç»„å¤±è´¥');
      }
    },
    
    // åŠ è½½ç”¨æˆ·ç»„æƒé™çŠ¶æ€
    async loadUserGroupPermissions(ugid) {
      try {
        const response = await fetch(`/terminal-group/permission/status?ugid=${ugid}`);
        const data = await response.json();
        this.permissionBindings = data.permissionBindings;
        this.currentUgid = ugid;
      } catch (error) {
        this.$message.error('åŠ è½½æƒé™çŠ¶æ€å¤±è´¥');
      }
    }
  },
  
  mounted() {
    this.loadTerminalGroups();
  }
};
```

---

## ğŸ“± ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ–°å»ºç”¨æˆ·ç»„æƒé™é…ç½®
1. é€‰æ‹©ç”¨æˆ·ç»„
2. è°ƒç”¨ `loadUserGroupPermissions()` è·å–å½“å‰æƒé™çŠ¶æ€
3. åœ¨æƒé™æ ‘ä¸Šè¿›è¡Œæƒé™é…ç½®
4. ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ `updatePermissionExpression` ä¿å­˜

### åœºæ™¯2ï¼šä¿®æ”¹ç°æœ‰æƒé™
1. åŠ è½½ç°æœ‰æƒé™é…ç½®
2. åœ¨æ ‘å½¢ç•Œé¢ä¸Šä¿®æ”¹æƒé™è®¾ç½®
3. å®æ—¶ä¿å­˜å¹¶æ˜¾ç¤ºä¼˜åŒ–ç»“æœ

### åœºæ™¯3ï¼šæƒé™ç»§æ‰¿å±•ç¤º
1. å±•ç¤ºçˆ¶å­å…³ç³»çš„æƒé™ç»§æ‰¿
2. æ™ºèƒ½æç¤ºæƒé™å†²çª
3. è‡ªåŠ¨ä¼˜åŒ–å†—ä½™é…ç½®

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. æƒé™è®¡ç®—é€»è¾‘
- **EXCLUDEä¼˜å…ˆ**ï¼šå½“åŒä¸€ç»ˆç«¯ç»„æ—¢æœ‰INCLUDEåˆæœ‰EXCLUDEæ—¶ï¼ŒEXCLUDEç”Ÿæ•ˆ
- **å­ç»„ç»§æ‰¿**ï¼š`includeChildren=true`æ—¶ï¼Œå­ç»„è‡ªåŠ¨ç»§æ‰¿æƒé™
- **æ™ºèƒ½ä¼˜åŒ–**ï¼šç³»ç»Ÿè‡ªåŠ¨æ¸…ç†å†—ä½™çš„æƒé™é…ç½®

### 2. å‰ç«¯äº¤äº’åŸåˆ™
- **å®æ—¶åé¦ˆ**ï¼šæƒé™å˜æ›´ç«‹å³ç”Ÿæ•ˆå¹¶æä¾›è§†è§‰åé¦ˆ
- **æ™ºèƒ½æç¤º**ï¼šå½“é…ç½®å¯èƒ½äº§ç”Ÿå†²çªæ—¶æä¾›è­¦å‘Š
- **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæ‰¹é‡è®¾ç½®å¤šä¸ªç»ˆç«¯ç»„æƒé™

### 3. æ€§èƒ½ä¼˜åŒ–å»ºè®®
- **æ‡’åŠ è½½**ï¼šå¤§å‹ç»ˆç«¯ç»„æ ‘ä½¿ç”¨æ‡’åŠ è½½
- **é˜²æŠ–ä¿å­˜**ï¼šç”¨æˆ·è¿ç»­æ“ä½œæ—¶ä½¿ç”¨é˜²æŠ–æœºåˆ¶
- **çŠ¶æ€ç¼“å­˜**ï¼šåˆç†ç¼“å­˜æƒé™çŠ¶æ€å‡å°‘APIè°ƒç”¨

### 4. é”™è¯¯å¤„ç†
- **ç½‘ç»œå¼‚å¸¸**ï¼šæä¾›é‡è¯•æœºåˆ¶
- **æƒé™ä¸è¶³**ï¼šå‹å¥½çš„é”™è¯¯æç¤º
- **æ•°æ®æ ¡éªŒ**ï¼šå‰ç«¯é¢„æ ¡éªŒå‡å°‘åç«¯è¯·æ±‚

---

## ğŸ”§ è°ƒè¯•å·¥å…·

### æƒé™çŠ¶æ€æ£€æŸ¥å™¨
```javascript
// è°ƒè¯•ç”¨ï¼šæ£€æŸ¥å½“å‰æƒé™é…ç½®
const debugPermissions = (ugid) => {
  console.log('=== æƒé™é…ç½®è°ƒè¯• ===');
  console.log('ç”¨æˆ·ç»„ID:', ugid);
  console.log('æƒé™ç»‘å®š:', this.permissionBindings);
  console.log('è®¡ç®—ç»“æœ:', this.calculateEffectivePermissions());
};
```

### æƒé™æ¨¡æ‹Ÿå™¨
```javascript
// æ¨¡æ‹Ÿæƒé™è®¡ç®—ç»“æœ
const simulatePermission = (tgid) => {
  // å®ç°æƒé™è®¡ç®—é€»è¾‘çš„å‰ç«¯æ¨¡æ‹Ÿ
  // ç”¨äºåœ¨ä¿å­˜å‰é¢„è§ˆæƒé™æ•ˆæœ
};
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜è¯·è”ç³»ï¼š
- **åç«¯APIæ”¯æŒ**ï¼šcore-serviceå›¢é˜Ÿ
- **å‰ç«¯ç»„ä»¶æ”¯æŒ**ï¼šUI/UXå›¢é˜Ÿ
- **æƒé™æ¨¡å‹å’¨è¯¢**ï¼šæ¶æ„ç»„

---

*æœ€åæ›´æ–°ï¼š2024å¹´7æœˆ19æ—¥*