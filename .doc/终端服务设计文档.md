# 终端服务设计文档

## 1. 背景与目标

- 终端服务（terminal-service）承担与设备端（Android）交互，以及为核心业务服务提供内部 RPC 能力（下发/取消/查询指令、查询在线状态等）。
- 保持 Nacos 作为服务发现/配置中心不变。
- 内部服务互调从 REST/Feign 调整为 Dubbo；序列化明确使用 Hessian2 或 Triple（gRPC/HTTP2），避免 Java 原生序列化。
- 设备侧协议与行为保持兼容：
  - HTTP 轮询与上报路径遵循文档《云服务器对接设备二次开发文档总结.md》：`GET/POST /wp-json/wp/v2/comments`、`PUT /wp-json/screen/v1/status`。
  - WebSocket 长连，55s 心跳；握手参数包含 Basic 账号密码（不可改变设备端连接行为）。
- 版本与兼容：
  - 终端服务保持 JDK 17 + Spring Boot 3.x + Spring Security 6.x（追求高并发与低尾延迟）。
  - 核心服务为 JDK 11（参考示例父 POM：`.example/core-pom.xml`，Boot 2.6.x/Cloud 2021.x），通过“共享 RPC API Jar（JDK 11 编译）”与终端服务互通。

## 2. 架构设计

### 2.1 分层与端口-适配器（六边形）

- 模块划分：
  - `terminal-api`：设备端 REST API （接口定义与 DTO/VO）。
  - `terminal-application`：应用编排与领域服务（Facade/Service/Domain/Event/Repository 接口）。
  - `terminal-infrastructure`：Redis/Netty/MQ/DB/Dubbo Provider/安全与配置等外设实现。
  - `terminal-boot`：最小化启动、配置、安全链、设备 REST 控制器与 WS 启动装配。
  - `terminal-rpc-api`（新增）：共享 RPC 接口与 DTO（JDK 11 编译），供核心服务消费。

- 入站适配器：
  - 设备 HTTP：实现 `TerminalDeviceApi` 的控制器（`/wp-json/**`）。
  - 设备 WS：Netty `WebSocketServer`（握手参数 Basic 认证）。
  - 内部 RPC：Dubbo Provider（实现 `terminal-rpc-api` 中的接口）。

- 出站适配器：
  - Redis（命令队列/幂等/在线状态）
  - MySQL/Mongo（审计与历史）
  - MQ（消息通知）
  - 其他服务 Feign/Dubbo（节目/素材/排程等，如需）

### 2.2 模块依赖与边界

- `terminal-boot` 依赖 `terminal-application`、`terminal-infrastructure`、`terminal-api`。
- `terminal-application` 仅依赖 `terminal-api`，不依赖基础设施细节。
- `terminal-infrastructure` 实现 `terminal-application` 的 repository/gateway 接口；同时实现 Dubbo Provider。
- `terminal-rpc-api` 独立构建（JDK 11），由 provider 与 consumer 双方引入。

## 3. RPC 设计（Dubbo）

### 3.1 共享 API Jar（JDK 11）
- 模块：`terminal-rpc-api`。
- 内容：纯 Java 接口与 DTO（POJO），无 Spring/`jakarta.*` 依赖，不使用 Java 17 特性（record/sealed）。
- maven-compiler-plugin：`<release>11</release>`。
- MapStruct 转换逻辑不放在共享包，留在两边服务内部实现（遵循团队规范）。

### 3.2 序列化
- Hessian2（推荐快速落地）：
  - 配置层强制 `serialization: hessian2`；在 `@DubboService` / `@DubboReference` 上再次覆盖参数，防止回退到 jdk 序列化。
  - 不引入 `dubbo-serialization-jdk`。
- Triple（gRPC/HTTP2 + Protobuf，可选）：
  - 适合跨语言/带宽更省场景；需新增 proto 模块并生成 Java 代码。

### 3.3 Consumer/Provider 配置示例（Hessian2）
```yaml
dubbo:
  application:
    name: terminal-service   # 或 core-service
  registry:
    address: nacos://nacos:8848
  protocol:
    name: dubbo
    port: -1
    serialization: hessian2
  provider:
    timeout: 3000
  consumer:
    check: false
```
```java
@DubboService(parameters = {"serialization", "hessian2"})
public class TerminalCommandRpcProvider implements TerminalCommandRpc { ... }

@DubboReference(parameters = {"serialization", "hessian2"})
private TerminalCommandRpc terminalCommandRpc;
```

### 3.4 上下文透传与审计
- 使用 Dubbo Filter 在 Consumer 侧写入 `uid/oid/ugid/traceId` 到 `RpcContext`，Provider 读取并落审计。
- 与 REST 时代的 `InvocationContextHolder` 行为等价。

## 4. 设备接入与兼容

### 4.1 HTTP 轮询与上报
- 兼容文档路径：
  - `GET /wp-json/wp/v2/comments?clt_type=terminal&device_num={num}` 获取指令
  - `POST /wp-json/wp/v2/comments?post={tid}` 指令应答确认
  - `PUT /wp-json/screen/v1/status` 状态上报
- 控制器实现 `TerminalDeviceApi`，在方法内统一从 `SecurityContext` 获取 `TerminalPrincipal`。

### 4.2 WebSocket
- 握手路径：统一为 `/terminal/ws`（建议），如设备端已固化 `/ColorWebSocket/websocket/chat`，则在安全配置中同步放行该路径。
- 认证：不改变设备端行为（URL 携带 username/password），在 Netty 握手拦截器中调用 Spring Security `AuthenticationManager/Provider` 完成认证，将 `TerminalPrincipal` 放入 `Channel.attr`。
- 55s 心跳：PING/PONG 或文本心跳，更新 `TerminalOnlineStatusManager`。

### 4.3 安全策略（两条链路）
- 设备链路：
  - HTTP：Basic Auth（`TerminalAuthenticationFilter`），路径 `/wp-json/**`。
  - WS：Netty 握手内认证（调用同一 `AuthenticationProvider`），路径直接放行至 Netty。
- 内部链路：
  - Dubbo：网关/调用方以 Filter 方式透传用户与追踪上下文；Provider 侧审计。

## 5. 指令流水线与数据设计

### 5.1 流程
1) 创建（来自核心服务的 Dubbo 调用） → 幂等检查 → 入队（Redis ZSet + Hash + String） → 若在线尝试 WS 推送 → 审计。
2) 投递
   - WS 在线：分片连接优先推送，失败回退队列。
   - HTTP 拉取：GET 接口拉取 ZSet 中的待投递列表。
3) 确认：POST 接口回执 → 状态推进（EXECUTED/REJECTED） → MQ 通知用户。
4) 过期/取消：TTL 扫描或显式取消 → 状态推进 → 清理索引与详情。

### 5.2 Redis 键规范（示例）
- 队列：`terminal:cmd:queue:{oid}:{tid}`（ZSet，score=入队时间，member=commandId）
- 去重：`terminal:cmd:dedup:{oid}:{tid}`（Hash，author_url → commandId）
- 详情：`terminal:cmd:detail:{oid}:{tid}:{commandId}`（String，JSON，带 TTL）
- 在线：`terminal:online:{oid}`（ZSet，member=tid，score=lastActiveMs）
- 在线计数缓存：`terminal:online:count:{oid}`（String，TTL）
- 广播：`terminal:pub:cmd-dispatch`（Pub/Sub）

### 5.3 连接分片
- `ShardedConnectionManager` 16 分片，`Map<Tid, Session> + RWLock`；提供指标：分片连接数、锁等待、推送耗时。

## 6. 模块级目录建议

- `terminal-api`
  - `device/TerminalDeviceApi.java`
  - `dto/*`、`model/*`
- `terminal-rpc-api`（JDK 11 编译）
  - `rpc/TerminalCommandRpc.java`
  - `dto/*`
- `terminal-application`
  - `facade/TerminalCommandFacade.java`、`facade/TerminalReportFacade.java`
  - `service/*`、`event/*`、`domain/*`、`repository/*`
- `terminal-infrastructure`
  - `redis/*` `ws/*` `mq/*` `persistence/*` `dubbo/*` `config/*`
- `terminal-boot`
  - `controller/device/TerminalDeviceController.java`
  - `config/security/*` `config/websocket/*` `config/openapi/*`

## 7. 配置清单（关键项）

- Dubbo（Hessian2 强制）
  - `dubbo.protocol.serialization=hessian2`
  - 服务与引用注解 `parameters={"serialization","hessian2"}`
- Nacos
  - `dubbo.registry.address=nacos://host:8848`，分组与命名空间按环境管理。
- Spring Security
  - HTTP：`/wp-json/**` 走 Basic；`/rpc/**` 不暴露 HTTP（仅 Dubbo）。
  - WS：放行握手路径，认证在 Netty Handler。
- Redis
  - 连接池与超时、序列化方案、Key 前缀统一。

## 8. 性能与可观测性

- JDK 17：G1（可选 ZGC）、TLS1.3/ALPN 改进、JFR 诊断增强（低尾延迟）。
- Netty：启用 `netty-tcnative-boringssl-static`（如有 TLS），降低 CPU 与延迟。
- 指标：
  - 连接：分片连接数、握手成功率、心跳超时、断连原因。
  - 命令：入队/下发/确认/过期率、队列深度、失败原因 TOP N。
  - Redis：QPS、慢查询、连接池饱和、内存占用。
  - Dubbo：RT、超时/重试、失败率、Attachment 覆盖率。
- 日志：认证成功/失败（脱敏）、异常栈、关键流水号（commandId、tid/oid、traceId）。

## 9. 迁移与落地计划

- 阶段A：结构与路径统一
  - 统一 WS 路径（或放行已固化路径），将 `TerminalReportFacade` 下移到 application，Controller 调用 Facade。
  - 新增 `terminal-rpc-api`（JDK 11 编译）。
- 阶段B：Dubbo 上线
  - infra 新增 Provider（Hessian2），核心服务引入 `terminal-rpc-api` 改为 `@DubboReference` 调用；双写/灰度。下线 REST `/rpc/**`。
- 阶段C：应用/基础设施解耦
  - 拆分 `TerminalCommandManager` 为 队列仓库/推送网关/状态推进器；新增 `TerminalCommandFacade` 与 TTL 扫描器。
- 阶段D：性能与观测
  - 压测校验 10k+ 连接、队列深度与尾延迟；完善指标与告警。

## 10. 测试与验收

- 单元：命令幂等/去重、状态机推进、上下文透传、WS 认证。
- 集成：Dubbo 互通（JDK11⇄JDK17）、设备 HTTP/WS 全链路、Redis 键行为、MQ 回执。
- 压测：WS 连接数、心跳稳定性、命令投递 99 线延迟；HTTP 轮询退化场景。
- 回归：核心服务功能对齐、用户审计闭环。

## 11. 风险与回退

- Dubbo 超时/重试导致重复下发：在 Facade/仓库层幂等兜底，显式配置重试策略与超时。
- WS 握手认证阻塞 I/O 线程：引入业务线程池或 Redis 缓存账号摘要。
- 路径不一致导致放行/拦截异常：统一配置或双路径放行，日志与监控校验。
- 序列化兼容：共享 API 仅用基础类型 & POJO，避免 Optional/record，双方版本对齐。

---

本文档依据：
- 核心服务父 POM（JDK 11，Spring Boot 2.6.x，Spring Cloud 2021.x，Dubbo 3.0.x 参考）：`.example/core-pom.xml`
- 设备对接文档：《云服务器对接设备二次开发文档总结.md》
- 现有 `terminal-service` 代码结构与讨论共识（保持 JDK 17、引入 Dubbo/Hessian2、WS 认证合入 Spring Security 体系、分片连接与 Redis 队列策略）。