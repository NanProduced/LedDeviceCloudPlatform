# 节目生成与下发流程设计

## 1. 整体流程架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            节目生成与下发完整流程                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

    节目编辑完成          审核流程           VSN生成          素材打包        设备下发
         ↓                  ↓                ↓               ↓               ↓
┌─────────────────┐ ┌─────────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│                 │ │                 │ │              │ │              │ │              │
│   保存草稿      │ │   提交审核      │ │  生成VSN     │ │  打包素材    │ │  推送设备    │
│                 │ │                 │ │              │ │              │ │              │
│ • 实时自动保存   │ │ • 完整性检查     │ │ • XML转换    │ │ • 素材收集   │ │ • 设备推送   │
│ • 版本管理      │ │ • 素材依赖验证   │ │ • 路径解析   │ │ • 文件压缩   │ │ • 状态跟踪   │
│ • 协作编辑      │ │ • 权限审核      │ │ • 兼容性验证  │ │ • MD5校验    │ │ • 播放验证   │
│                 │ │                 │ │              │ │              │ │              │
└─────────────────┘ └─────────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
         ↓                  ↓                ↓               ↓               ↓
    MongoDB存储      审核记录更新      VSN文件生成     节目包创建       设备状态同步
```

## 2. 节目生成阶段设计

### 2.1 节目编辑保存流程

```java
@Service
@Transactional
public class ProgramEditService {
    
    /**
     * 实时保存节目编辑数据
     * 前端编辑器每30秒或重要操作时自动调用
     */
    public SaveResult autoSave(String programId, ProgramEditData editData, String userId) {
        try {
            // 1. 验证用户权限
            validateEditPermission(programId, userId);
            
            // 2. 获取当前版本
            Program program = programRepository.findById(Long.valueOf(programId))
                .orElseThrow(() -> new ProgramNotFoundException("节目不存在"));
            
            // 3. 构建内容更新
            ProgramContent content = buildProgramContent(editData, program);
            content.setUpdatedAt(LocalDateTime.now());
            
            // 4. 保存到MongoDB
            programContentRepository.save(content);
            
            // 5. 更新MySQL基础信息
            program.setUpdateTime(LocalDateTime.now());
            program.setUpdaterId(Long.valueOf(userId));
            programRepository.save(program);
            
            // 6. 记录编辑历史
            recordEditAction(programId, editData.getLastAction(), userId);
            
            // 7. 发送实时协作通知
            broadcastEditNotification(programId, editData.getLastAction(), userId);
            
            return SaveResult.success("自动保存成功", content.getContentVersion());
            
        } catch (Exception e) {
            log.error("自动保存失败 - 节目ID: {}, 用户: {}, 错误: {}", programId, userId, e.getMessage(), e);
            return SaveResult.failure("保存失败: " + e.getMessage());
        }
    }
    
    /**
     * 手动保存并创建版本快照
     */
    public SaveResult manualSave(String programId, String userId, String changeComment) {
        try {
            // 1. 执行自动保存逻辑
            SaveResult autoSaveResult = autoSave(programId, getCurrentEditData(programId), userId);
            if (!autoSaveResult.isSuccess()) {
                return autoSaveResult;
            }
            
            // 2. 创建版本快照
            Program program = programRepository.findById(Long.valueOf(programId)).get();
            ProgramContent content = programContentRepository.findByProgramId(programId);
            
            // 3. 增加版本号
            program.setVersion(program.getVersion() + 1);
            programRepository.save(program);
            
            // 4. 保存版本历史
            ProgramVersionHistory versionHistory = ProgramVersionHistory.builder()
                .programId(Long.valueOf(programId))
                .version(program.getVersion())
                .programContentId(content.getId())
                .changeSummary(changeComment)
                .creatorId(Long.valueOf(userId))
                .createTime(LocalDateTime.now())
                .build();
            
            versionHistoryRepository.save(versionHistory);
            
            return SaveResult.success("版本保存成功", program.getVersion());
            
        } catch (Exception e) {
            log.error("手动保存失败 - 节目ID: {}, 错误: {}", programId, e.getMessage(), e);
            return SaveResult.failure("版本保存失败: " + e.getMessage());
        }
    }
    
    /**
     * 构建节目内容对象
     */
    private ProgramContent buildProgramContent(ProgramEditData editData, Program program) {
        // 1. 解析前端编辑数据
        List<ProgramPage> pages = parseEditPages(editData.getPages());
        
        // 2. 提取素材引用关系
        Set<MaterialReference> materialRefs = extractMaterialReferences(pages);
        
        // 3. 构建内容对象
        return ProgramContent.builder()
            .programId(program.getProgramId().toString())
            .information(ProgramInformation.builder()
                .width(program.getCanvasWidth())
                .height(program.getCanvasHeight())
                .backgroundColor(editData.getBackgroundColor())
                .deviceProfile(program.getDeviceType())
                .build())
            .pages(pages)
            .materialReferences(materialRefs)
            .editorState(editData.getEditorState())
            .contentVersion(editData.getVersion())
            .updatedAt(LocalDateTime.now())
            .build();
    }
    
    /**
     * 解析编辑器页面数据
     */
    private List<ProgramPage> parseEditPages(List<EditPageData> editPages) {
        return editPages.stream().map(editPage -> {
            List<ProgramRegion> regions = editPage.getRegions().stream()
                .map(this::parseEditRegion)
                .collect(Collectors.toList());
                
            return ProgramPage.builder()
                .id(editPage.getId())
                .name(editPage.getName())
                .duration(editPage.getDuration())
                .loopType(editPage.getLoopType())
                .bgColor(editPage.getBgColor())
                .bgFile(editPage.getBgFile())
                .bgAudios(editPage.getBgAudios())
                .regions(regions)
                .sortOrder(editPage.getSortOrder())
                .build();
        }).collect(Collectors.toList());
    }
    
    /**
     * 解析编辑器区域数据
     */
    private ProgramRegion parseEditRegion(EditRegionData editRegion) {
        List<ProgramItem> items = editRegion.getItems().stream()
            .map(this::parseEditItem)
            .collect(Collectors.toList());
            
        return ProgramRegion.builder()
            .id(editRegion.getId())
            .name(editRegion.getName())
            .rect(DisplayRect.builder()
                .x(editRegion.getX())
                .y(editRegion.getY())
                .width(editRegion.getWidth())
                .height(editRegion.getHeight())
                .borderWidth(editRegion.getBorderWidth())
                .borderColor(editRegion.getBorderColor())
                .build())
            .items(items)
            .layer(editRegion.getLayer())
            .isScheduleRegion(editRegion.getIsScheduleRegion())
            .regionType(editRegion.getRegionType())
            .build();
    }
    
    /**
     * 解析编辑器素材项数据
     */
    private ProgramItem parseEditItem(EditItemData editItem) {
        // 1. 获取素材引用信息
        MaterialReference materialRef = null;
        if (editItem.getMaterialId() != null) {
            Material material = materialService.getMaterialById(Long.valueOf(editItem.getMaterialId()));
            materialRef = MaterialReference.builder()
                .materialId(material.getMid().toString())
                .fileId(material.getFileId())
                .materialType(material.getMaterialType())
                .md5Hash(material.getMd5Hash())
                .storagePath(getStoragePath(material))
                .accessUrl(storageService.generateAccessUrl(getStoragePath(material)))
                .fileSize(material.getOriginalFileSize())
                .mimeType(material.getMimeType())
                .build();
        }
        
        // 2. 构建属性对象
        ItemProperties properties = ItemProperties.builder()
            .backColor(editItem.getBackColor())
            .inEffect(editItem.getInEffect())
            .name(editItem.getName())
            // 根据素材类型设置专用属性
            .alpha(editItem.getAlpha())
            .reserveAS(editItem.getReserveAS())
            .duration(editItem.getDuration())
            .text(editItem.getText())
            .textColor(editItem.getTextColor())
            .logFont(editItem.getLogFont())
            .isScroll(editItem.getIsScroll())
            .customProperties(editItem.getCustomProperties())
            .build();
            
        return ProgramItem.builder()
            .id(editItem.getId())
            .itemType(editItem.getItemType())
            .materialRef(materialRef)
            .properties(properties)
            .schedule(editItem.getSchedule())
            .sortOrder(editItem.getSortOrder())
            .build();
    }
}
```

### 2.2 节目完整性验证

```java
@Service
public class ProgramValidationService {
    
    /**
     * 节目提交前完整性检查
     */
    public ValidationResult validateProgramForSubmission(String programId) {
        ValidationResult result = new ValidationResult();
        
        try {
            // 1. 获取节目数据
            Program program = programRepository.findById(Long.valueOf(programId))
                .orElseThrow(() -> new ProgramNotFoundException("节目不存在"));
            ProgramContent content = programContentRepository.findByProgramId(programId);
            
            // 2. 基础信息验证
            validateBasicInfo(program, result);
            
            // 3. 内容结构验证
            validateContentStructure(content, result);
            
            // 4. 素材依赖验证
            validateMaterialDependencies(content, result);
            
            // 5. VSN格式兼容性预检查
            validateVsnCompatibility(content, result);
            
            // 6. 设备兼容性检查
            validateDeviceCompatibility(program, content, result);
            
            return result;
            
        } catch (Exception e) {
            log.error("节目验证失败 - 节目ID: {}, 错误: {}", programId, e.getMessage(), e);
            result.addError("验证过程异常: " + e.getMessage());
            return result;
        }
    }
    
    /**
     * 基础信息验证
     */
    private void validateBasicInfo(Program program, ValidationResult result) {
        if (StringUtils.isBlank(program.getProgramName())) {
            result.addError("节目名称不能为空");
        }
        
        if (program.getCanvasWidth() <= 0 || program.getCanvasHeight() <= 0) {
            result.addError("画布尺寸必须大于0");
        }
        
        if (program.getOrganizationId() == null) {
            result.addError("节目必须归属于组织");
        }
    }
    
    /**
     * 内容结构验证
     */
    private void validateContentStructure(ProgramContent content, ValidationResult result) {
        if (content.getPages() == null || content.getPages().isEmpty()) {
            result.addError("节目至少需要包含一个页面");
            return;
        }
        
        for (ProgramPage page : content.getPages()) {
            validatePage(page, result);
        }
    }
    
    /**
     * 页面验证
     */
    private void validatePage(ProgramPage page, ValidationResult result) {
        if (StringUtils.isBlank(page.getName())) {
            result.addWarning("页面名称为空: " + page.getId());
        }
        
        if (page.getDuration() != null && page.getDuration() <= 0) {
            result.addError("页面播放时长必须大于0: " + page.getName());
        }
        
        if (page.getLoopType() == 0 && page.getDuration() == null) {
            result.addError("指定播放时长模式下必须设置duration: " + page.getName());
        }
        
        if (page.getRegions() == null || page.getRegions().isEmpty()) {
            result.addWarning("页面没有内容区域: " + page.getName());
            return;
        }
        
        for (ProgramRegion region : page.getRegions()) {
            validateRegion(region, result);
        }
    }
    
    /**
     * 区域验证
     */
    private void validateRegion(ProgramRegion region, ValidationResult result) {
        DisplayRect rect = region.getRect();
        if (rect == null) {
            result.addError("区域必须设置位置和尺寸: " + region.getName());
            return;
        }
        
        if (rect.getWidth() <= 0 || rect.getHeight() <= 0) {
            result.addError("区域尺寸必须大于0: " + region.getName());
        }
        
        if (region.getItems() == null || region.getItems().isEmpty()) {
            result.addWarning("区域没有素材内容: " + region.getName());
            return;
        }
        
        for (ProgramItem item : region.getItems()) {
            validateItem(item, result);
        }
    }
    
    /**
     * 素材项验证
     */
    private void validateItem(ProgramItem item, ValidationResult result) {
        if (StringUtils.isBlank(item.getItemType())) {
            result.addError("素材项类型不能为空: " + item.getId());
            return;
        }
        
        // 根据类型进行专门验证
        switch (item.getItemType()) {
            case "2", "3", "6": // 图片、视频、GIF
                validateMediaItem(item, result);
                break;
            case "4", "5": // 文本
                validateTextItem(item, result);
                break;
            case "9", "16": // 时钟
                validateClockItem(item, result);
                break;
            case "14": // 天气
                validateWeatherItem(item, result);
                break;
            default:
                result.addWarning("未知的素材类型: " + item.getItemType());
        }
    }
    
    /**
     * 媒体素材验证
     */
    private void validateMediaItem(ProgramItem item, ValidationResult result) {
        MaterialReference materialRef = item.getMaterialRef();
        if (materialRef == null) {
            result.addError("媒体素材必须选择文件: " + item.getId());
            return;
        }
        
        // 验证素材是否存在
        Material material = materialService.getMaterialById(Long.valueOf(materialRef.getMaterialId()));
        if (material == null) {
            result.addError("引用的素材不存在: " + materialRef.getMaterialId());
            return;
        }
        
        // 验证文件是否可访问
        if (!fileService.isFileAccessible(material.getFileId())) {
            result.addError("素材文件不可访问: " + material.getMaterialName());
        }
        
        // 验证素材类型匹配
        String expectedType = switch (item.getItemType()) {
            case "2" -> "IMAGE";
            case "3" -> "VIDEO";
            case "6" -> "IMAGE"; // GIF作为图片类型
            default -> null;
        };
        
        if (expectedType != null && !expectedType.equals(material.getMaterialType())) {
            result.addError("素材类型不匹配: " + material.getMaterialName());
        }
    }
    
    /**
     * 文本素材验证
     */
    private void validateTextItem(ProgramItem item, ValidationResult result) {
        ItemProperties props = item.getProperties();
        if (props == null) {
            result.addError("文本素材缺少属性配置: " + item.getId());
            return;
        }
        
        if (StringUtils.isBlank(props.getText())) {
            result.addError("文本内容不能为空: " + item.getId());
        }
        
        if (StringUtils.isBlank(props.getTextColor())) {
            result.addWarning("未设置文本颜色: " + item.getId());
        }
        
        if (props.getLogFont() == null || StringUtils.isBlank(props.getLogFont().getLfHeight())) {
            result.addError("文本必须设置字体大小: " + item.getId());
        }
    }
    
    /**
     * 素材依赖验证
     */
    private void validateMaterialDependencies(ProgramContent content, ValidationResult result) {
        Set<String> referencedMaterialIds = new HashSet<>();
        
        // 收集所有引用的素材ID
        for (ProgramPage page : content.getPages()) {
            for (ProgramRegion region : page.getRegions()) {
                for (ProgramItem item : region.getItems()) {
                    if (item.getMaterialRef() != null) {
                        referencedMaterialIds.add(item.getMaterialRef().getMaterialId());
                    }
                }
            }
        }
        
        // 验证素材可用性
        for (String materialId : referencedMaterialIds) {
            try {
                Material material = materialService.getMaterialById(Long.valueOf(materialId));
                if (material == null) {
                    result.addError("引用的素材不存在: " + materialId);
                    continue;
                }
                
                // 验证文件状态
                if (!Integer.valueOf(1).equals(material.getFileStatus())) {
                    result.addError("素材文件未完成处理: " + material.getMaterialName());
                }
                
                // 验证文件存在性
                if (!storageService.exists(getStoragePath(material))) {
                    result.addError("素材文件不存在: " + material.getMaterialName());
                }
                
            } catch (Exception e) {
                result.addError("素材验证异常: " + materialId + " - " + e.getMessage());
            }
        }
    }
    
    /**
     * VSN兼容性预检查
     */
    private void validateVsnCompatibility(ProgramContent content, ValidationResult result) {
        try {
            // 尝试构建VSN文档结构
            VsnDocument vsnDoc = vsnGeneratorService.buildVsnDocument(content, null);
            
            // 基础结构检查
            if (vsnDoc.getInformation() == null) {
                result.addError("节目信息不完整，无法生成VSN");
            }
            
            if (vsnDoc.getPages() == null || vsnDoc.getPages().isEmpty()) {
                result.addError("节目页面为空，无法生成VSN");
            }
            
            // 字段完整性检查
            for (VsnPage page : vsnDoc.getPages()) {
                if (page.getLoopType() == 0 && page.getDuration() == null) {
                    result.addError("VSN页面缺少必需的AppointDuration字段");
                }
                
                for (VsnRegion region : page.getRegions()) {
                    if (region.getRect() == null) {
                        result.addError("VSN区域缺少必需的Rect字段");
                    }
                }
            }
            
        } catch (Exception e) {
            result.addError("VSN兼容性检查异常: " + e.getMessage());
        }
    }
}

@Data
public class ValidationResult {
    private List<String> errors = new ArrayList<>();
    private List<String> warnings = new ArrayList<>();
    
    public void addError(String error) {
        errors.add(error);
    }
    
    public void addWarning(String warning) {
        warnings.add(warning);
    }
    
    public boolean isValid() {
        return errors.isEmpty();
    }
    
    public boolean hasWarnings() {
        return !warnings.isEmpty();
    }
}
```

## 3. 审核流程设计

### 3.1 审核流程状态机

```java
@Service
@Transactional
public class ProgramApprovalService {
    
    /**
     * 提交节目审核
     */
    public ApprovalResult submitForApproval(String programId, String submitterId, String submitComment) {
        try {
            // 1. 验证节目完整性
            ValidationResult validation = validationService.validateProgramForSubmission(programId);
            if (!validation.isValid()) {
                return ApprovalResult.failure("节目验证未通过", validation.getErrors());
            }
            
            // 2. 检查提交权限
            if (!hasSubmitPermission(programId, submitterId)) {
                return ApprovalResult.failure("无权限提交该节目");
            }
            
            // 3. 更新节目状态
            Program program = programRepository.findById(Long.valueOf(programId)).get();
            program.setApprovalStatus(ApprovalStatus.PENDING);
            program.setUpdaterId(Long.valueOf(submitterId));
            program.setUpdateTime(LocalDateTime.now());
            programRepository.save(program);
            
            // 4. 创建审核记录
            ProgramApproval approval = ProgramApproval.builder()
                .programId(Long.valueOf(programId))
                .submitterId(Long.valueOf(submitterId))
                .submitComment(submitComment)
                .status(ApprovalStatus.PENDING)
                .submitTime(LocalDateTime.now())
                .build();
            
            approvalRepository.save(approval);
            
            // 5. 发送审核通知
            sendApprovalNotification(program, approval);
            
            // 6. 记录操作日志
            logProgramOperation(programId, "SUBMIT_APPROVAL", submitterId, submitComment);
            
            return ApprovalResult.success("提交审核成功", approval.getId());
            
        } catch (Exception e) {
            log.error("提交审核失败 - 节目ID: {}, 错误: {}", programId, e.getMessage(), e);
            return ApprovalResult.failure("提交审核失败: " + e.getMessage());
        }
    }
    
    /**
     * 审核节目
     */
    public ApprovalResult approveProgram(Long approvalId, String approverId, ApprovalDecision decision, String comment) {
        try {
            // 1. 获取审核记录
            ProgramApproval approval = approvalRepository.findById(approvalId)
                .orElseThrow(() -> new ApprovalNotFoundException("审核记录不存在"));
            
            // 2. 验证审核权限
            if (!hasApprovalPermission(approval.getProgramId(), approverId)) {
                return ApprovalResult.failure("无权限审核该节目");
            }
            
            // 3. 检查审核状态
            if (!ApprovalStatus.PENDING.equals(approval.getStatus())) {
                return ApprovalResult.failure("该节目已被审核");
            }
            
            // 4. 更新审核记录
            approval.setApproverId(Long.valueOf(approverId));
            approval.setApprovalTime(LocalDateTime.now());
            approval.setApprovalComment(comment);
            approval.setDecision(decision);
            approval.setStatus(decision == ApprovalDecision.APPROVED ? 
                ApprovalStatus.APPROVED : ApprovalStatus.REJECTED);
            
            approvalRepository.save(approval);
            
            // 5. 更新节目状态
            Program program = programRepository.findById(approval.getProgramId()).get();
            program.setApprovalStatus(approval.getStatus());
            program.setApproverId(Long.valueOf(approverId));
            program.setApprovalComment(comment);
            
            // 如果审核通过，更新状态为已发布
            if (decision == ApprovalDecision.APPROVED) {
                program.setStatus(ProgramStatus.PUBLISHED);
            }
            
            program.setUpdateTime(LocalDateTime.now());
            programRepository.save(program);
            
            // 6. 发送审核结果通知
            sendApprovalResultNotification(program, approval);
            
            // 7. 如果审核通过，触发VSN生成
            if (decision == ApprovalDecision.APPROVED) {
                asyncTriggerVsnGeneration(program.getProgramId().toString());
            }
            
            // 8. 记录操作日志
            logProgramOperation(program.getProgramId().toString(), 
                "APPROVAL_" + decision.name(), approverId, comment);
            
            return ApprovalResult.success("审核完成", approval.getId());
            
        } catch (Exception e) {
            log.error("审核失败 - 审核ID: {}, 错误: {}", approvalId, e.getMessage(), e);
            return ApprovalResult.failure("审核失败: " + e.getMessage());
        }
    }
    
    /**
     * 异步触发VSN生成
     */
    @Async("programProcessTaskExecutor")
    private void asyncTriggerVsnGeneration(String programId) {
        try {
            log.info("开始生成VSN文件 - 节目ID: {}", programId);
            
            VsnGenerationOptions options = VsnGenerationOptions.builder()
                .deploymentMode(DeploymentMode.HYBRID) // 支持多种部署模式
                .validateCompatibility(true)
                .includePreview(true)
                .build();
            
            VsnGenerationResult result = vsnGeneratorService.generateVsnXml(programId, options);
            
            if (result.isSuccess()) {
                // 更新节目VSN文件ID
                Program program = programRepository.findById(Long.valueOf(programId)).get();
                program.setVsnFileId(result.getVsnFileId());
                programRepository.save(program);
                
                log.info("VSN文件生成成功 - 节目ID: {}, 文件ID: {}", programId, result.getVsnFileId());
                
                // 发送生成完成通知
                sendVsnGenerationNotification(program, result);
            } else {
                log.error("VSN文件生成失败 - 节目ID: {}, 错误: {}", programId, result.getErrorMessage());
                
                // 回滚节目状态
                Program program = programRepository.findById(Long.valueOf(programId)).get();
                program.setStatus(ProgramStatus.DRAFT);
                program.setApprovalStatus(ApprovalStatus.PENDING);
                programRepository.save(program);
            }
            
        } catch (Exception e) {
            log.error("VSN生成异常 - 节目ID: {}, 错误: {}", programId, e.getMessage(), e);
        }
    }
}

@Entity
@Table(name = "program_approval")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ProgramApproval {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private Long programId;
    private Long submitterId;
    private String submitComment;
    private LocalDateTime submitTime;
    
    private Long approverId;
    private String approvalComment;
    private LocalDateTime approvalTime;
    
    @Enumerated(EnumType.STRING)
    private ApprovalStatus status;
    
    @Enumerated(EnumType.STRING)
    private ApprovalDecision decision;
    
    // 审核流程追踪
    private Integer approvalStep; // 多级审核支持
    private String approvalFlow; // 审核流程标识
}

enum ApprovalDecision {
    APPROVED("通过"),
    REJECTED("拒绝");
}
```

## 4. VSN生成与文件打包流程

### 4.1 VSN生成完整流程

```java
@Service
public class VsnGenerationService {
    
    /**
     * 生成完整的节目包
     */
    public ProgramPackageResult generateProgramPackage(String programId, PackageOptions options) {
        try {
            log.info("开始生成节目包 - 节目ID: {}", programId);
            
            // 1. 生成VSN XML文件
            VsnGenerationResult vsnResult = generateVsnXml(programId, options.getVsnOptions());
            if (!vsnResult.isSuccess()) {
                return ProgramPackageResult.failure("VSN生成失败", vsnResult.getErrors());
            }
            
            // 2. 收集素材文件
            MaterialCollectionResult materialResult = collectProgramMaterials(programId, vsnResult.getMaterialFiles());
            if (!materialResult.isSuccess()) {
                return ProgramPackageResult.failure("素材收集失败", materialResult.getErrors());
            }
            
            // 3. 打包程序文件
            PackageResult packageResult = packageProgramFiles(programId, vsnResult, materialResult, options);
            if (!packageResult.isSuccess()) {
                return ProgramPackageResult.failure("文件打包失败", packageResult.getErrors());
            }
            
            // 4. 生成部署清单
            DeploymentManifest manifest = generateDeploymentManifest(programId, vsnResult, materialResult, packageResult);
            
            // 5. 保存包信息
            ProgramPackage programPackage = saveProgramPackage(programId, packageResult, manifest);
            
            log.info("节目包生成完成 - 节目ID: {}, 包ID: {}", programId, programPackage.getId());
            
            return ProgramPackageResult.success(programPackage);
            
        } catch (Exception e) {
            log.error("生成节目包失败 - 节目ID: {}, 错误: {}", programId, e.getMessage(), e);
            return ProgramPackageResult.failure("生成节目包异常: " + e.getMessage());
        }
    }
    
    /**
     * 收集节目素材文件
     */
    private MaterialCollectionResult collectProgramMaterials(String programId, List<MaterialFileInfo> materialFiles) {
        MaterialCollectionResult result = new MaterialCollectionResult();
        
        try {
            // 1. 创建临时目录
            String tempDir = createTempDirectory(programId);
            
            // 2. 逐个收集素材文件
            for (MaterialFileInfo materialFile : materialFiles) {
                try {
                    // 获取素材信息
                    Material material = materialService.getMaterialById(Long.valueOf(materialFile.getMaterialId()));
                    
                    // 确定目标路径
                    String targetPath = determineTargetPath(material, materialFile, tempDir);
                    
                    // 复制文件
                    String sourcePath = getStoragePath(material);
                    boolean copied = storageService.copyFile(sourcePath, targetPath);
                    
                    if (copied) {
                        // 验证文件完整性
                        String copiedMd5 = FileUtils.calculateMD5(targetPath);
                        if (!material.getMd5Hash().equals(copiedMd5)) {
                            result.addError("文件完整性校验失败: " + material.getMaterialName());
                            continue;
                        }
                        
                        // 记录成功收集的文件
                        result.addCollectedFile(CollectedFile.builder()
                            .materialId(material.getMid().toString())
                            .sourcePath(sourcePath)
                            .targetPath(targetPath)
                            .relativePath(materialFile.getRelativePath())
                            .md5Hash(material.getMd5Hash())
                            .fileSize(material.getOriginalFileSize())
                            .build());
                            
                    } else {
                        result.addError("文件复制失败: " + material.getMaterialName());
                    }
                    
                } catch (Exception e) {
                    result.addError("处理素材失败: " + materialFile.getMaterialId() + " - " + e.getMessage());
                }
            }
            
            result.setTempDirectory(tempDir);
            result.setSuccess(result.getErrors().isEmpty());
            
            return result;
            
        } catch (Exception e) {
            log.error("收集素材文件失败 - 节目ID: {}, 错误: {}", programId, e.getMessage(), e);
            result.addError("素材收集异常: " + e.getMessage());
            return result;
        }
    }
    
    /**
     * 确定素材目标路径
     */
    private String determineTargetPath(Material material, MaterialFileInfo materialFile, String tempDir) {
        // 根据素材类型创建子目录
        String subDir = switch (material.getMaterialType()) {
            case "IMAGE" -> "images";
            case "VIDEO" -> "videos";
            case "AUDIO" -> "audios";
            default -> "others";
        };
        
        // 确保文件名唯一性
        String fileName = material.getMid() + "_" + material.getMaterialName();
        
        return Paths.get(tempDir, subDir, fileName).toString();
    }
    
    /**
     * 打包节目文件
     */
    private PackageResult packageProgramFiles(String programId, VsnGenerationResult vsnResult, 
                                             MaterialCollectionResult materialResult, PackageOptions options) {
        try {
            // 1. 创建打包目录结构
            String packageDir = createPackageDirectory(programId);
            
            // 2. 写入VSN文件
            String vsnFilePath = Paths.get(packageDir, "program.xml").toString();
            FileUtils.writeStringToFile(vsnFilePath, vsnResult.getXmlContent(), StandardCharsets.UTF_8);
            
            // 3. 复制素材文件到打包目录
            String materialsDir = Paths.get(packageDir, "materials").toString();
            Files.createDirectories(Paths.get(materialsDir));
            
            List<PackagedFile> packagedFiles = new ArrayList<>();
            
            for (CollectedFile collectedFile : materialResult.getCollectedFiles()) {
                String targetPath = Paths.get(materialsDir, 
                    Paths.get(collectedFile.getRelativePath()).getFileName().toString()).toString();
                    
                Files.copy(Paths.get(collectedFile.getTargetPath()), Paths.get(targetPath), 
                    StandardCopyOption.REPLACE_EXISTING);
                    
                packagedFiles.add(PackagedFile.builder()
                    .materialId(collectedFile.getMaterialId())
                    .packagePath(targetPath)
                    .relativePath(collectedFile.getRelativePath())
                    .md5Hash(collectedFile.getMd5Hash())
                    .fileSize(collectedFile.getFileSize())
                    .build());
            }
            
            // 4. 创建压缩包
            String zipFilePath = null;
            if (options.isCreateZipPackage()) {
                zipFilePath = createZipPackage(packageDir, programId);
            }
            
            return PackageResult.builder()
                .success(true)
                .packageDirectory(packageDir)
                .vsnFilePath(vsnFilePath)
                .zipFilePath(zipFilePath)
                .packagedFiles(packagedFiles)
                .packageSize(calculatePackageSize(packageDir))
                .build();
                
        } catch (Exception e) {
            log.error("打包节目文件失败 - 节目ID: {}, 错误: {}", programId, e.getMessage(), e);
            return PackageResult.failure("文件打包异常: " + e.getMessage());
        }
    }
    
    /**
     * 生成部署清单
     */
    private DeploymentManifest generateDeploymentManifest(String programId, VsnGenerationResult vsnResult,
                                                         MaterialCollectionResult materialResult, PackageResult packageResult) {
        Program program = programRepository.findById(Long.valueOf(programId)).get();
        
        return DeploymentManifest.builder()
            .programId(programId)
            .programName(program.getProgramName())
            .version(program.getVersion())
            .canvasWidth(program.getCanvasWidth())
            .canvasHeight(program.getCanvasHeight())
            .deviceType(program.getDeviceType())
            
            // VSN信息
            .vsnFileId(vsnResult.getVsnFileId())
            .vsnFilePath("program.xml")
            .vsnVersion(vsnResult.getVsnVersion())
            
            // 素材信息
            .materialFiles(packageResult.getPackagedFiles().stream()
                .map(pf -> ManifestMaterialFile.builder()
                    .materialId(pf.getMaterialId())
                    .fileName(Paths.get(pf.getRelativePath()).getFileName().toString())
                    .relativePath(pf.getRelativePath())
                    .md5Hash(pf.getMd5Hash())
                    .fileSize(pf.getFileSize())
                    .build())
                .collect(Collectors.toList()))
                
            // 包信息
            .packageSize(packageResult.getPackageSize())
            .packageCreatedAt(LocalDateTime.now())
            .minPlayerVersion(program.getMinPlayerVersion())
            
            .build();
    }
    
    /**
     * 创建ZIP压缩包
     */
    private String createZipPackage(String packageDir, String programId) throws IOException {
        String zipFileName = String.format("program_%s_%d.zip", programId, System.currentTimeMillis());
        String zipFilePath = Paths.get(packageDir).getParent().resolve(zipFileName).toString();
        
        try (ZipOutputStream zipOut = new ZipOutputStream(new FileOutputStream(zipFilePath))) {
            Path packagePath = Paths.get(packageDir);
            
            Files.walk(packagePath)
                .filter(path -> !Files.isDirectory(path))
                .forEach(path -> {
                    try {
                        String relativePath = packagePath.relativize(path).toString();
                        ZipEntry zipEntry = new ZipEntry(relativePath.replace('\\', '/'));
                        zipOut.putNextEntry(zipEntry);
                        Files.copy(path, zipOut);
                        zipOut.closeEntry();
                    } catch (IOException e) {
                        throw new RuntimeException("压缩文件失败: " + path.toString(), e);
                    }
                });
        }
        
        return zipFilePath;
    }
}
```

这个节目生成与下发流程设计涵盖了：

1. **完整的保存机制**：实时自动保存 + 手动版本保存
2. **严格的验证流程**：多层次验证确保节目质量
3. **完整的审核流程**：状态机管理 + 权限控制
4. **VSN生成能力**：XML转换 + 兼容性验证
5. **文件打包机制**：素材收集 + 压缩打包
6. **部署清单生成**：完整的部署信息记录

接下来我将完成最后一个任务：制定完整的实施方案文档。