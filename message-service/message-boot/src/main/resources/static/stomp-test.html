<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STOMPæ¶ˆæ¯ä¸­å¿ƒæµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 5px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .status.connected {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status.disconnected {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .message-log {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: monospace;
            font-size: 12px;
        }
        
        .message-item {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #007bff;
            background-color: white;
        }
        
        .timestamp {
            color: #666;
            font-size: 11px;
        }

        .subscription-item {
            background-color: #e9ecef;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .subscription-item button {
            padding: 5px 10px;
            font-size: 12px;
            margin: 0;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ STOMPæ¶ˆæ¯ä¸­å¿ƒæµ‹è¯•é¡µé¢</h1>
    
    <!-- è¿æ¥æ§åˆ¶é¢æ¿ -->
    <div class="container">
        <h2>ğŸ“¡ STOMPè¿æ¥æ§åˆ¶</h2>
        
        <div id="connectionStatus" class="status disconnected">
            çŠ¶æ€: æœªè¿æ¥
        </div>
        
        <div class="form-group">
            <label for="serverUrl">STOMPæœåŠ¡å™¨åœ°å€:</label>
            <input type="text" id="serverUrl" value="ws://localhost:8084/ws" placeholder="STOMP WebSocketç«¯ç‚¹">
        </div>
        
        <div class="form-group">
            <label for="userId">ç”¨æˆ·ID:</label>
            <input type="text" id="userId" value="123" placeholder="è¾“å…¥ç”¨æˆ·ID">
        </div>
        
        <div class="form-group">
            <label for="orgId">ç»„ç»‡ID:</label>
            <input type="text" id="orgId" value="456" placeholder="è¾“å…¥ç»„ç»‡ID">
        </div>
        
        <div class="form-group">
            <label for="userType">ç”¨æˆ·ç±»å‹:</label>
            <select id="userType">
                <option value="0">æ™®é€šç”¨æˆ·</option>
                <option value="1">ç®¡ç†å‘˜</option>
            </select>
        </div>
        
        <button id="connectBtn" onclick="connectStomp()">è¿æ¥STOMP</button>
        <button id="disconnectBtn" onclick="disconnectStomp()" disabled>æ–­å¼€è¿æ¥</button>
        <button onclick="sendPing()">å‘é€å¿ƒè·³</button>
    </div>
    
    <!-- è®¢é˜…ç®¡ç† -->
    <div class="container">
        <h2>ğŸ“¬ ä¸»é¢˜è®¢é˜…ç®¡ç†</h2>
        
        <div class="form-group">
            <label for="customTopic">è‡ªå®šä¹‰è®¢é˜…ä¸»é¢˜:</label>
            <input type="text" id="customTopic" placeholder="ä¾‹å¦‚: /topic/terminal/123/status">
        </div>
        
        <button onclick="subscribeToTopic()">è®¢é˜…ä¸»é¢˜</button>
        <button onclick="unsubscribeFromTopic()">å–æ¶ˆè®¢é˜…</button>
        <button onclick="subscribeToTerminal()">è®¢é˜…ç»ˆç«¯çŠ¶æ€</button>
        
        <h3>ğŸ“‹ å½“å‰è®¢é˜…åˆ—è¡¨:</h3>
        <div id="subscriptionList">
            <div style="color: #666; font-style: italic;">æš‚æ— è®¢é˜…</div>
        </div>
    </div>
    
    <!-- æ¶ˆæ¯å‘é€é¢æ¿ -->
    <div class="container">
        <h2>ğŸ“¤ STOMPæ¶ˆæ¯å‘é€æµ‹è¯•</h2>
        
        <div class="form-group">
            <label for="messageDestination">æ¶ˆæ¯ç›®çš„åœ°:</label>
            <select id="messageDestination">
                <option value="/app/user/message">ç”¨æˆ·æ¶ˆæ¯</option>
                <option value="/app/system/ping">ç³»ç»Ÿå¿ƒè·³</option>
                <option value="/app/terminal/command/123">ç»ˆç«¯æŒ‡ä»¤</option>
                <option value="/app/terminal/subscribe/123">è®¢é˜…ç»ˆç«¯</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="messageContent">æ¶ˆæ¯å†…å®¹:</label>
            <textarea id="messageContent" rows="4" placeholder='ä¾‹å¦‚: {"command": "start", "parameters": "test"}'>{
  "content": "è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯",
  "type": "test"
}</textarea>
        </div>
        
        <button onclick="sendStompMessage()">å‘é€STOMPæ¶ˆæ¯</button>
        <button onclick="sendTerminalCommand()">å‘é€ç»ˆç«¯æŒ‡ä»¤</button>
        <button onclick="sendUserMessage()">å‘é€ç”¨æˆ·æ¶ˆæ¯</button>
    </div>
    
    <!-- æ¶ˆæ¯æ¥æ”¶æ—¥å¿— -->
    <div class="container">
        <h2>ğŸ“¥ æ¶ˆæ¯æ¥æ”¶æ—¥å¿—</h2>
        <button onclick="clearMessages()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="messageLog" class="message-log">
            <div class="message-item">
                <div class="timestamp">[ç­‰å¾…è¿æ¥...]</div>
                <div>STOMPè¿æ¥å»ºç«‹åï¼Œæ¥æ”¶åˆ°çš„æ¶ˆæ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥STOMP.jsåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    
    <script>
        // STOMPå®¢æˆ·ç«¯å¯¹è±¡
        let stompClient = null;
        let isConnected = false;
        let subscriptions = new Map(); // å­˜å‚¨è®¢é˜…å¯¹è±¡
        
        /**
         * å»ºç«‹STOMPè¿æ¥
         */
        function connectStomp() {
            const serverUrl = document.getElementById('serverUrl').value;
            const userId = document.getElementById('userId').value;
            const orgId = document.getElementById('orgId').value;
            const userType = document.getElementById('userType').value;
            
            if (!serverUrl || !userId || !orgId) {
                alert('è¯·å¡«å†™æœåŠ¡å™¨åœ°å€ã€ç”¨æˆ·IDå’Œç»„ç»‡ID');
                return;
            }
            
            logMessage('ç³»ç»Ÿ', `æ­£åœ¨è¿æ¥åˆ°STOMPæœåŠ¡å™¨: ${serverUrl}`);
            
            try {
                // åˆ›å»ºSTOMPå®¢æˆ·ç«¯
                stompClient = new StompJs.Client({
                    brokerURL: serverUrl,
                    connectHeaders: {
                        // æ¨¡æ‹ŸGatewayä¼ é€’çš„CLOUD-AUTHå¤´
                        'CLOUD-AUTH': btoa(JSON.stringify({
                            uid: parseInt(userId),
                            oid: parseInt(orgId),
                            ugid: 100,
                            userType: parseInt(userType)
                        }))
                    },
                    debug: function (str) {
                        logMessage('STOMPè°ƒè¯•', str);
                    },
                    reconnectDelay: 5000,
                    heartbeatIncoming: 4000,
                    heartbeatOutgoing: 4000
                });
                
                // è¿æ¥æˆåŠŸå›è°ƒ
                stompClient.onConnect = function (frame) {
                    isConnected = true;
                    updateConnectionStatus(true);
                    logMessage('ç³»ç»Ÿ', 'âœ… STOMPè¿æ¥å·²å»ºç«‹');
                    logMessage('ç³»ç»Ÿ', `ä¼šè¯ID: ${frame.headers.session}`);
                    
                    // å¯ç”¨/ç¦ç”¨æŒ‰é’®
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    
                    // è®¢é˜…ç³»ç»Ÿé˜Ÿåˆ—æ¥æ”¶è‡ªåŠ¨è®¢é˜…æ¶ˆæ¯å’Œæ¬¢è¿æ¶ˆæ¯
                    subscribeToSystemQueues();
                };
                
                // è¿æ¥é”™è¯¯å›è°ƒ
                stompClient.onStompError = function (frame) {
                    logMessage('ç³»ç»Ÿ', `âŒ STOMPé”™è¯¯: ${frame.headers.message}`);
                    logMessage('ç³»ç»Ÿ', `é”™è¯¯è¯¦æƒ…: ${frame.body}`);
                };
                
                // æ–­å¼€è¿æ¥å›è°ƒ
                stompClient.onDisconnect = function () {
                    isConnected = false;
                    updateConnectionStatus(false);
                    logMessage('ç³»ç»Ÿ', 'âŒ STOMPè¿æ¥å·²æ–­å¼€');
                    
                    // å¯ç”¨/ç¦ç”¨æŒ‰é’®
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    
                    // æ¸…ç©ºè®¢é˜…åˆ—è¡¨
                    subscriptions.clear();
                    updateSubscriptionList();
                };
                
                // æ¿€æ´»è¿æ¥
                stompClient.activate();
                
            } catch (error) {
                logMessage('ç³»ç»Ÿ', `âŒ åˆ›å»ºSTOMPå®¢æˆ·ç«¯å¤±è´¥: ${error}`);
            }
        }
        
        /**
         * æ–­å¼€STOMPè¿æ¥
         */
        function disconnectStomp() {
            if (stompClient && isConnected) {
                stompClient.deactivate();
                logMessage('ç³»ç»Ÿ', 'ğŸ”Œ ä¸»åŠ¨æ–­å¼€STOMPè¿æ¥');
            }
        }
        
        /**
         * è®¢é˜…ç³»ç»Ÿé˜Ÿåˆ—
         */
        function subscribeToSystemQueues() {
            // è®¢é˜…è‡ªåŠ¨è®¢é˜…å»ºè®®é˜Ÿåˆ—
            const autoSubSubscription = stompClient.subscribe('/user/queue/auto-subscribe', function (message) {
                const data = JSON.parse(message.body);
                logMessage('è‡ªåŠ¨è®¢é˜…', `ğŸ’¡ ç³»ç»Ÿå»ºè®®è®¢é˜…: ${data.topic} - ${data.description}`);
                
                // è‡ªåŠ¨è®¢é˜…æ¨èçš„ä¸»é¢˜
                autoSubscribeToTopic(data.topic);
            });
            subscriptions.set('/user/queue/auto-subscribe', autoSubSubscription);
            
            // è®¢é˜…æ¬¢è¿æ¶ˆæ¯é˜Ÿåˆ—
            const welcomeSubscription = stompClient.subscribe('/user/queue/welcome', function (message) {
                const data = JSON.parse(message.body);
                logMessage('æ¬¢è¿æ¶ˆæ¯', `ğŸ‰ ${data.title}: ${data.content}`);
            });
            subscriptions.set('/user/queue/welcome', welcomeSubscription);
            
            // è®¢é˜…é”™è¯¯æ¶ˆæ¯é˜Ÿåˆ—
            const errorSubscription = stompClient.subscribe('/user/queue/error', function (message) {
                const data = JSON.parse(message.body);
                logMessage('é”™è¯¯', `âŒ ${data.error}`);
            });
            subscriptions.set('/user/queue/error', errorSubscription);
            
            // è®¢é˜…å¿ƒè·³å“åº”é˜Ÿåˆ—
            const pongSubscription = stompClient.subscribe('/user/queue/pong', function (message) {
                const data = JSON.parse(message.body);
                const latency = Date.now() - data.clientTimestamp;
                logMessage('å¿ƒè·³', `ğŸ’“ å¿ƒè·³å“åº” - å»¶è¿Ÿ: ${latency}ms`);
            });
            subscriptions.set('/user/queue/pong', pongSubscription);
            
            // è®¢é˜…æ¶ˆæ¯å¤„ç†ç»“æœé˜Ÿåˆ—
            const messageResultSubscription = stompClient.subscribe('/user/queue/message-result', function (message) {
                const data = JSON.parse(message.body);
                logMessage('æ¶ˆæ¯ç»“æœ', `ğŸ“¨ ${data.message} (${data.success ? 'æˆåŠŸ' : 'å¤±è´¥'})`);
            });
            subscriptions.set('/user/queue/message-result', messageResultSubscription);
            
            updateSubscriptionList();
        }
        
        /**
         * è‡ªåŠ¨è®¢é˜…ä¸»é¢˜
         */
        function autoSubscribeToTopic(topic) {
            if (!subscriptions.has(topic)) {
                const subscription = stompClient.subscribe(topic, function (message) {
                    const data = JSON.parse(message.body);
                    logMessage(`ä¸»é¢˜: ${topic}`, `ğŸ“¬ ${JSON.stringify(data, null, 2)}`);
                });
                subscriptions.set(topic, subscription);
                logMessage('è®¢é˜…', `ğŸ”” è‡ªåŠ¨è®¢é˜…ä¸»é¢˜: ${topic}`);
                updateSubscriptionList();
            }
        }
        
        /**
         * è®¢é˜…è‡ªå®šä¹‰ä¸»é¢˜
         */
        function subscribeToTopic() {
            const topic = document.getElementById('customTopic').value.trim();
            if (!topic) {
                alert('è¯·è¾“å…¥è¦è®¢é˜…çš„ä¸»é¢˜');
                return;
            }
            
            if (!isConnected) {
                alert('è¯·å…ˆå»ºç«‹STOMPè¿æ¥');
                return;
            }
            
            if (subscriptions.has(topic)) {
                alert('è¯¥ä¸»é¢˜å·²ç»è®¢é˜…');
                return;
            }
            
            try {
                const subscription = stompClient.subscribe(topic, function (message) {
                    const data = JSON.parse(message.body);
                    logMessage(`ä¸»é¢˜: ${topic}`, `ğŸ“¬ ${JSON.stringify(data, null, 2)}`);
                });
                
                subscriptions.set(topic, subscription);
                logMessage('è®¢é˜…', `ğŸ”” è®¢é˜…ä¸»é¢˜: ${topic}`);
                updateSubscriptionList();
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('customTopic').value = '';
                
            } catch (error) {
                logMessage('è®¢é˜…', `âŒ è®¢é˜…å¤±è´¥: ${error}`);
            }
        }
        
        /**
         * å–æ¶ˆè®¢é˜…ä¸»é¢˜
         */
        function unsubscribeFromTopic() {
            const topic = document.getElementById('customTopic').value.trim();
            if (!topic) {
                alert('è¯·è¾“å…¥è¦å–æ¶ˆè®¢é˜…çš„ä¸»é¢˜');
                return;
            }
            
            if (subscriptions.has(topic)) {
                subscriptions.get(topic).unsubscribe();
                subscriptions.delete(topic);
                logMessage('å–æ¶ˆè®¢é˜…', `ğŸ”• å–æ¶ˆè®¢é˜…ä¸»é¢˜: ${topic}`);
                updateSubscriptionList();
            } else {
                alert('è¯¥ä¸»é¢˜æœªè®¢é˜…');
            }
        }
        
        /**
         * è®¢é˜…ç»ˆç«¯çŠ¶æ€
         */
        function subscribeToTerminal() {
            const terminalId = prompt('è¯·è¾“å…¥ç»ˆç«¯ID:', '123');
            if (terminalId) {
                const topic = `/topic/terminal/${terminalId}/status`;
                document.getElementById('customTopic').value = topic;
                subscribeToTopic();
            }
        }
        
        /**
         * å‘é€STOMPæ¶ˆæ¯
         */
        function sendStompMessage() {
            if (!isConnected) {
                alert('è¯·å…ˆå»ºç«‹STOMPè¿æ¥');
                return;
            }
            
            const destination = document.getElementById('messageDestination').value;
            const content = document.getElementById('messageContent').value;
            
            try {
                const messageData = JSON.parse(content);
                stompClient.publish({
                    destination: destination,
                    body: JSON.stringify(messageData)
                });
                
                logMessage('å‘é€', `ğŸ“¤ å‘é€åˆ° ${destination}: ${content}`);
                
            } catch (error) {
                logMessage('å‘é€', `âŒ å‘é€æ¶ˆæ¯å¤±è´¥: ${error}`);
            }
        }
        
        /**
         * å‘é€å¿ƒè·³æ¶ˆæ¯
         */
        function sendPing() {
            if (!isConnected) {
                alert('è¯·å…ˆå»ºç«‹STOMPè¿æ¥');
                return;
            }
            
            const pingMessage = {
                timestamp: Date.now()
            };
            
            stompClient.publish({
                destination: '/app/system/ping',
                body: JSON.stringify(pingMessage)
            });
            
            logMessage('å‘é€', 'ğŸ’“ å‘é€å¿ƒè·³æ¶ˆæ¯');
        }
        
        /**
         * å‘é€ç»ˆç«¯æŒ‡ä»¤
         */
        function sendTerminalCommand() {
            const terminalId = prompt('è¯·è¾“å…¥ç»ˆç«¯ID:', '123');
            const command = prompt('è¯·è¾“å…¥æŒ‡ä»¤:', 'start');
            
            if (terminalId && command) {
                const commandMessage = {
                    command: command,
                    parameters: 'test-params'
                };
                
                stompClient.publish({
                    destination: `/app/terminal/command/${terminalId}`,
                    body: JSON.stringify(commandMessage)
                });
                
                logMessage('å‘é€', `ğŸ® å‘é€ç»ˆç«¯æŒ‡ä»¤åˆ° ${terminalId}: ${command}`);
                
                // è‡ªåŠ¨è®¢é˜…æŒ‡ä»¤ç»“æœä¸»é¢˜
                const resultTopic = `/topic/terminal/${terminalId}/command-result`;
                if (!subscriptions.has(resultTopic)) {
                    document.getElementById('customTopic').value = resultTopic;
                    subscribeToTopic();
                }
            }
        }
        
        /**
         * å‘é€ç”¨æˆ·æ¶ˆæ¯
         */
        function sendUserMessage() {
            const content = document.getElementById('messageContent').value;
            
            try {
                const messageData = JSON.parse(content);
                stompClient.publish({
                    destination: '/app/user/message',
                    body: JSON.stringify(messageData)
                });
                
                logMessage('å‘é€', `ğŸ‘¤ å‘é€ç”¨æˆ·æ¶ˆæ¯: ${content}`);
                
            } catch (error) {
                logMessage('å‘é€', `âŒ å‘é€ç”¨æˆ·æ¶ˆæ¯å¤±è´¥: ${error}`);
            }
        }
        
        /**
         * æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
         */
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.className = 'status connected';
                statusElement.textContent = 'çŠ¶æ€: STOMPå·²è¿æ¥ âœ…';
            } else {
                statusElement.className = 'status disconnected';
                statusElement.textContent = 'çŠ¶æ€: æœªè¿æ¥ âŒ';
            }
        }
        
        /**
         * æ›´æ–°è®¢é˜…åˆ—è¡¨æ˜¾ç¤º
         */
        function updateSubscriptionList() {
            const listElement = document.getElementById('subscriptionList');
            
            if (subscriptions.size === 0) {
                listElement.innerHTML = '<div style="color: #666; font-style: italic;">æš‚æ— è®¢é˜…</div>';
                return;
            }
            
            let html = '';
            subscriptions.forEach((subscription, topic) => {
                html += `
                    <div class="subscription-item">
                        <span>ğŸ“¬ ${topic}</span>
                        <button onclick="unsubscribeSpecific('${topic}')">å–æ¶ˆè®¢é˜…</button>
                    </div>
                `;
            });
            
            listElement.innerHTML = html;
        }
        
        /**
         * å–æ¶ˆè®¢é˜…ç‰¹å®šä¸»é¢˜
         */
        function unsubscribeSpecific(topic) {
            if (subscriptions.has(topic)) {
                subscriptions.get(topic).unsubscribe();
                subscriptions.delete(topic);
                logMessage('å–æ¶ˆè®¢é˜…', `ğŸ”• å–æ¶ˆè®¢é˜…ä¸»é¢˜: ${topic}`);
                updateSubscriptionList();
            }
        }
        
        /**
         * è®°å½•æ¶ˆæ¯åˆ°æ—¥å¿—
         */
        function logMessage(source, content, data = null) {
            const messageLog = document.getElementById('messageLog');
            const messageItem = document.createElement('div');
            messageItem.className = 'message-item';
            
            const timestamp = new Date().toLocaleTimeString();
            const dataStr = data ? `\næ•°æ®: ${JSON.stringify(data, null, 2)}` : '';
            
            messageItem.innerHTML = `
                <div class="timestamp">[${timestamp}] ${source}</div>
                <div>${content}${dataStr}</div>
            `;
            
            messageLog.appendChild(messageItem);
            messageLog.scrollTop = messageLog.scrollHeight;
        }
        
        /**
         * æ¸…ç©ºæ¶ˆæ¯æ—¥å¿—
         */
        function clearMessages() {
            const firstMessage = document.getElementById('messageLog').firstElementChild;
            document.getElementById('messageLog').innerHTML = '';
            if (firstMessage) {
                document.getElementById('messageLog').appendChild(firstMessage);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('ç³»ç»Ÿ', 'ğŸ“‹ STOMPæµ‹è¯•é¡µé¢å·²åŠ è½½');
            logMessage('ç³»ç»Ÿ', 'ğŸ’¡ è¯·å¡«å†™è¿æ¥ä¿¡æ¯å¹¶ç‚¹å‡»"è¿æ¥STOMP"å¼€å§‹æµ‹è¯•');
            logMessage('ç³»ç»Ÿ', 'ğŸ”§ æœ¬é¡µé¢å°†æ¨¡æ‹ŸGatewayçš„CLOUD-AUTHå¤´è¿›è¡Œè®¤è¯');
        });
        
        // é¡µé¢å…³é—­å‰æ¸…ç†è¿æ¥
        window.addEventListener('beforeunload', function() {
            if (stompClient && isConnected) {
                stompClient.deactivate();
            }
        });
    </script>
</body>
</html>