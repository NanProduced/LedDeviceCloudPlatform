<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>WebSocket调试工具</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 6px; 
            font-weight: bold;
        }
        .connected { 
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .disconnected { 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .connecting { 
            background-color: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7;
        }
        .log { 
            height: 400px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 15px; 
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .input-group {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .input-group label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
        }
        .input-group input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-left: 10px;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .step {
            padding: 8px;
            margin: 5px 0;
            border-left: 4px solid #007bff;
            background: white;
            padding-left: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 WebSocket连接调试工具</h1>
        
        <div id="status" class="status disconnected">状态: 未连接</div>
        
        <!-- 连接配置 -->
        <div class="test-section">
            <h3>📡 连接配置</h3>
            <div class="input-group">
                <label>服务器地址:</label>
                <input type="text" id="serverHost" value="localhost:8084">
            </div>
            <div class="input-group">
                <label>端点路径:</label>
                <input type="text" id="endpoint" value="/ws">
            </div>
            <div class="input-group">
                <label>用户ID:</label>
                <input type="text" id="userId" value="debug-user-001">
            </div>
            <div class="input-group">
                <label>组织ID:</label>
                <input type="text" id="orgId" value="debug-org-001">
            </div>
            <div class="input-group">
                <label>令牌:</label>
                <input type="text" id="token" value="debug-token-123">
            </div>
        </div>
        
        <!-- 连接测试 -->
        <div class="test-section">
            <h3>🚀 连接测试</h3>
            <button class="btn-info" onclick="testServerHealth()">检查服务器健康状态</button>
            <button class="btn-primary" onclick="connectWebSocket()">原生WebSocket连接</button>
            <button class="btn-primary" onclick="connectSockJS()">SockJS连接</button>
            <button class="btn-danger" onclick="disconnectWebSocket()">断开连接</button>
        </div>
        
        <!-- 消息测试 -->
        <div class="test-section">
            <h3>📨 消息测试</h3>
            <button class="btn-success" onclick="sendPing()">发送Ping</button>
            <button class="btn-success" onclick="sendTestMessage()">发送测试消息</button>
            <button class="btn-success" onclick="sendStatusUpdate()">发送状态更新</button>
        </div>
        
        <!-- 调试步骤 -->
        <div class="test-section">
            <h3>🛠️ 调试步骤</h3>
            <div class="step">1. 点击"检查服务器健康状态"确认服务是否启动</div>
            <div class="step">2. 查看浏览器开发者工具的Network和Console标签</div>
            <div class="step">3. 尝试"原生WebSocket连接"，观察是否能建立连接</div>
            <div class="step">4. 如果原生WebSocket失败，尝试"SockJS连接"</div>
            <div class="step">5. 连接成功后，测试发送不同类型的消息</div>
            <div class="step">6. 检查服务器日志中是否有afterConnectionEstablished被调用</div>
        </div>
        
        <!-- 操作按钮 -->
        <button class="btn-secondary" onclick="clearLog()">清空日志</button>
        <button class="btn-secondary" onclick="toggleAutoScroll()">切换自动滚动</button>
        
        <h3>📋 连接日志:</h3>
        <div id="log" class="log"></div>
    </div>

    <!-- 引入SockJS客户端库 -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    
    <script>
        let socket = null;
        let isConnected = false;
        let connectionType = 'none';
        let autoScroll = true;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': 'ℹ️',
                'success': '✅', 
                'error': '❌',
                'warning': '⚠️',
                'debug': '🔍'
            };
            
            const color = {
                'info': '#17a2b8',
                'success': '#28a745',
                'error': '#dc3545', 
                'warning': '#ffc107',
                'debug': '#6c757d'
            };
            
            logDiv.innerHTML += `<div style="color: ${color[type]}; margin: 2px 0;">
                [${timestamp}] ${typeIcon[type]} ${message}
            </div>`;
            
            if (autoScroll) {
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }
        
        function updateStatus(connected, connecting = false) {
            const statusDiv = document.getElementById('status');
            if (connecting) {
                statusDiv.className = 'status connecting';
                statusDiv.innerHTML = '状态: 连接中... 🔄';
            } else if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.innerHTML = `状态: 已连接 ✅ (${connectionType})`;
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.innerHTML = '状态: 未连接 ❌';
            }
        }
        
        function getWebSocketUrl() {
            const host = document.getElementById('serverHost').value;
            const endpoint = document.getElementById('endpoint').value;
            const userId = document.getElementById('userId').value;
            const orgId = document.getElementById('orgId').value;
            const token = document.getElementById('token').value;
            
            return `ws://${host}${endpoint}?userId=${encodeURIComponent(userId)}&orgId=${encodeURIComponent(orgId)}&token=${encodeURIComponent(token)}`;
        }
        
        function getSockJSUrl() {
            const host = document.getElementById('serverHost').value;
            const endpoint = document.getElementById('endpoint').value;
            const userId = document.getElementById('userId').value;
            const orgId = document.getElementById('orgId').value;
            const token = document.getElementById('token').value;
            
            return `http://${host}${endpoint}?userId=${encodeURIComponent(userId)}&orgId=${encodeURIComponent(orgId)}&token=${encodeURIComponent(token)}`;
        }
        
        function testServerHealth() {
            const host = document.getElementById('serverHost').value;
            
            // 尝试多个健康检查端点
            const healthUrls = [
                `http://${host}/actuator/health`,
                `http://${host}/api/health`,
                `http://${host}/api/health/websocket`
            ];
            
            log(`🔍 检查服务器健康状态...`, 'debug');
            
            // 依次尝试各个端点
            Promise.allSettled(healthUrls.map(url => 
                fetch(url).then(response => {
                    if (response.ok) {
                        return response.json().then(data => ({ url, data }));
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                })
            )).then(results => {
                let hasSuccess = false;
                
                results.forEach((result, index) => {
                    const url = healthUrls[index];
                    if (result.status === 'fulfilled') {
                        hasSuccess = true;
                        log(`✅ 健康检查成功: ${url}`, 'success');
                        log(`📊 响应数据: ${JSON.stringify(result.value.data, null, 2)}`, 'info');
                    } else {
                        log(`❌ 健康检查失败: ${url} - ${result.reason.message}`, 'error');
                    }
                });
                
                if (!hasSuccess) {
                    log(`💡 所有健康检查端点都失败，请确认服务是否在端口8084运行`, 'warning');
                    log(`🔧 尝试手动访问: http://${host}/actuator/health`, 'info');
                }
            });
        }
        
        function connectWebSocket() {
            if (socket && isConnected) {
                log('⚠️ 已存在连接，请先断开', 'warning');
                return;
            }
            
            const wsUrl = getWebSocketUrl();
            log(`🚀 尝试原生WebSocket连接: ${wsUrl}`, 'info');
            updateStatus(false, true);
            connectionType = 'WebSocket';
            
            try {
                socket = new WebSocket(wsUrl);
                
                socket.onopen = function(event) {
                    isConnected = true;
                    updateStatus(true);
                    log('🎉 WebSocket连接成功建立！', 'success');
                    log(`📡 连接详情: readyState=${socket.readyState}, protocol="${socket.protocol}"`, 'debug');
                };
                
                socket.onmessage = function(event) {
                    log(`📨 收到服务器消息: ${event.data}`, 'success');
                    try {
                        const msg = JSON.parse(event.data);
                        log(`📋 解析消息: ${JSON.stringify(msg, null, 2)}`, 'debug');
                    } catch (e) {
                        log(`📋 消息内容 (非JSON): ${event.data}`, 'debug');
                    }
                };
                
                socket.onclose = function(event) {
                    isConnected = false;
                    updateStatus(false);
                    const reason = event.reason || '未知原因';
                    log(`🔌 连接关闭 - 代码: ${event.code}, 原因: ${reason}, 是否干净关闭: ${event.wasClean}`, 'error');
                    
                    // 提供常见错误代码的解释
                    const errorExplanations = {
                        1000: '正常关闭',
                        1001: '端点离开',
                        1002: '协议错误',
                        1003: '不支持的数据类型',
                        1005: '未收到状态码',
                        1006: '连接异常关闭（可能是网络问题或CORS问题）',
                        1007: '数据格式错误',
                        1008: '策略违规',
                        1009: '消息过大',
                        1010: '扩展协商失败',
                        1011: '服务器错误'
                    };
                    
                    if (errorExplanations[event.code]) {
                        log(`💡 错误说明: ${errorExplanations[event.code]}`, 'info');
                    }
                };
                
                socket.onerror = function(error) {
                    log(`💥 WebSocket错误: ${error}`, 'error');
                    console.error('WebSocket详细错误:', error);
                    updateStatus(false);
                };
                
            } catch (error) {
                log(`💥 创建WebSocket连接失败: ${error.message}`, 'error');
                console.error('创建WebSocket异常:', error);
                updateStatus(false);
            }
        }
        
        function connectSockJS() {
            if (socket && isConnected) {
                log('⚠️ 已存在连接，请先断开', 'warning');
                return;
            }
            
            const sockjsUrl = getSockJSUrl();
            log(`🚀 尝试SockJS连接: ${sockjsUrl}`, 'info');
            updateStatus(false, true);
            connectionType = 'SockJS';
            
            try {
                socket = new SockJS(sockjsUrl);
                
                socket.onopen = function(event) {
                    isConnected = true;
                    updateStatus(true);
                    log('🎉 SockJS连接成功建立！', 'success');
                    log(`📡 SockJS协议: ${socket.protocol}, 传输方式: ${socket._transport}`, 'debug');
                };
                
                socket.onmessage = function(event) {
                    log(`📨 收到服务器消息: ${event.data}`, 'success');
                    try {
                        const msg = JSON.parse(event.data);
                        log(`📋 解析消息: ${JSON.stringify(msg, null, 2)}`, 'debug');
                    } catch (e) {
                        log(`📋 消息内容 (非JSON): ${event.data}`, 'debug');
                    }
                };
                
                socket.onclose = function(event) {
                    isConnected = false;
                    updateStatus(false);
                    const reason = event.reason || '未知原因';
                    log(`🔌 SockJS连接关闭 - 代码: ${event.code}, 原因: ${reason}`, 'error');
                };
                
                socket.onerror = function(error) {
                    log(`💥 SockJS错误: ${error}`, 'error');
                    console.error('SockJS详细错误:', error);
                    updateStatus(false);
                };
                
            } catch (error) {
                log(`💥 创建SockJS连接失败: ${error.message}`, 'error');
                console.error('创建SockJS异常:', error);
                updateStatus(false);
            }
        }
        
        function disconnectWebSocket() {
            if (socket && isConnected) {
                socket.close(1000, '用户主动断开');
                log('🔌 主动断开连接', 'info');
            } else {
                log('⚠️ 当前没有活跃连接', 'warning');
            }
        }
        
        function sendPing() {
            if (!isConnected) {
                log('❌ 请先建立连接', 'error');
                return;
            }
            
            const pingMessage = JSON.stringify({
                type: 'ping',
                timestamp: Date.now(),
                clientId: 'debug-client'
            });
            
            try {
                socket.send(pingMessage);
                log(`📤 发送Ping消息: ${pingMessage}`, 'info');
            } catch (error) {
                log(`❌ 发送Ping失败: ${error.message}`, 'error');
            }
        }
        
        function sendTestMessage() {
            if (!isConnected) {
                log('❌ 请先建立连接', 'error');
                return;
            }
            
            const testMessage = JSON.stringify({
                type: 'test',
                content: '这是一条测试消息',
                timestamp: Date.now(),
                from: 'debug-client'
            });
            
            try {
                socket.send(testMessage);
                log(`📤 发送测试消息: ${testMessage}`, 'info');
            } catch (error) {
                log(`❌ 发送测试消息失败: ${error.message}`, 'error');
            }
        }
        
        function sendStatusUpdate() {
            if (!isConnected) {
                log('❌ 请先建立连接', 'error');
                return;
            }
            
            const statusMessage = JSON.stringify({
                type: 'status',
                status: 'online',
                location: 'debug-location',
                timestamp: Date.now()
            });
            
            try {
                socket.send(statusMessage);
                log(`📤 发送状态更新: ${statusMessage}`, 'info');
            } catch (error) {
                log(`❌ 发送状态更新失败: ${error.message}`, 'error');
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('📋 日志已清空', 'info');
        }
        
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            log(`📜 自动滚动已${autoScroll ? '启用' : '禁用'}`, 'info');
        }
        
        // 页面加载完成后的初始化
        window.onload = function() {
            log('🔧 WebSocket调试工具已加载', 'success');
            log('💡 使用步骤：', 'info');
            log('  1. 点击"检查服务器健康状态"确认服务运行状态', 'info');
            log('  2. 配置连接参数（默认值通常可以直接使用）', 'info');
            log('  3. 点击"原生WebSocket连接"或"SockJS连接"建立连接', 'info');
            log('  4. 连接成功后可以发送各种测试消息', 'info');
            log('  5. 查看浏览器开发者工具获取更多调试信息', 'info');
            log('', 'info');
            log('🛠️ 请打开浏览器开发者工具的Network标签查看连接详情', 'debug');
        };
        
        // 页面卸载时自动断开连接
        window.onbeforeunload = function() {
            if (socket && isConnected) {
                socket.close(1001, '页面关闭');
            }
        };
    </script>
</body>
</html>