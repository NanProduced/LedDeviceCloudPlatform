# 指令确认流程实现说明

## 概述

本文档描述了LED设备云平台中指令确认流程的完整实现，包括设备通过`POST /wp-json/wp/v2/comments`接口确认指令后，向用户推送确认结果的整个流程。

## 系统架构

```
用户发送指令 → Core-Service → Terminal-Service → 设备
                                     ↓
                            指令确认API (/wp-json/wp/v2/comments)
                                     ↓
                              CommandConfirmationMessageService
                                     ↓
                                 RabbitMQ
                                     ↓
                              Message-Service → 用户(STOMP推送)
```

## 技术实现

### 1. 数据模型扩展

#### TerminalCommand 增强
位置：`terminal-service/terminal-api/src/main/java/org/nan/cloud/terminal/api/common/model/TerminalCommand.java`

```java
@Schema(description = "指令发送者名称")  
@JsonProperty("author_name")
private String authorName;

@Schema(description = "发送指令的用户ID")
@JsonProperty("user_id")
private Long userId;
```

**作用**：为指令对象添加用户信息，以便在确认时能够识别需要通知的用户。

### 2. Terminal-Service 端实现

#### CommandConfirmationMessageService
位置：`terminal-service/terminal-application/src/main/java/org/nan/cloud/terminal/application/service/CommandConfirmationMessageService.java`

**核心功能**：
- 构建标准化的指令确认消息格式
- 发送消息到指定的MQ交换机和路由键
- 区分成功和失败两种确认类型

**消息格式**：
```json
{
  "messageType": "COMMAND_RESULT",
  "subject": "指令执行成功/指令被拒绝",
  "payload": {
    "commandId": 123,
    "deviceId": "456",
    "terminalId": 456,
    "orgId": 1,
    "userId": 789,
    "executionStatus": "SUCCESS/REJECTED",
    "executionResult": "Executable comment/拒绝原因",
    "message": "指令执行成功/指令被设备拒绝执行",
    "originalCommand": {
      "content": "指令内容",
      "authorName": "发送者",
      "authorUrl": "操作类型"
    },
    "timestamp": 1640995200000,
    "confirmTime": "2021-12-31T12:00:00"
  },
  "exchange": "stomp.push.topic",
  "routingKey": "stomp.command.result.{orgId}.{tid}"
}
```

#### TerminalCommandManager 修改
位置：`terminal-service/terminal-infrastructure/src/main/java/org/nan/cloud/terminal/cache/TerminalCommandManager.java`

**关键修改**：
- 在`handleCommandExecution()`方法中添加成功消息发送
- 在`handleCommandRejection()`方法中添加失败消息发送
- 从Redis中获取完整的指令信息以提取用户ID

### 3. Message-Service 端优化

#### MqToStompMessageConverter 更新
位置：`message-service/message-infrastructure/src/main/java/org/nan/cloud/message/infrastructure/mq/converter/MqToStompMessageConverter.java`

**主要改进**：
- 更新目标路径为简化的`/user/queue/messages`
- 确保消息正确路由到用户的个人消息队列

## API 接口说明

### POST /wp-json/wp/v2/comments

**请求参数**：
- `post`: Integer - 终端ID（设备不处理此参数）
- `body`: TerminalCommandConfirm - 确认内容

**TerminalCommandConfirm 结构**：
```java
{
  "parent": 123,        // 指令ID
  "content": "string"   // 确认结果："Executable comment"表示成功，其他表示失败原因
}
```

**处理逻辑**：
1. 验证指令是否存在
2. 根据content判断成功或失败
3. 更新指令状态
4. 发送MQ消息到message-service
5. 返回200状态码

## 消息队列配置

### 交换机和路由键
- **交换机**：`stomp.push.topic`
- **路由键**：`stomp.command.result.{orgId}.{tid}`
- **队列**：`stomp.command.result.queue`

### 消息流转
1. Terminal-Service → RabbitMQ (`stomp.push.topic`)
2. RabbitMQ → Message-Service (`stomp.command.result.queue`)
3. Message-Service → 用户 (STOMP `/user/queue/messages`)

## 用户体验流程

### 指令执行成功
1. 用户发送指令到设备
2. 设备收到指令并执行
3. 设备调用确认接口，返回"Executable comment"
4. 用户立即收到STOMP推送消息：
   ```json
   {
     "messageType": "COMMAND_FEEDBACK",
     "message": "设备456指令123执行结果: Executable comment",
     "payload": {
       "executionStatus": "SUCCESS",
       "message": "指令执行成功",
       // ... 其他详细信息
     }
   }
   ```

### 指令被拒绝
1. 用户发送指令到设备
2. 设备收到指令但无法执行
3. 设备调用确认接口，返回拒绝原因
4. 用户立即收到STOMP推送消息：
   ```json
   {
     "messageType": "COMMAND_FEEDBACK",
     "message": "设备456指令123执行结果: 设备忙碌",
     "payload": {
       "executionStatus": "REJECTED",
       "message": "指令被设备拒绝执行",
       "rejectionReason": "设备忙碌",
       // ... 其他详细信息
     }
   }
   ```

## 测试方法

### 1. 模拟指令发送
使用Core-Service的指令发送接口，确保指令包含正确的userId和authorName。

### 2. 模拟设备确认
```bash
# 成功确认
curl -X POST "http://localhost:8085/wp-json/wp/v2/comments?post=123" \
  -H "Content-Type: application/json" \
  -H "Authorization: Basic {base64_credentials}" \
  -d '{
    "parent": 123,
    "content": "Executable comment"
  }'

# 失败确认
curl -X POST "http://localhost:8085/wp-json/wp/v2/comments?post=123" \
  -H "Content-Type: application/json" \
  -H "Authorization: Basic {base64_credentials}" \
  -d '{
    "parent": 123,
    "content": "设备忙碌，无法执行指令"
  }'
```

### 3. 监听STOMP消息
前端连接到Message-Service的STOMP端点，订阅`/user/queue/messages`，观察指令确认消息的接收。

## 错误处理

### 常见错误场景
1. **指令不存在**：返回400错误，不发送MQ消息
2. **用户ID缺失**：记录警告日志，不发送MQ消息
3. **MQ发送失败**：记录错误日志，不影响指令确认的返回
4. **消息转换异常**：Message-Service会使用降级处理逻辑

### 日志监控关键字
- `✅ 指令执行成功消息已发送`
- `✅ 指令拒绝消息已发送`
- `⚠️ 无法发送指令执行成功消息 - 指令信息不完整`
- `❌ 指令执行成功消息发送失败`

## 性能考虑

### 异步处理
- MQ消息发送采用异步方式，不阻塞指令确认响应
- 消息处理失败不影响设备端的正常操作

### 消息TTL
- 指令确认消息TTL设置为5分钟
- 超时未处理的消息将自动过期

### 重试机制
- Common-MQ组件提供自动重试功能
- 最大重试次数：3次
- 重试间隔：指数退避

## 部署注意事项

1. **服务启动顺序**：先启动Message-Service，再启动Terminal-Service
2. **RabbitMQ配置**：确保交换机和队列已正确创建
3. **权限配置**：Terminal-Service需要有MQ Producer权限
4. **监控告警**：建议对MQ消息发送失败率进行监控

## 扩展性设计

### 支持批量指令确认
当前实现支持单个指令确认，未来可扩展为批量确认模式。

### 支持更多确认类型
可以扩展content字段的解析逻辑，支持更丰富的确认状态。

### 支持确认回调
可以为指令添加回调URL，在确认后进行额外的业务处理。

---

通过以上实现，完成了从设备指令确认到用户实时通知的完整闭环，提供了良好的用户体验和系统可靠性。